<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Poker House</title>
    <!-- Critical: Show loading indicator immediately -->
    <style>
        .initial-loader {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #0a0f18;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            color: #fb923c;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .initial-loader.loaded { display: none; }
        .loader-spinner {
            width: 50px; height: 50px;
            border: 4px solid #1a2332;
            border-top-color: #fb923c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-text { margin-top: 20px; font-size: 18px; }
    </style>
    <script>
        // Load Telegram SDK with timeout fallback
        var tgScriptLoaded = false;
        var tgScript = document.createElement('script');
        tgScript.src = 'https://telegram.org/js/telegram-web-app.js';
        tgScript.onload = function() { tgScriptLoaded = true; };
        tgScript.onerror = function() { console.log('TG SDK failed to load'); };
        document.head.appendChild(tgScript);
        
        // Fallback: continue without SDK after 3 seconds
        setTimeout(function() {
            if (!tgScriptLoaded) {
                console.log('TG SDK timeout - continuing without it');
            }
        }, 3000);
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* ═══════════════════════════════════════════════════
           SAFE AREA INSETS FOR NOTCH/STATUS BAR
           ═══════════════════════════════════════════════════ */
        :root {
            /* Safe area CSS variables with fallbacks */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
            
            /* Minimum header offset (for devices without notch) */
            --header-offset: max(var(--safe-top), 10px);
            
            /* App colors - unified purple theme */
            --app-bg: #1a0f2e;
            --app-bg-dark: #0f0a1a;
            --app-bg-light: #2d1f4e;
        }
        
        body {
            background: radial-gradient(ellipse at top, #1a2332 0%, #0a0f18 50%, #050810 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            /* Add safe area padding */
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            padding-left: var(--safe-left);
            padding-right: var(--safe-right);
        }
        
        /* Safe area spacer for top of screens */
        .safe-area-top {
            height: var(--safe-top);
            min-height: var(--safe-top);
            background: var(--app-bg);
            width: 100%;
            flex-shrink: 0;
        }

        .hidden { display: none !important; }

        /* ═══════════════════════════════════════════════════
           NEON THEME STYLES
           ═══════════════════════════════════════════════════ */
        
        /* Neon Theme - Main Menu Background */
        body.neon-theme #mainMenu {
            background: linear-gradient(180deg, #0f0a1a 0%, #1a0f2e 50%, #0d0618 100%);
        }

        /* Neon Theme - Profile Card */
        body.neon-theme .menu-profile-card {
            background: linear-gradient(135deg, #1a0f2e 0%, #0f0a1a 100%);
            border-bottom: 1px solid rgba(168, 85, 247, 0.3);
        }

        body.neon-theme .menu-avatar {
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            border: 3px solid rgba(168, 85, 247, 0.6);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.5), 0 0 40px rgba(168, 85, 247, 0.3);
        }

        body.neon-theme .menu-player-name {
            color: #f0abfc;
            text-shadow: 0 0 10px rgba(240, 171, 252, 0.5);
        }

        body.neon-theme .menu-balance {
            color: #fbbf24;
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.6), 0 0 30px rgba(251, 191, 36, 0.3);
        }

        /* Neon Theme - Action Buttons */
        body.neon-theme .menu-action-btn.deposit {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.5), 0 4px 16px rgba(34, 197, 94, 0.3);
        }

        body.neon-theme .menu-action-btn.withdraw,
        body.neon-theme .menu-action-btn.history,
        body.neon-theme .menu-action-btn.settings {
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid rgba(168, 85, 247, 0.4);
            color: #e9d5ff;
        }

        body.neon-theme .menu-action-btn.withdraw:active,
        body.neon-theme .menu-action-btn.history:active,
        body.neon-theme .menu-action-btn.settings:active {
            background: rgba(168, 85, 247, 0.3);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
        }

        /* Neon Theme - Game Mode Tabs */
        body.neon-theme .game-mode-tab {
            background: rgba(168, 85, 247, 0.1);
            border: 2px solid rgba(168, 85, 247, 0.3);
        }

        body.neon-theme .game-mode-tab .tab-title {
            color: #c4b5fd;
        }

        body.neon-theme .game-mode-tab .tab-icon {
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.6));
        }

        body.neon-theme .game-mode-tab.active {
            background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
            border-color: #a855f7;
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.6), 0 6px 20px rgba(147, 51, 234, 0.4);
        }

        body.neon-theme .game-mode-tab.active .tab-title {
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* Neon Theme - Private Game Button */
        body.neon-theme .private-game-btn {
            background: linear-gradient(135deg, #ec4899 0%, #d946ef 100%);
            border: 2px solid rgba(236, 72, 153, 0.6);
            box-shadow: 0 0 25px rgba(236, 72, 153, 0.5), 0 6px 20px rgba(217, 70, 239, 0.4);
        }

        body.neon-theme .private-game-btn .private-text {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* Neon Theme - Play Button */
        body.neon-theme .play-btn {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #0f0a1a;
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.6), 0 6px 24px rgba(245, 158, 11, 0.4);
        }

        body.neon-theme .play-btn:active {
            box-shadow: 0 0 35px rgba(251, 191, 36, 0.8), 0 4px 16px rgba(245, 158, 11, 0.5);
        }

        /* Neon Theme - Game Mode Description */
        body.neon-theme .game-mode-desc {
            color: #a78bfa;
        }

        /* Neon Theme - Stats */
        body.neon-theme .menu-stat-value {
            color: #c084fc;
            text-shadow: 0 0 10px rgba(192, 132, 252, 0.5);
        }

        /* Neon Theme - Settings Modal */
        body.neon-theme .settings-modal {
            background: rgba(15, 10, 26, 0.95);
        }

        body.neon-theme .settings-content {
            background: linear-gradient(145deg, #1a0f2e, #0f0a1a);
            border: 2px solid rgba(168, 85, 247, 0.4);
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.3), 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        body.neon-theme .settings-title {
            color: #c084fc;
            text-shadow: 0 0 15px rgba(192, 132, 252, 0.5);
        }

        body.neon-theme .settings-close {
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
        }

        body.neon-theme .settings-close:hover {
            background: rgba(236, 72, 153, 0.4);
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.5);
        }

        body.neon-theme .settings-section-title {
            color: #a78bfa;
            text-shadow: 0 0 8px rgba(167, 139, 250, 0.4);
        }

        body.neon-theme .setting-item {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        body.neon-theme .setting-name {
            color: #f0abfc;
        }

        body.neon-theme .setting-desc {
            color: #a78bfa;
        }

        body.neon-theme .toggle-switch {
            background: rgba(168, 85, 247, 0.3);
        }

        body.neon-theme .toggle-switch.active {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
        }

        /* Neon Theme - History Modal */
        body.neon-theme .history-modal {
            background: rgba(15, 10, 26, 0.98);
        }

        body.neon-theme .history-header {
            background: linear-gradient(145deg, #1a0f2e, #0f0a1a);
            border-bottom: 1px solid rgba(251, 191, 36, 0.3);
        }

        body.neon-theme .history-title {
            color: #fbbf24;
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        }

        body.neon-theme .history-close {
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
        }

        body.neon-theme .history-stats {
            background: rgba(15, 10, 26, 0.9);
        }

        body.neon-theme .history-stat {
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        body.neon-theme .history-stat-value {
            text-shadow: 0 0 10px currentColor;
        }

        body.neon-theme .history-item {
            background: linear-gradient(145deg, #1a0f2e, #0f0a1a);
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        body.neon-theme .history-item.win {
            border-left: 4px solid #22c55e;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.2);
        }

        body.neon-theme .history-item.loss {
            border-left: 4px solid #ec4899;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.2);
        }

        /* Neon Theme - Private Game Modal */
        body.neon-theme .private-game-modal {
            background: rgba(15, 10, 26, 0.95);
        }

        body.neon-theme .private-game-content {
            background: linear-gradient(145deg, #1a0f2e, #0f0a1a);
            border: 2px solid rgba(168, 85, 247, 0.4);
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.3);
        }

        body.neon-theme .pg-header-title {
            color: #fbbf24;
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        }

        body.neon-theme .pg-close {
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
        }

        body.neon-theme .pg-tab {
            background: rgba(168, 85, 247, 0.15);
            border: 2px solid rgba(168, 85, 247, 0.3);
            color: #c4b5fd;
        }

        body.neon-theme .pg-tab.active {
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            border-color: #a855f7;
            color: #fff;
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
        }

        body.neon-theme .pg-label {
            color: #a78bfa;
        }

        body.neon-theme .pg-select {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            color: #f0abfc;
        }

        body.neon-theme .pg-input {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            color: #f0abfc;
        }

        body.neon-theme .create-btn {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        body.neon-theme .join-btn {
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
        }

        body.neon-theme .start-game-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        body.neon-theme .lobby-code-display {
            color: #fbbf24;
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
        }

        body.neon-theme .invite-btn.telegram {
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            box-shadow: 0 0 15px rgba(147, 51, 234, 0.4);
        }

        body.neon-theme .invite-btn.copy {
            background: rgba(168, 85, 247, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.4);
            color: #c4b5fd;
        }

        /* Neon Theme - Waiting Room */
        body.neon-theme #waitingRoomScreen {
            background: linear-gradient(180deg, #0f0a1a 0%, #1a0f2e 100%);
        }

        body.neon-theme .waiting-room-header {
            background: linear-gradient(145deg, #1a0f2e, #0f0a1a);
            border-bottom: 1px solid rgba(168, 85, 247, 0.3);
        }

        body.neon-theme .waiting-room-title {
            color: #fbbf24;
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        }

        body.neon-theme .waiting-code-value {
            color: #fbbf24;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.6);
        }

        body.neon-theme .waiting-room-info {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        body.neon-theme .waiting-player-item {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        body.neon-theme .waiting-player-name {
            color: #f0abfc;
        }

        body.neon-theme .waiting-invite-btn {
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            box-shadow: 0 0 15px rgba(147, 51, 234, 0.4);
        }

        body.neon-theme .waiting-start-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        /* ═══════ NEON THEME - POKER TABLE ═══════ */
        body.neon-theme #pokerTableScreen {
            background: linear-gradient(180deg, #0f0a1a 0%, #1a0f2e 50%, #0d0618 100%);
        }

        /* Decorative background elements */
        body.neon-theme #pokerTableScreen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 50% 0%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 20% 80%, rgba(212, 175, 55, 0.08) 0%, transparent 40%),
                radial-gradient(ellipse 60% 40% at 80% 80%, rgba(212, 175, 55, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 10% 20%, rgba(168, 85, 247, 0.1) 0%, transparent 25%),
                radial-gradient(circle at 90% 30%, rgba(232, 121, 249, 0.08) 0%, transparent 20%);
            pointer-events: none;
            z-index: 0;
        }

        /* Subtle animated glow lines */
        body.neon-theme #pokerTableScreen::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 120%;
            transform: translate(-50%, -50%);
            background: 
                conic-gradient(from 0deg at 50% 50%, 
                    transparent 0deg, 
                    rgba(168, 85, 247, 0.03) 60deg, 
                    transparent 120deg,
                    rgba(212, 175, 55, 0.02) 180deg,
                    transparent 240deg,
                    rgba(168, 85, 247, 0.03) 300deg,
                    transparent 360deg);
            pointer-events: none;
            z-index: 0;
            animation: rotateAmbient 30s linear infinite;
        }

        @keyframes rotateAmbient {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        body.neon-theme .poker-header {
            background: rgba(15, 10, 26, 0.85);
            border-bottom: 1px solid rgba(168, 85, 247, 0.4);
            box-shadow: 0 2px 20px rgba(168, 85, 247, 0.2);
        }

        body.neon-theme .table-back-btn {
            background: rgba(168, 85, 247, 0.3);
            border-color: rgba(168, 85, 247, 0.5);
        }

        body.neon-theme .table-info-blinds {
            color: #a855f7;
            text-shadow: 0 0 8px rgba(168, 85, 247, 0.6);
        }

        /* Poker Table - Purple with GOLD border */
        body.neon-theme .poker-table {
            background: radial-gradient(ellipse at center, #2d1f4e 0%, #1a0f2e 60%, #0d0618 100%);
            border: 5px solid #d4af37;
            box-shadow:
                0 12px 35px rgba(0, 0, 0, 0.5),
                0 0 25px rgba(212, 175, 55, 0.5),
                0 0 50px rgba(212, 175, 55, 0.25),
                0 0 80px rgba(168, 85, 247, 0.2),
                inset 0 0 40px rgba(168, 85, 247, 0.15);
        }

        body.neon-theme .table-felt {
            border: 2px solid rgba(212, 175, 55, 0.25);
        }

        /* Pot Display - Gold accent */
        body.neon-theme .pot-center {
            background: linear-gradient(135deg, rgba(15, 10, 26, 0.95), rgba(26, 15, 46, 0.9)) !important;
            border: 2px solid #d4af37 !important;
            box-shadow: 
                0 0 15px rgba(212, 175, 55, 0.4),
                0 0 30px rgba(168, 85, 247, 0.2),
                inset 0 0 10px rgba(212, 175, 55, 0.1) !important;
        }

        body.neon-theme .pot-label {
            color: #d4af37;
            text-shadow: 0 0 6px rgba(212, 175, 55, 0.5);
        }

        body.neon-theme .pot-amount {
            color: #fbbf24;
            text-shadow: 0 0 12px rgba(251, 191, 36, 0.7);
            font-weight: 800;
        }

        /* Player Cards Container - Gold trim */
        body.neon-theme .player-card-container {
            background: linear-gradient(135deg, rgba(26, 15, 46, 0.95), rgba(15, 10, 26, 0.9));
            border: 2px solid rgba(212, 175, 55, 0.4);
            box-shadow: 
                0 3px 15px rgba(168, 85, 247, 0.3),
                0 0 8px rgba(212, 175, 55, 0.2);
        }

        body.neon-theme .player-avatar {
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            border: 3px solid #d4af37;
            box-shadow: 
                0 0 12px rgba(212, 175, 55, 0.5),
                0 0 20px rgba(168, 85, 247, 0.4);
        }

        body.neon-theme .player-avatar.active {
            border-color: #fbbf24;
            box-shadow: 
                0 0 20px rgba(251, 191, 36, 0.8),
                0 0 35px rgba(168, 85, 247, 0.5);
            animation: activePlayerGlow 1.5s ease-in-out infinite;
        }

        @keyframes activePlayerGlow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.6), 0 0 35px rgba(168, 85, 247, 0.4);
            }
            50% { 
                box-shadow: 0 0 30px rgba(251, 191, 36, 0.9), 0 0 50px rgba(168, 85, 247, 0.6);
            }
        }

        body.neon-theme .player-chips {
            color: #fbbf24;
            text-shadow: 0 0 8px rgba(251, 191, 36, 0.6);
        }

        body.neon-theme .table-player.current-turn {
            box-shadow: 0 0 25px 5px rgba(251, 191, 36, 0.7);
        }

        body.neon-theme .table-player .player-bet {
            color: #fbbf24;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        body.neon-theme .table-player .card-back {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            border: 1px solid #d4af37;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
        }

        /* Phase Indicator */
        body.neon-theme .phase-indicator {
            background: rgba(168, 85, 247, 0.2);
            color: #e879f9;
            border-color: rgba(168, 85, 247, 0.5);
            text-shadow: 0 0 8px rgba(232, 121, 249, 0.5);
        }

        body.neon-theme .game-phase-indicator {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.95), rgba(124, 58, 237, 0.95));
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.7) !important;
        }

        /* Action Buttons - Neon Style */
        body.neon-theme .action-btn.fold {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.6);
        }

        body.neon-theme .action-btn.call,
        body.neon-theme .action-btn.check {
            background: linear-gradient(135deg, #22c55e, #15803d);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.6);
        }

        body.neon-theme .action-btn.raise {
            background: linear-gradient(135deg, #f59e0b, #b45309);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.6);
        }

        body.neon-theme .action-btn.allin {
            background: linear-gradient(135deg, #ec4899, #be185d);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.7);
        }

        /* Hero Cards - Gold Border */
        body.neon-theme .hero-card {
            border: 3px solid #d4af37;
            box-shadow: 
                0 6px 20px rgba(212, 175, 55, 0.5),
                0 0 15px rgba(168, 85, 247, 0.4),
                inset 0 0 15px rgba(255, 255, 255, 0.1);
        }

        body.neon-theme .hero-card.combo-card {
            border-color: #fbbf24 !important;
            box-shadow: 
                0 0 25px rgba(251, 191, 36, 1),
                0 0 50px rgba(251, 191, 36, 0.6),
                0 0 80px rgba(168, 85, 247, 0.3) !important;
            animation: heroCardGoldenPulse 2s ease-in-out infinite;
        }

        @keyframes heroCardGoldenPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.8), 0 0 40px rgba(251, 191, 36, 0.4);
            }
            50% {
                box-shadow: 0 0 35px rgba(251, 191, 36, 1), 0 0 70px rgba(251, 191, 36, 0.6);
            }
        }

        /* Community Cards - Purple with Gold highlight */
        body.neon-theme .community-card {
            border: 2px solid rgba(168, 85, 247, 0.6);
            box-shadow: 
                0 4px 14px rgba(168, 85, 247, 0.4),
                0 0 10px rgba(168, 85, 247, 0.2);
        }

        body.neon-theme .community-card.combo-card,
        body.neon-theme .community-card.golden-highlight {
            border-color: #fbbf24 !important;
            box-shadow: 
                0 0 20px rgba(251, 191, 36, 0.9),
                0 0 40px rgba(251, 191, 36, 0.5),
                0 0 60px rgba(168, 85, 247, 0.2) !important;
        }

        /* Winner Overlay - Neon with Gold */
        body.neon-theme .winner-content-me {
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 50%, #6d28d9 100%);
            border: 4px solid #d4af37;
            box-shadow: 
                0 0 40px rgba(212, 175, 55, 0.6),
                0 0 80px rgba(168, 85, 247, 0.5),
                0 0 120px rgba(168, 85, 247, 0.3);
        }

        body.neon-theme .winner-title {
            color: #fbbf24;
            text-shadow: 
                0 0 20px rgba(251, 191, 36, 0.9),
                0 0 40px rgba(251, 191, 36, 0.5),
                2px 2px 0 #7c3aed;
        }

        body.neon-theme .winner-amount {
            color: #fbbf24;
            text-shadow: 0 0 20px rgba(251, 191, 36, 1);
        }

        body.neon-theme .winner-hand-name {
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        body.neon-theme .winner-content-other {
            background: linear-gradient(135deg, #1a0f2e 0%, #0d0618 100%);
            border: 2px solid #d4af37;
            box-shadow: 
                0 0 20px rgba(212, 175, 55, 0.3),
                0 0 40px rgba(168, 85, 247, 0.3);
        }
        
        /* ═══════ SCREEN TRANSITION ANIMATIONS ═══════ */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 1;
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        
        .screen.fade-out {
            opacity: 0;
            transform: scale(0.95);
        }
        
        .screen.fade-in {
            animation: screenFadeIn 0.4s ease forwards;
        }
        
        @keyframes screenFadeIn {
            from {
                opacity: 0;
                transform: scale(1.05);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes screenSlideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes screenSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-30px);
            }
        }

        /* ═══════════════════════════════════════════════════
           SPLASH SCREEN STYLES
           ═══════════════════════════════════════════════════ */
        #splashScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            background: radial-gradient(ellipse at center, #1a2840 0%, #0d1520 40%, #050810 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .splash-bg-glow {
            position: absolute;
            width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(251,146,60,0.15) 0%, transparent 70%);
            border-radius: 50%;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        .splash-title {
            font-size: 32px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 30px;
            opacity: 0;
            transform: translateY(-30px);
            animation: fadeInDown 0.6s ease-out 0.3s forwards;
        }

        .splash-cowboy {
            font-size: 80px;
            margin-bottom: 24px;
            transform: scale(0);
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.1s forwards;
        }

        .splash-wave {
            display: inline-block;
            animation: wave 1s ease-in-out infinite;
            transform-origin: 70% 70%;
        }

        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(20deg); }
            75% { transform: rotate(-10deg); }
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes fadeInDown {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        /* ═══════ SCREEN TRANSITION ANIMATIONS ═══════ */
        .screen-transition {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        
        .screen-fade-in {
            animation: screenFadeIn 0.4s ease-out forwards;
        }
        
        .screen-fade-out {
            animation: screenFadeOut 0.3s ease-out forwards;
        }
        
        .screen-slide-in {
            animation: screenSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        .screen-slide-out {
            animation: screenSlideOut 0.3s ease-in forwards;
        }
        
        @keyframes screenFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes screenFadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        
        @keyframes screenSlideIn {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes screenSlideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-30px); }
        }

        .splash-phrase {
            font-size: 18px;
            color: #94a3b8;
            text-align: center;
            padding: 0 30px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease-out 0.8s forwards;
        }

        /* ═══════════════════════════════════════════════════
           FULLSCREEN REQUEST SCREEN
           ═══════════════════════════════════════════════════ */
        #fullscreenRequestScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .fullscreen-request-container {
            text-align: center;
            padding: 40px 30px;
            max-width: 400px;
        }

        .fullscreen-icon {
            font-size: 72px;
            margin-bottom: 24px;
            animation: scale-pulse 2s ease-in-out infinite;
        }

        @keyframes scale-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .fullscreen-title {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin-bottom: 16px;
            letter-spacing: 0.5px;
        }

        .fullscreen-description {
            font-size: 15px;
            color: #94a3b8;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .btn-enable-fullscreen {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
            transition: all 0.3s;
        }

        .btn-enable-fullscreen:active {
            transform: scale(0.98);
        }

        .btn-skip-fullscreen {
            width: 100%;
            padding: 12px 24px;
            background: transparent;
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 12px;
            color: #94a3b8;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* ═══════════════════════════════════════════════════
           MAIN MENU STYLES
           ═══════════════════════════════════════════════════ */
        #mainMenu {
            min-height: 100vh;
            padding: 0;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #0a0f18 0%, #0d1520 100%);
        }

        /* Profile Card - with safe area padding */
        .menu-profile-card {
            background: linear-gradient(135deg, #111827 0%, #0a0f18 100%);
            border-bottom: 1px solid #1e293b;
            /* Add safe area to top padding */
            padding: calc(var(--safe-top) + 16px) 16px 24px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .menu-avatar {
            width: 72px; height: 72px;
            border-radius: 16px;
            background: linear-gradient(135deg, #fb923c, #f97316);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            color: #fefce8;
            border: 3px solid #fed7aa;
            margin-bottom: 12px;
        }

        .menu-player-name {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .menu-balance-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 2px;
        }

        .menu-balance {
            font-size: 28px;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 16px;
        }

        /* Action buttons row */
        .menu-actions {
            display: flex;
            gap: 8px;
            width: 100%;
            max-width: 360px;
        }

        .menu-action-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 12px 6px;
            border-radius: 12px;
            border: none;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
        }

        .menu-action-btn .icon {
            font-size: 20px;
        }

        .menu-action-btn.deposit {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: #fff;
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
        }

        .menu-action-btn.withdraw {
            background: #1e293b;
            color: #e5e7eb;
            border: 1px solid #334155;
        }

        .menu-action-btn.history {
            background: #1e293b;
            color: #e5e7eb;
            border: 1px solid #334155;
        }

        .menu-action-btn.settings {
            background: #1e293b;
            color: #e5e7eb;
            border: 1px solid #334155;
        }

        .menu-action-btn:active {
            transform: scale(0.95);
        }

        /* Stats row */
        .menu-stats {
            display: flex;
            gap: 32px;
            margin-top: 16px;
        }

        .menu-stat {
            text-align: center;
        }

        .menu-stat-value {
            font-size: 22px;
            font-weight: 700;
            color: #3b82f6;
        }

        .menu-stat-label {
            font-size: 11px;
            color: #64748b;
        }

        /* Game Mode Tabs */
        .game-mode-tabs {
            display: flex;
            gap: 10px;
            padding: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .game-mode-tab {
            flex: 1;
            min-width: 90px;
            padding: 16px 10px;
            border-radius: 16px;
            border: 2px solid #334155;
            background: #1e293b;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .game-mode-tab .tab-icon {
            font-size: 28px;
        }

        .game-mode-tab .tab-title {
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            white-space: nowrap;
        }

        .game-mode-tab.active {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border-color: #3b82f6;
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .game-mode-tab.active .tab-title {
            color: #fff;
        }

        .game-mode-tab:active {
            transform: scale(0.97);
        }

        /* Private Game Button */
        .private-game-section {
            padding: 0 16px;
            margin-bottom: 12px;
        }

        .private-game-btn {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: 2px solid #fbbf24;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }

        .private-game-btn:active {
            transform: scale(0.98);
        }

        .private-game-btn .private-icon {
            font-size: 28px;
        }

        .private-game-btn .private-text {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
        }

        .private-game-btn .private-desc {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Game Mode Description */
        .game-mode-desc {
            text-align: center;
            padding: 0 16px 16px;
            font-size: 14px;
            color: #64748b;
        }

        /* Play Button - with safe area, closer to Private Game */
        .play-section {
            padding: 0 16px calc(var(--safe-bottom) + 16px);
            margin-top: 16px;
        }

        .play-btn {
            width: 100%;
            padding: 18px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: #fff;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 24px rgba(34, 197, 94, 0.4);
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .play-btn:active {
            transform: scale(0.98);
        }

        /* ═══════════════════════════════════════════════════
           LOBBY SCREEN STYLES
           ═══════════════════════════════════════════════════ */
        #lobbyScreen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .lobby-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #0a0f18;
            border-bottom: 1px solid #1e293b;
        }

        .back-btn {
            width: 40px; height: 40px;
            border-radius: 12px;
            border: none;
            background: #1e293b;
            color: #e5e7eb;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .back-btn:active {
            background: #334155;
        }

        .lobby-title {
            font-size: 18px;
            font-weight: 600;
            color: #e5e7eb;
        }

        .lobby-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .lobby-content {
                flex-direction: row;
            }
            .lobby-tables { flex: 1; }
            .lobby-sidebar { width: 280px; }
        }

        .lobby-tables {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .lobby-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .lobby-tab {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            background: #1e293b;
            color: #94a3b8;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.15s, color 0.15s;
        }

        .lobby-tab.active {
            background: #3b82f6;
            color: #fff;
        }

        .table-card {
            background: linear-gradient(135deg, #111827 0%, #0a0f18 100%);
            border: 1px solid #1e293b;
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .table-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .table-name {
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }

        .table-status {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            background: #22c55e20;
            color: #22c55e;
        }

        .table-status.waiting { background: #f59e0b20; color: #f59e0b; }
        .table-status.full { background: #ef444420; color: #ef4444; }

        .table-info {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 12px;
            color: #94a3b8;
        }

        .table-info span { display: flex; align-items: center; gap: 4px; }

        .join-btn {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .join-btn:active { opacity: 0.9; }

        /* Lobby Sidebar */
        .lobby-sidebar {
            background: #0b1220;
            border-top: 1px solid #1e293b;
            padding: 16px;
        }

        @media (min-width: 768px) {
            .lobby-sidebar {
                border-top: none;
                border-left: 1px solid #1e293b;
            }
        }

        .sidebar-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-bottom: 16px;
            border-bottom: 1px solid #1e293b;
            margin-bottom: 16px;
        }

        .sidebar-avatar {
            width: 64px; height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fb923c, #f97316);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: #fefce8;
            border: 3px solid #fed7aa;
            margin-bottom: 10px;
        }

        .sidebar-name {
            font-size: 16px;
            font-weight: 600;
            color: #e5e7eb;
        }

        .sidebar-handle {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .sidebar-balance {
            font-size: 24px;
            font-weight: 700;
            color: #4ade80;
        }

        .sidebar-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .sidebar-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            height: 44px;
            padding: 0 14px;
            border-radius: 12px;
            border: none;
            background: #1e293b;
            color: #e5e7eb;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .sidebar-btn:active { background: #334155; }

        .sidebar-btn.primary {
            background: linear-gradient(135deg, #eab308, #facc15);
            color: #111827;
        }

        .sidebar-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #e5e7eb;
        }

        .stat-value.green { color: #22c55e; }

        .stat-label {
            font-size: 11px;
            color: #64748b;
        }

        /* Debug */
        .debug {
            position: fixed;
            bottom: 6px;
            left: 6px;
            right: 6px;
            font-size: 9px;
            color: #475569;
            text-align: center;
            pointer-events: none;
        }

        /* ═══════════════════════════════════════════════════
           POKER TABLE - PORTRAIT LAYOUT (VERTICAL)
           ═══════════════════════════════════════════════════ */
        #pokerTableScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(180deg, #1a0f2e 0%, #0f0a1a 50%, #0d0618 100%);
            overflow: hidden;
        }

        /* ═══════ TOP HEADER BAR - BELOW TELEGRAM CLOSE BUTTON ═══════ */
        .poker-header {
            position: fixed;
            /* 50px offset to place BELOW Telegram "Закрыть" button */
            top: calc(var(--safe-top) + 50px); 
            left: var(--safe-left); 
            right: var(--safe-right);
            height: 40px;
            background: rgba(26, 15, 46, 0.95);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            padding: 0 12px;
            z-index: 100;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        /* Safe area background fill above header - purple gradient */
        .poker-header::before {
            content: '';
            position: absolute;
            top: calc(-1 * (var(--safe-top) + 50px));
            left: 0;
            right: 0;
            height: calc(var(--safe-top) + 50px);
            background: linear-gradient(180deg, var(--app-bg) 0%, rgba(26, 15, 46, 0.95) 100%);
        }

        .table-back-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
        }

        .table-info {
            text-align: center;
            padding: 0 6px;
        }

        .table-info-name {
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
        }

        .table-info-blinds {
            font-size: 9px;
            color: #22c55e;
            letter-spacing: 0.5px;
        }

        .header-spacer {
            width: 50px;
        }

        /* ═══════ FULLSCREEN MODE ═══════ */
        html:-webkit-full-screen,
        html:-moz-full-screen,
        html:fullscreen {
            width: 100%;
            height: 100%;
        }
        body:-webkit-full-screen,
        body:-moz-full-screen,
        body:fullscreen {
            margin: 0;
            padding: 0;
        }

        /* ═══════ POKER TABLE - TALLER VERTICAL OVAL ═══════ */
        .poker-table-container {
            position: absolute;
            /* Account for: safe area + TG close button (50px) + our header (40px) */
            top: calc(var(--safe-top) + 95px);
            left: 0;
            right: 0;
            bottom: calc(var(--safe-bottom) + 140px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            z-index: 1 !important; /* LOW - players will be above */
        }

        .poker-table {
            position: relative;
            width: 54vw;
            height: 56vh;
            max-width: 250px;
            max-height: 480px;
            background: radial-gradient(ellipse at center, #2d5a2d 0%, #1a3a1a 60%, #0f2810 100%);
            border: 4px solid #d4af37;
            border-radius: 48% / 42%;
            box-shadow:
                0 12px 35px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(212, 175, 55, 0.3),
                inset 0 0 35px rgba(0, 0, 0, 0.3);
            /* NO transform - prevents stacking context issues */
            z-index: 1 !important; /* BASE LAYER - lowest */
            overflow: visible; /* Allow players to extend beyond table */
        }

        .table-felt {
            position: absolute;
            top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 2px solid rgba(255,255,255,0.08);
            border-radius: 48% / 42%;
        }

        /* ═══════ POT DISPLAY - BETWEEN PLAYER AND CARDS ═══════ */
        .pot-center {
            position: absolute !important;
            top: 28% !important;
            left: 50% !important;
            transform: translateX(-50%) scale(0.9) !important;
            background: rgba(0,0,0,0.85) !important;
            padding: 5px 14px !important;
            border-radius: 16px !important;
            border: 2px solid #fbbf24 !important;
            box-shadow: 0 3px 12px rgba(0,0,0,0.6) !important;
            z-index: 25 !important;
            text-align: center;
        }

        .pot-label {
            font-size: 7px !important;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .pot-amount {
            font-size: 15px !important;
            font-weight: 700;
            color: #fbbf24;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* ═══════ PLAYER SEATS - DYNAMIC ═══════ */
        #playerSeats {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 30;
            pointer-events: none;
        }
        
        .table-player {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 8px;
            min-width: 80px;
            pointer-events: auto;
        }
        
        .table-player .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }
        
        .table-player .player-name {
            font-size: 11px;
            color: white;
            font-weight: 600;
            max-width: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .table-player .player-chips {
            font-size: 10px;
            color: #fbbf24;
            font-weight: 500;
        }
        
        .table-player.folded {
            opacity: 0.5;
        }
        
        /* Player positions around the table - Adaptive layout */
        .table-player.position-top {
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .table-player.position-top-left {
            top: 30px;
            left: -15px;
        }
        
        .table-player.position-top-right {
            top: 30px;
            right: -15px;
        }
        
        .table-player.position-left {
            top: 40%;
            left: -20px;
            transform: translateY(-50%);
        }
        
        .table-player.position-right {
            top: 40%;
            right: -20px;
            transform: translateY(-50%);
        }
        
        .table-player.position-bottom-left {
            bottom: 80px;
            left: -15px;
        }
        
        .table-player.position-bottom-right {
            bottom: 80px;
            right: -15px;
        }
        
        /* Current turn indicator */
        .table-player.current-turn {
            box-shadow: 0 0 15px 3px #22c55e;
        }
        
        /* Player bet display */
        .table-player .player-bet {
            font-size: 10px;
            color: #fbbf24;
            font-weight: 600;
            background: rgba(251, 191, 36, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 3px;
        }
        
        /* Card back styling */
        .table-player .player-cards-back {
            display: flex;
            gap: 2px;
            margin-top: 5px;
        }
        
        .table-player .card-back {
            width: 24px;
            height: 34px;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            border-radius: 3px;
            border: 1px solid #60a5fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Showdown - revealed cards for opponents */
        .table-player .player-cards-shown {
            display: flex;
            gap: 2px;
            margin-top: 5px;
        }
        
        .table-player .mini-card {
            width: 26px;
            height: 36px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 4px;
            border: 1px solid #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .table-player .mini-card.red { color: #dc2626; }
        .table-player .mini-card.black { color: #1f2937; }
        
        .table-player .player-hand-name {
            font-size: 9px;
            color: #fbbf24;
            font-weight: 600;
            text-align: center;
            margin-top: 3px;
            background: rgba(0,0,0,0.5);
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }

        /* ═══════ COMMUNITY CARDS - CENTER (LARGER) ═══════ */
        .community-cards {
            position: absolute;
            top: 52% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            display: flex;
            gap: 6px !important;
            z-index: 20 !important;
            padding: 0;
        }

        /* COMMUNITY CARD STYLING */
        .community-card {
            width: 46px !important;
            height: 66px !important;
            background: linear-gradient(145deg, #ffffff, #f0f0f0) !important;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            font-weight: 700;
            box-shadow: 0 4px 14px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.8);
            border: 2px solid #374151;
            opacity: 0;
            animation: communityCardDeal 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        /* Community card slow reveal animation */
        @keyframes communityCardDeal {
            0% {
                opacity: 0;
                transform: translateY(-30px) scale(0.5) rotateY(180deg);
            }
            30% {
                opacity: 0.3;
                transform: translateY(-15px) scale(0.75) rotateY(90deg);
            }
            60% {
                opacity: 0.7;
                transform: translateY(-5px) scale(0.95) rotateY(30deg);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1) rotateY(0deg);
            }
        }
        
        .community-card .card-rank {
            font-size: 18px;
            font-weight: 800;
            line-height: 1;
        }
        
        .community-card .card-suit {
            font-size: 20px;
            line-height: 1;
        }
        
        .community-card.red .card-rank,
        .community-card.red .card-suit {
            color: #dc2626;
        }
        
        .community-card.black .card-rank,
        .community-card.black .card-suit {
            color: #1f2937;
        }
        
        /* Stagger animation for community cards - slower reveal */
        .community-card:nth-child(1) { animation-delay: 0s; }
        .community-card:nth-child(2) { animation-delay: 0.3s; }
        .community-card:nth-child(3) { animation-delay: 0.6s; }
        .community-card:nth-child(4) { animation-delay: 0.9s; }
        .community-card:nth-child(5) { animation-delay: 1.2s; }

        /* CARDS - BIGGER WITH VISIBLE SUITS + ANIMATION */
        .card {
            width: 46px !important;
            height: 66px !important;
            background: #ffffff !important;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: 5px !important;
            font-weight: 700;
            box-shadow: 0 4px 14px rgba(0,0,0,0.5);
            border: 2px solid #374151;
            opacity: 1 !important;
            filter: none !important;
            /* Animation - smooth card deal */
            animation: cardDeal 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
            transition: all 0.4s ease;
        }

        /* Smooth card deal animation */
        @keyframes cardDeal {
            0% {
                opacity: 0;
                transform: translateY(-50px) scale(0.3) rotateX(90deg);
            }
            40% {
                opacity: 0.6;
                transform: translateY(-15px) scale(0.85) rotateX(30deg);
            }
            70% {
                opacity: 0.9;
                transform: translateY(5px) scale(1.02) rotateX(-5deg);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1) rotateX(0deg);
            }
        }

        /* Stagger animation for each card - longer delays for smoother sequence */
        .card:nth-child(1) { animation-delay: 0s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .card:nth-child(3) { animation-delay: 0.4s; }
        .card:nth-child(4) { animation-delay: 0.6s; }
        .card:nth-child(5) { animation-delay: 0.8s; }

        /* GOLDEN SHIMMER HIGHLIGHT for winning combination cards */
        .card.highlighted,
        .card.winning-card,
        .card.combo-card {
            border: 2.5px solid #fbbf24 !important;
            box-shadow: 
                0 0 12px rgba(251, 191, 36, 0.9),
                0 0 25px rgba(251, 191, 36, 0.5),
                0 4px 12px rgba(0,0,0,0.4) !important;
            animation: goldenShimmer 2s ease-in-out infinite;
        }

        /* Smooth pulsing shimmer effect */
        @keyframes goldenShimmer {
            0% {
                box-shadow: 
                    0 0 8px rgba(251, 191, 36, 0.7),
                    0 0 18px rgba(251, 191, 36, 0.3),
                    0 4px 12px rgba(0,0,0,0.4);
                border-color: #f59e0b;
            }
            25% {
                box-shadow: 
                    0 0 15px rgba(251, 191, 36, 1),
                    0 0 35px rgba(251, 191, 36, 0.6),
                    0 4px 12px rgba(0,0,0,0.4);
                border-color: #fbbf24;
            }
            50% {
                box-shadow: 
                    0 0 20px rgba(255, 215, 0, 1),
                    0 0 45px rgba(255, 215, 0, 0.7),
                    0 4px 12px rgba(0,0,0,0.4);
                border-color: #fcd34d;
            }
            75% {
                box-shadow: 
                    0 0 15px rgba(251, 191, 36, 1),
                    0 0 35px rgba(251, 191, 36, 0.6),
                    0 4px 12px rgba(0,0,0,0.4);
                border-color: #fbbf24;
            }
            100% {
                box-shadow: 
                    0 0 8px rgba(251, 191, 36, 0.7),
                    0 0 18px rgba(251, 191, 36, 0.3),
                    0 4px 12px rgba(0,0,0,0.4);
                border-color: #f59e0b;
            }
        }

        /* ═══════ WINNER OVERLAY ANIMATIONS ═══════ */
        .winner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }
        
        .winner-overlay.visible {
            opacity: 1;
        }
        
        .winner-overlay.hiding {
            opacity: 0;
        }
        
        /* Winner content - MY WIN (colorful) */
        .winner-content-me {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
            border: 4px solid #fcd34d;
            border-radius: 24px;
            padding: 30px 50px;
            text-align: center;
            box-shadow: 
                0 0 60px rgba(251, 191, 36, 0.8),
                0 0 120px rgba(251, 191, 36, 0.4),
                0 20px 60px rgba(0, 0, 0, 0.5);
            animation: winnerPulse 0.5s ease-out, winnerFloat 2s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        
        .winner-glow {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            animation: rotateGlow 3s linear infinite;
        }
        
        .winner-confetti {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle, #ff6b6b 2px, transparent 2px),
                radial-gradient(circle, #4ecdc4 2px, transparent 2px),
                radial-gradient(circle, #ffe66d 2px, transparent 2px),
                radial-gradient(circle, #95e1d3 2px, transparent 2px);
            background-size: 40px 40px, 60px 60px, 50px 50px, 70px 70px;
            animation: confettiFall 1s linear infinite;
            opacity: 0.6;
        }
        
        .winner-trophy {
            font-size: 64px;
            animation: trophyBounce 0.6s ease-out;
            position: relative;
            z-index: 1;
        }
        
        .winner-title {
            font-size: 36px;
            font-weight: 900;
            color: #1f2937;
            text-shadow: 2px 2px 0 #fff, -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff;
            margin: 10px 0;
            position: relative;
            z-index: 1;
        }
        
        .winner-hand-name {
            font-size: 20px;
            font-weight: 700;
            color: #422006;
            margin: 5px 0;
            position: relative;
            z-index: 1;
        }
        
        .winner-amount {
            font-size: 32px;
            font-weight: 900;
            color: #166534;
            text-shadow: 1px 1px 0 #fff;
            margin-top: 10px;
            animation: amountPop 0.5s ease-out 0.3s both;
            position: relative;
            z-index: 1;
        }
        
        .winner-sparkles {
            font-size: 24px;
            animation: sparkle 0.8s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }
        
        /* Winner content - OTHER WIN (modest) */
        .winner-content-other {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            border: 2px solid #6b7280;
            border-radius: 16px;
            padding: 20px 40px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: otherWinSlide 0.4s ease-out;
        }
        
        .winner-icon {
            font-size: 40px;
            margin-bottom: 5px;
        }
        
        .winner-other-name {
            font-size: 22px;
            font-weight: 700;
            color: #f3f4f6;
            margin: 5px 0;
        }
        
        .winner-hand-name-small {
            font-size: 14px;
            color: #9ca3af;
            margin: 5px 0;
        }
        
        .winner-amount-small {
            font-size: 20px;
            font-weight: 700;
            color: #fbbf24;
            margin-top: 5px;
        }
        
        @keyframes winnerPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes winnerFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes rotateGlow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes confettiFall {
            0% { background-position: 0 0, 0 0, 0 0, 0 0; }
            100% { background-position: 40px 40px, 60px 60px, 50px 50px, 70px 70px; }
        }
        
        @keyframes trophyBounce {
            0% { transform: scale(0) rotate(-20deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        @keyframes amountPop {
            0% { transform: scale(0); }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        @keyframes otherWinSlide {
            0% { transform: translateY(-30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .card.red { color: #dc2626 !important; }
        .card.black { color: #1f2937 !important; }

        .card-rank { font-size: 20px !important; line-height: 1; font-weight: 800; }
        .card-suit { font-size: 20px !important; line-height: 1; }

        .card.hidden {
            background: linear-gradient(135deg, #1e40af, #1e3a8a) !important;
            color: transparent !important;
            border: 2px solid #3b82f6;
        }

        .card.hidden::after {
            content: '🂠';
            font-size: 22px;
            color: #fff;
        }

        /* ═══════ PLAYER SEATS - ON TOP OF TABLE ═══════ */
        .player-seat {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 50 !important; /* HIGH - above table container */
        }

        /* Seat positions - ON table edges */
        .seat-top { top: -5px !important; left: 50% !important; transform: translateX(-50%) scale(0.85) !important; z-index: 50 !important; }
        .seat-left-upper { top: 18% !important; left: -15px !important; transform: scale(0.85) !important; z-index: 50 !important; }
        .seat-left-lower { bottom: 25% !important; left: -15px !important; transform: scale(0.85) !important; z-index: 50 !important; }
        .seat-bottom { bottom: -5px !important; left: 50% !important; transform: translateX(-50%) scale(0.9) !important; z-index: 50 !important; }
        .seat-right-lower { bottom: 25% !important; right: -15px !important; transform: scale(0.85) !important; z-index: 50 !important; }
        .seat-right-upper { top: 18% !important; right: -15px !important; transform: scale(0.85) !important; z-index: 50 !important; }

        /* Legacy seat classes (for JS compatibility) */
        .seat-0 { bottom: -5px !important; left: 50% !important; transform: translateX(-50%) scale(0.9) !important; z-index: 50 !important; }
        .seat-1 { bottom: 25% !important; left: -15px !important; transform: scale(0.85) !important; z-index: 50 !important; }
        .seat-2 { top: 18% !important; left: -15px !important; transform: scale(0.85) !important; z-index: 50 !important; }
        .seat-3 { top: -5px !important; left: 50% !important; transform: translateX(-50%) scale(0.85) !important; z-index: 50 !important; }
        .seat-4 { top: 18% !important; right: -15px !important; transform: scale(0.85) !important; z-index: 50 !important; }
        .seat-5 { bottom: 25% !important; right: -15px !important; transform: scale(0.85) !important; z-index: 50 !important; }

        .player-card-container {
            background: rgba(30, 41, 59, 0.9);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            padding: 4px 5px;
            min-width: 60px;
            max-width: 72px;
            backdrop-filter: blur(6px);
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
        }

        .player-avatar {
            width: 38px; height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: 2.5px solid rgba(212, 175, 55, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            color: #fff;
            margin: 0 auto 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            position: relative;
        }

        .player-avatar.active {
            border-color: #fbbf24;
            box-shadow: 0 0 20px rgba(251,191,36,0.6);
            animation: activePulse 1.5s infinite;
        }

        @keyframes activePulse {
            0%, 100% { box-shadow: 0 0 20px rgba(251,191,36,0.6); }
            50% { box-shadow: 0 0 30px rgba(251,191,36,0.9); }
        }

        .player-avatar.folded {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .player-name {
            font-size: 9px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 58px;
        }

        .player-chips {
            font-size: 10px;
            font-weight: 700;
            color: #fbbf24;
        }

        .player-cards {
            display: flex;
            gap: 2px;
            margin-top: 3px;
            justify-content: center;
        }

        .player-card {
            width: 18px; height: 26px;
            background: linear-gradient(135deg, #1e40af, #1e3a8a);
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }

        /* ═══════ BOTTOM CONTROLS - NO BLUR (indicators visible) ═══════ */
        .poker-controls-bottom {
            position: fixed !important;
            /* Account for safe area at bottom */
            bottom: calc(var(--safe-bottom) + 10px) !important;
            left: 0 !important;
            right: 0 !important;
            width: 100vw !important;
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            padding: 10px 10px 14px 10px !important;
            z-index: 100 !important;
            border-top: none !important;
            display: flex;
            flex-direction: column;
            gap: 7px;
        }

        /* Hero cards row - NO BACKGROUND */
        .hero-cards {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 0;
            background: transparent !important;
            backdrop-filter: none !important;
            margin: 0 auto;
        }

        /* Hero cards - LARGER with strong shadows */
        .hero-card {
            width: 52px !important;
            height: 72px !important;
            background: #ffffff !important;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 4px 2px;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(59,130,246,0.8), 0 0 0 2px rgba(255,255,255,0.4);
            border: 2.5px solid #3b82f6;
        }

        .hero-card.red { color: #dc2626 !important; }
        .hero-card.black { color: #000000 !important; }

        .hero-card .card-rank { font-size: 22px; line-height: 1; }
        .hero-card .card-suit { font-size: 24px; line-height: 1; }

        /* GOLDEN HIGHLIGHT for combination cards (PAIR and above) */
        .golden-highlight,
        .hero-card.golden-highlight,
        .community-card.golden-highlight {
            border: 3px solid #fbbf24 !important;
            box-shadow: 
                0 0 15px rgba(251, 191, 36, 0.9),
                0 0 30px rgba(251, 191, 36, 0.5),
                0 6px 20px rgba(0,0,0,0.4) !important;
            animation: goldenPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes goldenPulse {
            0%, 100% {
                box-shadow: 
                    0 0 12px rgba(251, 191, 36, 0.8),
                    0 0 25px rgba(251, 191, 36, 0.4),
                    0 6px 20px rgba(0,0,0,0.4);
                border-color: #f59e0b;
            }
            50% {
                box-shadow: 
                    0 0 20px rgba(255, 215, 0, 1),
                    0 0 45px rgba(255, 215, 0, 0.6),
                    0 6px 20px rgba(0,0,0,0.4);
                border-color: #fcd34d;
            }
        }

        /* GOLDEN SHIMMER for hero combo cards */
        .hero-card.combo-card {
            border: 3px solid #fbbf24 !important;
            box-shadow: 
                0 0 15px rgba(251, 191, 36, 0.9),
                0 0 30px rgba(251, 191, 36, 0.5),
                0 6px 20px rgba(0,0,0,0.4) !important;
            animation: heroGoldenShimmer 2s ease-in-out infinite;
        }

        /* Smooth pulsing shimmer for hero cards */
        @keyframes heroGoldenShimmer {
            0% {
                box-shadow: 
                    0 0 10px rgba(251, 191, 36, 0.7),
                    0 0 22px rgba(251, 191, 36, 0.4),
                    0 6px 20px rgba(0,0,0,0.4);
                border-color: #f59e0b;
            }
            25% {
                box-shadow: 
                    0 0 18px rgba(251, 191, 36, 1),
                    0 0 40px rgba(251, 191, 36, 0.6),
                    0 6px 20px rgba(0,0,0,0.4);
                border-color: #fbbf24;
            }
            50% {
                box-shadow: 
                    0 0 25px rgba(255, 215, 0, 1),
                    0 0 55px rgba(255, 215, 0, 0.7),
                    0 6px 20px rgba(0,0,0,0.4);
                border-color: #fcd34d;
            }
            75% {
                box-shadow: 
                    0 0 18px rgba(251, 191, 36, 1),
                    0 0 40px rgba(251, 191, 36, 0.6),
                    0 6px 20px rgba(0,0,0,0.4);
                border-color: #fbbf24;
            }
            100% {
                box-shadow: 
                    0 0 10px rgba(251, 191, 36, 0.7),
                    0 0 22px rgba(251, 191, 36, 0.4),
                    0 6px 20px rgba(0,0,0,0.4);
                border-color: #f59e0b;
            }
        }

        /* Action buttons grid */
        .action-buttons-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            padding: 0;
        }

        .betting-controls.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .phase-indicator {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 12px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
            white-space: nowrap;
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            flex: 1;
        }

        .action-btn {
            height: 44px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.15);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            color: white;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            padding: 0 4px;
            white-space: nowrap;
            box-shadow: 0 4px 14px rgba(0,0,0,0.5);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.fold {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.5);
        }

        .action-btn.call, .action-btn.check {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.5);
        }

        .action-btn.raise {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
        }

        .action-btn.allin {
            background: linear-gradient(135deg, #a855f7, #9333ea);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.5);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ═══════ GAME PHASE INDICATOR - RIGHT SIDE (ABOVE USER CARDS) ═══════ */
        .game-phase-indicator {
            position: fixed !important;
            bottom: 200px !important;
            right: 10px !important;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
            padding: 6px 12px !important;
            border-radius: 8px !important;
            font-size: 10px !important;
            font-weight: 700;
            color: white;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 14px rgba(34, 197, 94, 0.7) !important;
            z-index: 90 !important;
        }

        .game-phase-indicator.flop {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.7) !important;
        }
        .game-phase-indicator.turn {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.95), rgba(245, 158, 11, 0.95));
            box-shadow: 0 4px 14px rgba(251, 191, 36, 0.7) !important;
        }
        .game-phase-indicator.river {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.7) !important;
        }

        /* Bet Slider Row */
        .slider-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .bet-amount-display {
            min-width: 50px;
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            color: #fbbf24;
            text-shadow: 0 2px 6px rgba(0,0,0,0.7), 0 0 8px rgba(251,191,36,0.3);
        }

        .bet-slider {
            flex: 1;
            height: 3px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #22c55e, #fbbf24, #ef4444);
            border-radius: 2px;
            outline: none;
        }

        .bet-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        .quick-bets {
            display: flex;
            gap: 4px;
        }

        .quick-bet-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: #fff;
            border-radius: 5px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .quick-bet-btn:hover, .quick-bet-btn.active {
            background: #4a6bff;
            border-color: #4a6bff;
        }

        /* ═══════ CARD FLIP ANIMATION ═══════ */
        .card-container {
            perspective: 1000px;
            display: inline-block;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .card-inner.flipped {
            transform: rotateY(180deg);
        }

        .card-inner.animating {
            animation: flipReveal 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes flipReveal {
            0% { transform: rotateY(180deg); opacity: 0.8; }
            50% { transform: rotateY(90deg); opacity: 1; }
            100% { transform: rotateY(0deg); opacity: 1; }
        }

        .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .card-face.back {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #1e40af, #1e3a8a);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-face.back::before {
            content: '🎰';
            font-size: 20px;
        }

        .card-face.front {
            background: #fff;
            border-radius: 8px;
        }

        .card.highlighted {
            box-shadow: 0 0 20px 5px rgba(34, 197, 94, 0.8) !important;
            transform: translateY(-5px);
        }

        /* ═══════ HAND STRENGTH HUD - LEFT SIDE (ABOVE USER CARDS) ═══════ */
        .hand-hud {
            position: fixed !important;
            bottom: 200px !important;
            left: 10px !important;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
            border-radius: 8px !important;
            padding: 8px 10px !important;
            display: flex;
            flex-direction: column;
            gap: 2px;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.7) !important;
            backdrop-filter: none !important;
            z-index: 90 !important;
            animation: slideInLeft 0.3s ease-out;
            max-width: 90px;
        }

        .hand-hud.hidden { display: none; }

        @keyframes slideInLeft {
            from { transform: translateX(-80px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .hand-hud-icon { font-size: 14px; text-align: center; }
        .hand-hud-rank {
            font-size: 10px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            text-align: center;
        }
        .hand-hud-desc {
            font-size: 8px;
            color: rgba(255,255,255,0.85);
            text-align: center;
        }

        /* Rarity colors */
        .hand-hud.legendary { background: linear-gradient(135deg, rgba(255,140,0,0.95), rgba(245,158,11,0.95)); }
        .hand-hud.epic { background: linear-gradient(135deg, rgba(168,85,247,0.95), rgba(147,51,234,0.95)); }
        .hand-hud.rare { background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(37,99,235,0.95)); }

        /* ═══════ SHOW/MUCK MODAL ═══════ */
        .showmuck-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 400;
            backdrop-filter: blur(8px);
        }

        .showmuck-modal.hidden { display: none; }

        .showmuck-content {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 2px solid #334155;
            border-radius: 20px;
            padding: 28px;
            max-width: 340px;
            text-align: center;
        }

        .showmuck-content h3 {
            font-size: 22px;
            margin-bottom: 8px;
            color: #fff;
        }

        .showmuck-content p {
            color: #94a3b8;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .showmuck-cards {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .showmuck-buttons {
            display: flex;
            gap: 12px;
        }

        .showmuck-buttons button {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .btn-show {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
        }

        .btn-muck {
            background: linear-gradient(135deg, #64748b, #475569);
            color: #fff;
        }

        .btn-hint {
            font-size: 10px;
            font-weight: 400;
            opacity: 0.8;
        }

        /* Winner Popup */
        .winner-popup {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .winner-badge {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border: 3px solid #fbbf24;
            border-radius: 20px;
            padding: 30px 50px;
            text-align: center;
            box-shadow: 0 0 60px rgba(251,191,36,0.4);
            animation: scaleIn 0.4s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .winner-icon {
            font-size: 60px;
            margin-bottom: 10px;
        }

        .winner-name {
            font-size: 24px;
            font-weight: 700;
            color: #fbbf24;
            margin-bottom: 8px;
        }

        .winner-hand {
            font-size: 18px;
            color: #a3e635;
            margin-bottom: 12px;
        }

        .winner-amount {
            font-size: 28px;
            font-weight: 700;
            color: #4ade80;
        }

        /* Player Timer */
        .player-timer {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #fbbf24;
            color: #000;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Player Bet */
        .player-bet {
            font-size: 10px;
            color: #fbbf24;
            font-weight: 600;
            margin-top: 2px;
        }

        /* Disabled buttons */
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Device-specific styles */
        .device-mobile .poker-table {
            width: 90%;
            max-width: none;
        }

        .device-mobile .action-btn {
            padding: 10px 16px;
            font-size: 13px;
        }

        .device-desktop .poker-table {
            width: 70%;
            max-width: 500px;
        }

        .device-desktop .action-btn {
            padding: 14px 28px;
            font-size: 16px;
        }

        /* ═══════════════════════════════════════════════════
           PRIVATE GAME MODAL STYLES
           ═══════════════════════════════════════════════════ */
        .private-game-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Safe area padding */
            padding: calc(var(--safe-top) + 20px) 20px calc(var(--safe-bottom) + 20px) 20px;
        }

        .private-game-content {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 380px;
            border: 2px solid rgba(251, 191, 36, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .private-game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .private-game-title {
            font-size: 22px;
            font-weight: 700;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .private-game-close {
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: #ef4444;
            font-size: 24px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .private-game-close:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        .private-game-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .pg-tab {
            flex: 1;
            padding: 12px;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid transparent;
            border-radius: 12px;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .pg-tab.active {
            background: rgba(251, 191, 36, 0.15);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .pg-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.2);
        }

        /* Private Game View Animations */
        #createLobbyView,
        #joinLobbyView,
        #lobbyCreatedView {
            animation: fadeInView 0.25s ease forwards;
        }

        #createLobbyView.hidden,
        #joinLobbyView.hidden,
        #lobbyCreatedView.hidden {
            display: none !important;
        }

        @keyframes fadeInView {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal Open/Close Animation */
        .private-game-modal {
            animation: fadeInModal 0.3s ease forwards;
        }

        .private-game-modal.hidden {
            display: none !important;
        }

        @keyframes fadeInModal {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .private-game-content {
            animation: slideInContent 0.3s ease forwards;
        }

        @keyframes slideInContent {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Create Lobby Form */
        .create-lobby-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            color: #94a3b8;
            font-size: 13px;
            font-weight: 600;
        }

        .form-select, .form-input {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 12px 14px;
            color: #fff;
            font-size: 15px;
            outline: none;
            transition: all 0.2s;
        }

        .form-select:focus, .form-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        .form-select option {
            background: #1e293b;
            color: #fff;
        }

        .blinds-row {
            display: flex;
            gap: 10px;
        }

        .blinds-row .form-group {
            flex: 1;
        }

        .create-btn {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: none;
            border-radius: 12px;
            padding: 14px;
            color: #000;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
        }

        /* Join Lobby Form */
        .join-lobby-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .lobby-code-input {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            color: #fff;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            letter-spacing: 8px;
            text-transform: uppercase;
        }

        .join-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 12px;
            padding: 14px;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .join-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        /* Lobby Created Screen */
        .lobby-created {
            text-align: center;
        }

        .lobby-code-display {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
            border: 2px solid #fbbf24;
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }

        .lobby-code-label {
            color: #94a3b8;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .lobby-code-value {
            font-size: 36px;
            font-weight: 800;
            color: #fbbf24;
            letter-spacing: 10px;
        }

        .lobby-settings-summary {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 14px;
            margin: 16px 0;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            color: #94a3b8;
            font-size: 13px;
        }

        .settings-value {
            color: #fff;
            font-size: 13px;
            font-weight: 600;
        }

        .invite-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 16px;
        }

        .invite-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .invite-btn.telegram {
            background: linear-gradient(135deg, #0088cc, #0077b5);
            color: #fff;
        }

        .invite-btn.telegram:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 136, 204, 0.4);
        }

        .invite-btn.copy {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .invite-btn.copy:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .start-game-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            border-radius: 12px;
            padding: 14px;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .start-game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }

        .waiting-players {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 14px;
            margin: 16px 0;
        }

        .waiting-title {
            color: #94a3b8;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .player-chip {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 13px;
            color: #60a5fa;
        }

        .player-chip.host {
            background: rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
            color: #fbbf24;
        }

        /* ═══════════════════════════════════════════════════
           PRIVATE LOBBY WAITING ROOM
           ═══════════════════════════════════════════════════ */
        #waitingRoomScreen {
            min-height: 100vh;
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .waiting-room-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .waiting-room-back {
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: #ef4444;
            font-size: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }

        .waiting-room-title {
            font-size: 20px;
            font-weight: 700;
            color: #fbbf24;
        }

        .waiting-room-code {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
            border: 2px solid #fbbf24;
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            margin-bottom: 20px;
        }

        .waiting-code-label {
            color: #94a3b8;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .waiting-code-value {
            font-size: 32px;
            font-weight: 800;
            color: #fbbf24;
            letter-spacing: 8px;
        }

        .waiting-room-info {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 20px;
        }

        .waiting-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .waiting-info-row:last-child {
            border-bottom: none;
        }

        .waiting-info-label {
            color: #94a3b8;
            font-size: 14px;
        }

        .waiting-info-value {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }

        .waiting-players-section {
            flex: 1;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .waiting-players-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .waiting-players-title {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }

        .waiting-players-count {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .waiting-players-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .waiting-player-slot {
            background: rgba(30, 41, 59, 0.8);
            border: 2px dashed rgba(148, 163, 184, 0.3);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .waiting-player-slot.occupied {
            border: 2px solid rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.1);
        }

        .waiting-player-slot.host {
            border: 2px solid rgba(251, 191, 36, 0.5);
            background: rgba(251, 191, 36, 0.1);
        }

        .waiting-player-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 6px;
        }

        .waiting-player-slot.host .waiting-player-avatar {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #000;
        }

        .waiting-player-name {
            color: #fff;
            font-size: 12px;
            font-weight: 600;
        }

        .waiting-player-slot.empty .waiting-player-avatar {
            background: rgba(148, 163, 184, 0.2);
            color: #64748b;
        }

        .waiting-player-slot.empty .waiting-player-name {
            color: #64748b;
        }

        .waiting-room-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .waiting-invite-btn {
            background: linear-gradient(135deg, #0088cc, #0077b5);
            border: none;
            border-radius: 12px;
            padding: 14px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .waiting-start-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            border-radius: 12px;
            padding: 14px;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .waiting-start-btn:disabled {
            background: rgba(148, 163, 184, 0.3);
            color: #64748b;
            cursor: not-allowed;
        }

        .waiting-status {
            text-align: center;
            color: #94a3b8;
            font-size: 14px;
            margin-top: 10px;
        }

        .waiting-status.ready {
            color: #22c55e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .waiting-dot {
            animation: pulse 1.5s infinite;
        }

        /* ═══════════════════════════════════════════════════
           SETTINGS MODAL STYLES
           ═══════════════════════════════════════════════════ */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Safe area padding */
            padding: calc(var(--safe-top) + 20px) 20px calc(var(--safe-bottom) + 20px) 20px;
            animation: fadeInModal 0.3s ease forwards;
        }

        .settings-modal.hidden {
            display: none !important;
        }

        .settings-content {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 380px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideInContent 0.3s ease forwards;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .settings-title {
            font-size: 22px;
            font-weight: 700;
            color: #3b82f6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-close {
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: #ef4444;
            font-size: 24px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .settings-close:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
        }

        .setting-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setting-icon {
            font-size: 24px;
        }

        .setting-text {
            display: flex;
            flex-direction: column;
        }

        .setting-name {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .setting-desc {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 2px;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            width: 56px;
            height: 30px;
            background: rgba(148, 163, 184, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .toggle-switch.active::before {
            transform: translateX(26px);
        }

        .toggle-label {
            position: absolute;
            font-size: 10px;
            font-weight: 700;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.8);
        }

        .toggle-label.on {
            left: 8px;
            opacity: 0;
        }

        .toggle-label.off {
            right: 6px;
            opacity: 1;
        }

        .toggle-switch.active .toggle-label.on {
            opacity: 1;
        }

        .toggle-switch.active .toggle-label.off {
            opacity: 0;
        }

        /* ═══════════════════════════════════════════════════
           WALLET MODAL STYLES (Deposit/Withdraw)
           ═══════════════════════════════════════════════════ */
        .wallet-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #1a0f2e 0%, #0f0a1a 50%, #0d0618 100%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            /* Large offset for TG close button (safe area + 50px for TG header) */
            padding-top: calc(var(--safe-top) + 50px);
            padding-bottom: var(--safe-bottom);
            animation: fadeInModal 0.3s ease forwards;
            overflow: hidden;
        }

        .wallet-modal.hidden {
            display: none !important;
        }

        /* Purple fill for top area above header */
        .wallet-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: calc(var(--safe-top) + 50px);
            background: var(--app-bg);
            z-index: 1;
        }

        .wallet-header {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(26, 15, 46, 0.95);
            border-bottom: 1px solid rgba(168, 85, 247, 0.2);
            flex-shrink: 0;
        }

        .wallet-title {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .wallet-title-icon {
            font-size: 24px;
        }

        .wallet-close-btn {
            /* Hidden by default - use TG BackButton instead */
            /* Visible only as fallback in browser without TG */
            display: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }
        
        /* Show close button only when not in Telegram */
        body:not(.tg-webapp) .wallet-close-btn {
            display: flex;
        }

        /* Wallet Tabs */
        .wallet-tabs {
            position: relative;
            z-index: 2;
            display: flex;
            padding: 12px 16px;
            gap: 8px;
            background: rgba(15, 10, 26, 0.95);
            flex-shrink: 0;
        }

        .wallet-tab {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.05);
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wallet-tab.active {
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
        }

        /* Wallet Content */
        .wallet-content {
            position: relative;
            z-index: 2;
            flex: 1;
            padding: 16px;
            padding-bottom: 32px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Promo Banner */
        .wallet-promo-banner {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #c084fc 100%);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .wallet-promo-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .wallet-promo-text {
            flex: 1;
        }

        .wallet-promo-text h3 {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }

        .wallet-promo-text p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .wallet-promo-icons {
            font-size: 40px;
            opacity: 0.9;
        }

        /* Balance Display (for Withdraw) */
        .wallet-balance-display {
            background: rgba(26, 15, 46, 0.6);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .wallet-balance-label {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .wallet-balance-amount {
            font-size: 36px;
            font-weight: 700;
            color: #fbbf24;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }

        .wallet-balance-currency {
            font-size: 18px;
            color: #94a3b8;
            margin-left: 8px;
        }

        /* Amount Input */
        .wallet-amount-input-wrapper {
            background: rgba(26, 15, 46, 0.6);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .wallet-amount-label {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .wallet-amount-input {
            width: 100%;
            background: rgba(15, 10, 26, 0.8);
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 8px;
            padding: 14px 16px;
            font-size: 20px;
            font-weight: 600;
            color: #fff;
            outline: none;
        }

        .wallet-amount-input::placeholder {
            color: #64748b;
        }

        .wallet-amount-input:focus {
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2);
        }

        /* Region/Currency Selector */
        .wallet-region-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(26, 15, 46, 0.4);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .wallet-region-label {
            font-size: 14px;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .wallet-currency-select {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
        }

        .wallet-currency-flag {
            font-size: 18px;
        }

        .wallet-currency-code {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        /* Section Title */
        .wallet-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 12px;
            padding-left: 4px;
        }

        /* Payment Methods Grid */
        .wallet-methods-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        /* Payment Method Card */
        .wallet-method-card {
            background: rgba(26, 15, 46, 0.6);
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .wallet-method-card:hover {
            border-color: rgba(168, 85, 247, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(168, 85, 247, 0.2);
        }

        .wallet-method-card.wide {
            grid-column: span 2;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }

        .wallet-method-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .wallet-method-min {
            font-size: 12px;
            color: #64748b;
        }

        .wallet-method-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            align-self: flex-end;
        }

        .wallet-method-icon.sber {
            background: linear-gradient(135deg, #21a038, #1a8f30);
        }

        .wallet-method-icon.tpay {
            background: linear-gradient(135deg, #ffdd2d, #fcc521);
            color: #000;
        }

        .wallet-method-icon.alfa {
            background: linear-gradient(135deg, #ef3124, #d62d20);
        }

        .wallet-method-icon.sbp {
            background: linear-gradient(135deg, #5b2d8e, #8b5cf6);
        }

        .wallet-method-icon.card {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .wallet-method-icon.piastrix {
            background: linear-gradient(135deg, #ff6b9d, #c44569);
        }

        .wallet-method-icon.usdt {
            background: linear-gradient(135deg, #26a17b, #1a8f6e);
        }

        .wallet-method-icon.ton {
            background: linear-gradient(135deg, #0098ea, #0088d1);
        }

        .wallet-method-icon.trx {
            background: linear-gradient(135deg, #ff0013, #eb0029);
        }

        /* Bonus Badge */
        .wallet-method-bonus {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 6px;
        }

        /* More Methods Card */
        .wallet-more-methods {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(124, 58, 237, 0.2));
            border: 1px dashed rgba(168, 85, 247, 0.4);
        }

        .wallet-more-methods .wallet-method-name {
            color: #c084fc;
        }

        /* ═══════════════════════════════════════════════════
           HISTORY MODAL STYLES
           ═══════════════════════════════════════════════════ */
        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            /* Safe area padding */
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            animation: fadeInModal 0.3s ease forwards;
        }

        .history-modal.hidden {
            display: none !important;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
        }

        .history-title {
            font-size: 22px;
            font-weight: 700;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-close {
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: #ef4444;
            font-size: 24px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .history-stats {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            background: rgba(15, 23, 42, 0.8);
        }

        .history-stat {
            flex: 1;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .history-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .history-stat-value.wins {
            color: #22c55e;
        }

        .history-stat-value.losses {
            color: #ef4444;
        }

        .history-stat-label {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
            text-transform: uppercase;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .history-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
            text-align: center;
        }

        .history-empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .history-empty-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .history-empty-hint {
            font-size: 14px;
            color: #475569;
        }

        .history-item {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #64748b;
        }

        .history-item.win {
            border-left-color: #22c55e;
        }

        .history-item.loss {
            border-left-color: #ef4444;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-item-result {
            font-size: 16px;
            font-weight: 700;
        }

        .history-item-result.win {
            color: #22c55e;
        }

        .history-item-result.loss {
            color: #ef4444;
        }

        .history-item-date {
            font-size: 12px;
            color: #64748b;
        }

        .history-item-details {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #94a3b8;
        }

        .history-item-amount {
            font-weight: 600;
        }

        .history-item-amount.positive {
            color: #22c55e;
        }

        .history-item-amount.negative {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <!-- CRITICAL: Initial loader - shows immediately while JS loads -->
    <div id="initialLoader" class="initial-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">🎰 Loading Poker House...</div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         SCREEN 0: FULLSCREEN REQUEST (shows first on mobile)
         ═══════════════════════════════════════════════════ -->
    <div id="fullscreenRequestScreen" class="hidden">
        <div class="fullscreen-request-container">
            <div class="fullscreen-icon">📱➡️🖥️</div>
            <h2 class="fullscreen-title">Лучший опыт игры</h2>
            <p class="fullscreen-description">
                Для комфортной игры в покер рекомендуем<br>
                развернуть приложение на весь экран
            </p>
            <button class="btn-enable-fullscreen" onclick="enableFullscreenAndContinue()">
                🎮 Включить полноэкранный режим
            </button>
            <button class="btn-skip-fullscreen" onclick="skipFullscreenAndContinue()">
                Пропустить
            </button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         SCREEN 1: SPLASH SCREEN
         ═══════════════════════════════════════════════════ -->
    <div id="splashScreen">
        <div class="splash-bg-glow"></div>
        <h1 class="splash-title">🎰 Poker House</h1>
        <div class="splash-cowboy">
            🤠<span class="splash-wave">👋</span>
        </div>
        <p class="splash-phrase" id="splashPhrase"></p>
    </div>

    <!-- ═══════════════════════════════════════════════════
         SCREEN 2: MAIN MENU
         ═══════════════════════════════════════════════════ -->
    <div id="mainMenu" class="hidden">
        <!-- Profile Card -->
        <div class="menu-profile-card">
            <div class="menu-avatar" id="menuAvatar">P</div>
            <div class="menu-player-name" id="menuName">Player</div>
            <div class="menu-balance-label">Balance</div>
            <div class="menu-balance" id="menuBalance">$1 000</div>
            
            <!-- Action Buttons -->
            <div class="menu-actions">
                <button class="menu-action-btn deposit" onclick="handleDeposit()">
                    <span class="icon">💳</span>
                    <span>Deposit</span>
                </button>
                <button class="menu-action-btn withdraw" onclick="handleWithdraw()">
                    <span class="icon">💰</span>
                    <span>Withdraw</span>
                </button>
                <button class="menu-action-btn history" onclick="handleHistory()">
                    <span class="icon">📋</span>
                    <span>History</span>
                </button>
                <button class="menu-action-btn settings" onclick="handleSettings()">
                    <span class="icon">⚙️</span>
                    <span>Settings</span>
                </button>
            </div>
            
            <!-- Stats -->
            <div class="menu-stats">
                <div class="menu-stat">
                    <div class="menu-stat-value" id="menuGames">0</div>
                    <div class="menu-stat-label">Games</div>
                </div>
                <div class="menu-stat">
                    <div class="menu-stat-value" id="menuWinRate">0%</div>
                    <div class="menu-stat-label">Win Rate</div>
                </div>
            </div>
        </div>

        <!-- Game Mode Tabs -->
        <div class="game-mode-tabs">
            <div class="game-mode-tab active" onclick="selectGameMode('tournament', this)">
                <span class="tab-icon">🏆</span>
                <span class="tab-title">Tournament</span>
            </div>
            <div class="game-mode-tab" onclick="selectGameMode('bounty', this)">
                <span class="tab-icon">🎯</span>
                <span class="tab-title">Bounty Hunter</span>
            </div>
            <div class="game-mode-tab" onclick="selectGameMode('sitgo', this)">
                <span class="tab-icon">⚡</span>
                <span class="tab-title">Sit & Go</span>
            </div>
        </div>

        <!-- Private Game Button -->
        <div class="private-game-section">
            <button class="private-game-btn" onclick="openLobby('private')">
                <span class="private-icon">🎰</span>
                <span class="private-text">Private Game</span>
                <span class="private-desc">Create or join private tables</span>
            </button>
        </div>

        <!-- Mode Description -->
        <div class="game-mode-desc" id="gameModeDesc">
            Multi-table tournaments with prize pools
        </div>

        <!-- Play Button -->
        <div class="play-section">
            <button class="play-btn" onclick="openLobby(currentGameMode)">
                Play Now
            </button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         SCREEN 3: GAME LOBBY
         ═══════════════════════════════════════════════════ -->
    <div id="lobbyScreen" class="hidden">
        <div class="lobby-header">
            <button class="back-btn" onclick="goBack()">←</button>
            <h2 class="lobby-title" id="lobbyTitle">Tournament Lobby</h2>
        </div>

        <div class="lobby-content">
            <!-- Left: Tables List -->
            <div class="lobby-tables">
                <div class="lobby-tabs">
                    <button class="lobby-tab active" onclick="switchTab(this, 'all')">All Tables</button>
                    <button class="lobby-tab" onclick="switchTab(this, 'low')">Low Stakes</button>
                    <button class="lobby-tab" onclick="switchTab(this, 'mid')">Mid Stakes</button>
                    <button class="lobby-tab" onclick="switchTab(this, 'high')">High Stakes</button>
                </div>

                <div id="tablesList">
                    <!-- Tables will be rendered here -->
                </div>
            </div>

            <!-- Right: Player Sidebar -->
            <div class="lobby-sidebar">
                <div class="sidebar-profile">
                    <div class="sidebar-avatar" id="lobbyAvatar">P</div>
                    <div class="sidebar-name" id="lobbyName">Player</div>
                    <div class="sidebar-handle" id="lobbyHandle"></div>
                    <div class="sidebar-balance" id="lobbyBalance">$100.00</div>
                </div>

                <div class="sidebar-buttons">
                    <button class="sidebar-btn primary" onclick="handleDeposit()">
                        <span>💳</span><span>Deposit</span>
                    </button>
                    <button class="sidebar-btn" onclick="handleWithdraw()">
                        <span>💰</span><span>Withdraw</span>
                    </button>
                    <button class="sidebar-btn" onclick="handleHistory()">
                        <span>📋</span><span>History</span>
                    </button>
                    <button class="sidebar-btn" onclick="handleSettings()">
                        <span>⚙️</span><span>Settings</span>
                    </button>
                </div>

                <div class="sidebar-stats">
                    <div>
                        <div class="stat-value">24</div>
                        <div class="stat-label">Games</div>
                    </div>
                    <div>
                        <div class="stat-value green">58%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         PRIVATE GAME MODAL
         ═══════════════════════════════════════════════════ -->
    <div id="privateGameModal" class="private-game-modal hidden">
        <div class="private-game-content">
            <div class="private-game-header">
                <div class="private-game-title">🎰 Private Game</div>
                <button class="private-game-close" onclick="closePrivateGameModal(true)">×</button>
            </div>

            <!-- Tabs: Create / Join -->
            <div class="private-game-tabs">
                <button class="pg-tab active" onclick="switchPrivateTab('create', this)">Create Lobby</button>
                <button class="pg-tab" onclick="switchPrivateTab('join', this)">Join Lobby</button>
            </div>

            <!-- Create Lobby Form -->
            <div id="createLobbyView">
                <div class="create-lobby-form">
                    <div class="form-group">
                        <label class="form-label">Buy-in Amount</label>
                        <select class="form-select" id="buyInSelect">
                            <option value="100">$100</option>
                            <option value="500">$500</option>
                            <option value="1000" selected>$100.00</option>
                            <option value="5000">$5,000</option>
                            <option value="10000">$10,000</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Max Players</label>
                        <select class="form-select" id="maxPlayersSelect">
                            <option value="2">2 Players (Heads-up)</option>
                            <option value="4">4 Players</option>
                            <option value="6" selected>6 Players</option>
                            <option value="9">9 Players</option>
                        </select>
                    </div>

                    <div class="blinds-row">
                        <div class="form-group">
                            <label class="form-label">Small Blind</label>
                            <select class="form-select" id="smallBlindSelect">
                                <option value="5">$5</option>
                                <option value="10" selected>$10</option>
                                <option value="25">$25</option>
                                <option value="50">$50</option>
                                <option value="100">$100</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Big Blind</label>
                            <select class="form-select" id="bigBlindSelect">
                                <option value="10">$10</option>
                                <option value="20" selected>$20</option>
                                <option value="50">$50</option>
                                <option value="100">$100</option>
                                <option value="200">$200</option>
                            </select>
                        </div>
                    </div>

                    <button class="create-btn" onclick="createPrivateLobby()">🎯 Create Lobby</button>
                </div>
            </div>

            <!-- Join Lobby Form -->
            <div id="joinLobbyView" class="hidden">
                <div class="join-lobby-form">
                    <div class="form-group">
                        <label class="form-label">Enter Lobby Code</label>
                        <input type="text" class="lobby-code-input" id="lobbyCodeInput" maxlength="6" placeholder="XXXXXX">
                    </div>
                    <button class="join-btn" onclick="joinPrivateLobby()">🚀 Join Lobby</button>
                </div>
            </div>

            <!-- Lobby Created View -->
            <div id="lobbyCreatedView" class="hidden">
                <div class="lobby-created">
                    <div class="lobby-code-display">
                        <div class="lobby-code-label">Your Lobby Code</div>
                        <div class="lobby-code-value" id="createdLobbyCode">ABC123</div>
                    </div>

                    <div class="lobby-settings-summary">
                        <div class="settings-row">
                            <span class="settings-label">Buy-in</span>
                            <span class="settings-value" id="summaryBuyIn">$100.00</span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Blinds</span>
                            <span class="settings-value" id="summaryBlinds">$10/$20</span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Max Players</span>
                            <span class="settings-value" id="summaryPlayers">6</span>
                        </div>
                    </div>

                    <div class="waiting-players">
                        <div class="waiting-title">Players in Lobby (1/<span id="maxPlayersCount">6</span>)</div>
                        <div class="players-list" id="lobbyPlayersList">
                            <span class="player-chip host" id="hostChip">👑 You (Host)</span>
                        </div>
                    </div>

                    <div class="invite-buttons">
                        <button class="invite-btn telegram" onclick="inviteViaTelegram()">
                            <span>📨</span> Invite via Telegram
                        </button>
                        <button class="invite-btn copy" onclick="copyLobbyLink()">
                            <span>📋</span> Copy Invite Link
                        </button>
                    </div>

                    <button class="start-game-btn" onclick="goToWaitingRoom()">▶️ Start Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         SCREEN: WAITING ROOM FOR PRIVATE LOBBY
         ═══════════════════════════════════════════════════ -->
    <div id="waitingRoomScreen" class="hidden">
        <div class="waiting-room-header">
            <button class="waiting-room-back" onclick="leaveWaitingRoom()">←</button>
            <div class="waiting-room-title">🎰 Private Lobby</div>
        </div>

        <div class="waiting-room-code">
            <div class="waiting-code-label">Lobby Code</div>
            <div class="waiting-code-value" id="waitingLobbyCode">XXXXXX</div>
        </div>

        <div class="waiting-room-info">
            <div class="waiting-info-row">
                <span class="waiting-info-label">Buy-in</span>
                <span class="waiting-info-value" id="waitingBuyIn">$100.00</span>
            </div>
            <div class="waiting-info-row">
                <span class="waiting-info-label">Blinds</span>
                <span class="waiting-info-value" id="waitingBlinds">$10/$20</span>
            </div>
            <div class="waiting-info-row">
                <span class="waiting-info-label">Max Players</span>
                <span class="waiting-info-value" id="waitingMaxPlayers">6</span>
            </div>
        </div>

        <div class="waiting-players-section">
            <div class="waiting-players-header">
                <span class="waiting-players-title">Players</span>
                <span class="waiting-players-count" id="waitingPlayersCount">1/6</span>
            </div>
            <div class="waiting-players-grid" id="waitingPlayersGrid">
                <!-- Players rendered dynamically -->
            </div>
        </div>

        <div class="waiting-room-actions">
            <button class="waiting-invite-btn" onclick="inviteViaTelegram()">
                <span>📨</span> Invite Friends via Telegram
            </button>
            <button class="waiting-start-btn" id="waitingStartBtn" onclick="startGameFromWaitingRoom()">
                ▶️ Start Game
            </button>
            <div class="waiting-status" id="waitingStatus">
                <span class="waiting-dot">⏳</span> Waiting for players to join...
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         SETTINGS MODAL
         ═══════════════════════════════════════════════════ -->
    <div id="settingsModal" class="settings-modal hidden">
        <div class="settings-content">
            <div class="settings-header">
                <div class="settings-title">⚙️ Settings</div>
                <button class="settings-close" onclick="closeSettings()">✕</button>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Audio</div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-icon">🎵</span>
                        <div class="setting-text">
                            <span class="setting-name">Background Music</span>
                            <span class="setting-desc">Play music during gameplay</span>
                        </div>
                    </div>
                    <div class="toggle-switch" id="musicToggle" onclick="toggleMusic()">
                        <span class="toggle-label on">ON</span>
                        <span class="toggle-label off">OFF</span>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-icon">🔊</span>
                        <div class="setting-text">
                            <span class="setting-name">Sound Effects</span>
                            <span class="setting-desc">Card sounds and notifications</span>
                        </div>
                    </div>
                    <div class="toggle-switch active" id="sfxToggle" onclick="toggleSFX()">
                        <span class="toggle-label on">ON</span>
                        <span class="toggle-label off">OFF</span>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Theme</div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-icon">✨</span>
                        <div class="setting-text">
                            <span class="setting-name">Neon Theme</span>
                            <span class="setting-desc">Purple neon glow style</span>
                        </div>
                    </div>
                    <div class="toggle-switch" id="neonToggle" onclick="toggleNeonTheme()">
                        <span class="toggle-label on">ON</span>
                        <span class="toggle-label off">OFF</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         HISTORY MODAL
         ═══════════════════════════════════════════════════ -->
    <div id="historyModal" class="history-modal hidden">
        <div class="history-header">
            <div class="history-title">📋 Game History</div>
            <button class="history-close" onclick="closeHistory()">✕</button>
        </div>

        <div class="history-stats">
            <div class="history-stat">
                <div class="history-stat-value" id="historyTotalGames">0</div>
                <div class="history-stat-label">Games</div>
            </div>
            <div class="history-stat">
                <div class="history-stat-value wins" id="historyWins">0</div>
                <div class="history-stat-label">Wins</div>
            </div>
            <div class="history-stat">
                <div class="history-stat-value losses" id="historyLosses">0</div>
                <div class="history-stat-label">Losses</div>
            </div>
            <div class="history-stat">
                <div class="history-stat-value" id="historyProfit">$0</div>
                <div class="history-stat-label">Profit</div>
            </div>
        </div>

        <div class="history-list" id="historyList">
            <!-- History items will be rendered here -->
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         WALLET MODAL (Deposit/Withdraw)
         ═══════════════════════════════════════════════════ -->
    <div id="walletModal" class="wallet-modal hidden">
        <!-- Header -->
        <div class="wallet-header">
            <div class="wallet-title">
                <span class="wallet-title-icon">💰</span>
                Кошелек
            </div>
            <button class="wallet-close-btn" onclick="closeWalletModal()">✕</button>
        </div>

        <!-- Tabs -->
        <div class="wallet-tabs">
            <button class="wallet-tab active" onclick="switchWalletTab('deposit')" id="tabDeposit">Депозит</button>
            <button class="wallet-tab" onclick="switchWalletTab('withdraw')" id="tabWithdraw">Вывод</button>
            <button class="wallet-tab" onclick="switchWalletTab('history')" id="tabHistory">История</button>
        </div>

        <!-- Content -->
        <div class="wallet-content">
            <!-- Deposit Tab Content -->
            <div id="walletDepositContent">
                <!-- Promo Banner -->
                <div class="wallet-promo-banner">
                    <div class="wallet-promo-text">
                        <h3>+5% на первое пополнение</h3>
                        <p>Бонус начисляется автоматически</p>
                    </div>
                    <div class="wallet-promo-icons">🎁💎</div>
                </div>

                <!-- Region/Currency -->
                <div class="wallet-region-row">
                    <div class="wallet-region-label">
                        Регион оплаты <span style="opacity:0.5">ⓘ</span>
                    </div>
                    <div class="wallet-currency-select">
                        <span class="wallet-currency-flag">🇷🇺</span>
                        <span class="wallet-currency-code">RUB</span>
                        <span style="opacity:0.5">▼</span>
                    </div>
                </div>

                <!-- Bank Payment Section -->
                <div class="wallet-section-title">Банковский платеж</div>
                <div class="wallet-methods-grid">
                    <div class="wallet-method-card" onclick="selectPaymentMethod('sber')">
                        <div class="wallet-method-name">SberPay</div>
                        <div class="wallet-method-min">от 200 ₽</div>
                        <div class="wallet-method-icon sber">💳</div>
                    </div>
                    <div class="wallet-method-card" onclick="selectPaymentMethod('tpay')">
                        <div class="wallet-method-name">T-Pay</div>
                        <div class="wallet-method-min">от 200 ₽</div>
                        <div class="wallet-method-icon tpay">💳</div>
                    </div>
                    <div class="wallet-method-card" onclick="selectPaymentMethod('alfa')">
                        <div class="wallet-method-name">Альфа-Банк</div>
                        <div class="wallet-method-min">от 1000 ₽</div>
                        <div class="wallet-method-icon alfa">💳</div>
                    </div>
                    <div class="wallet-method-card wallet-more-methods" onclick="showMoreMethods()">
                        <div class="wallet-method-name">Ещё 5 способов</div>
                        <div class="wallet-method-icon">→</div>
                    </div>
                </div>

                <!-- Crypto Section -->
                <div class="wallet-section-title">Криптовалюта</div>
                <div class="wallet-methods-grid">
                    <div class="wallet-method-card" onclick="selectPaymentMethod('usdt-trc20')">
                        <div class="wallet-method-bonus">+5%</div>
                        <div class="wallet-method-name">USDT</div>
                        <div class="wallet-method-min">(TRC20)</div>
                        <div class="wallet-method-icon usdt">₮</div>
                    </div>
                    <div class="wallet-method-card" onclick="selectPaymentMethod('ton')">
                        <div class="wallet-method-bonus">+5%</div>
                        <div class="wallet-method-name">TON</div>
                        <div class="wallet-method-min">(Toncoin)</div>
                        <div class="wallet-method-icon ton">💎</div>
                    </div>
                    <div class="wallet-method-card" onclick="selectPaymentMethod('usdt-ton')">
                        <div class="wallet-method-bonus">+5%</div>
                        <div class="wallet-method-name">USDT</div>
                        <div class="wallet-method-min">(TON)</div>
                        <div class="wallet-method-icon usdt">₮</div>
                    </div>
                    <div class="wallet-method-card" onclick="selectPaymentMethod('trx')">
                        <div class="wallet-method-name">TRX</div>
                        <div class="wallet-method-min">(Tron)</div>
                        <div class="wallet-method-icon trx">⟐</div>
                    </div>
                </div>
            </div>

            <!-- Withdraw Tab Content -->
            <div id="walletWithdrawContent" style="display: none;">
                <!-- Promo Banner -->
                <div class="wallet-promo-banner">
                    <div class="wallet-promo-text">
                        <h3>Быстрый вывод</h3>
                        <p>Средства поступят в течение 24 часов</p>
                    </div>
                    <div class="wallet-promo-icons">⚡💸</div>
                </div>

                <!-- Balance Display -->
                <div class="wallet-balance-display">
                    <div class="wallet-balance-label">Ваш баланс</div>
                    <div>
                        <span class="wallet-balance-amount" id="walletBalance">1,000</span>
                        <span class="wallet-balance-currency">₽</span>
                    </div>
                </div>

                <!-- Amount Input -->
                <div class="wallet-amount-input-wrapper">
                    <div class="wallet-amount-label">Сумма вывода</div>
                    <input type="number" class="wallet-amount-input" placeholder="Введите сумму" id="withdrawAmount">
                </div>

                <!-- Bank Payment Section -->
                <div class="wallet-section-title">Банковский платеж</div>
                <div class="wallet-methods-grid">
                    <div class="wallet-method-card wide" onclick="selectWithdrawMethod('card')">
                        <div>
                            <div class="wallet-method-name">Перевод на карту</div>
                            <div class="wallet-method-min">от 3000 ₽</div>
                        </div>
                        <div class="wallet-method-icon card">💳</div>
                    </div>
                    <div class="wallet-method-card" onclick="selectWithdrawMethod('sbp')">
                        <div class="wallet-method-name">СБП</div>
                        <div class="wallet-method-min">от 3000 ₽</div>
                        <div class="wallet-method-icon sbp">⚡</div>
                    </div>
                    <div class="wallet-method-card" onclick="selectWithdrawMethod('piastrix')">
                        <div class="wallet-method-name">Piastrix</div>
                        <div class="wallet-method-min">от 2000 ₽</div>
                        <div class="wallet-method-icon piastrix">✿</div>
                    </div>
                </div>

                <!-- Crypto Section -->
                <div class="wallet-section-title">Криптовалюта</div>
                <div class="wallet-methods-grid">
                    <div class="wallet-method-card" onclick="selectWithdrawMethod('usdt-trc20')">
                        <div class="wallet-method-name">USDT</div>
                        <div class="wallet-method-min">(TRC20)</div>
                        <div class="wallet-method-icon usdt">₮</div>
                    </div>
                    <div class="wallet-method-card" onclick="selectWithdrawMethod('ton')">
                        <div class="wallet-method-name">TON</div>
                        <div class="wallet-method-min">(Toncoin)</div>
                        <div class="wallet-method-icon ton">💎</div>
                    </div>
                    <div class="wallet-method-card" onclick="selectWithdrawMethod('usdt-ton')">
                        <div class="wallet-method-name">USDT</div>
                        <div class="wallet-method-min">(TON)</div>
                        <div class="wallet-method-icon usdt">₮</div>
                    </div>
                    <div class="wallet-method-card" onclick="selectWithdrawMethod('trx')">
                        <div class="wallet-method-name">TRX</div>
                        <div class="wallet-method-min">(Tron)</div>
                        <div class="wallet-method-icon trx">⟐</div>
                    </div>
                </div>
            </div>

            <!-- History Tab Content -->
            <div id="walletHistoryContent" style="display: none;">
                <div style="text-align: center; padding: 40px 20px; color: #64748b;">
                    <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                    <div style="font-size: 16px; margin-bottom: 8px;">История транзакций</div>
                    <div style="font-size: 14px;">Пока нет операций</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════
         SCREEN 4: POKER TABLE (PORTRAIT LAYOUT)
         ═══════════════════════════════════════════════════ -->
    <div id="pokerTableScreen" class="hidden">
        <!-- Top Header Bar -->
        <div class="poker-header">
            <button class="table-back-btn" onclick="leaveTable()">← Menu</button>
            <div class="table-info">
                <div class="table-info-name" id="tableInfoName">Daily Freeroll</div>
                <div class="table-info-blinds" id="tableInfoBlinds">PRE-FLOP</div>
            </div>
            <div class="header-spacer"></div>
        </div>

        <!-- Table Container (centers the vertical oval) -->
        <div class="poker-table-container">
            <div class="poker-table">
                <div class="table-felt"></div>
                
                <!-- POT Display -->
                <div class="pot-center">
                    <div class="pot-label">POT</div>
                    <div class="pot-amount" id="potAmount">$0</div>
                </div>
                
                <!-- Community Cards -->
                <div class="community-cards" id="communityCards">
                    <!-- Cards rendered here -->
                </div>

                <!-- Player Seats (6-max portrait layout) -->
                <div id="playerSeats">
                    <!-- Players rendered dynamically -->
                </div>
            </div>
        </div>

        <!-- Game Phase Indicator (right side) -->
        <div class="game-phase-indicator" id="gamePhaseIndicator">PRE-FLOP</div>
        
        <!-- Hand Strength HUD (left side) -->
        <div class="hand-hud hidden" id="handHud">
            <div class="hand-hud-icon" id="handIcon">🃏</div>
            <div class="hand-hud-rank" id="handRank">High Card</div>
            <div class="hand-hud-desc" id="handDesc">Ace high</div>
        </div>

        <!-- Bottom Controls Panel -->
        <div class="poker-controls-bottom">
            <!-- Hero Cards -->
            <div class="hero-cards" id="heroCards">
                <div class="hero-card red">
                    <span class="card-rank">A</span>
                    <span class="card-suit">♥</span>
                </div>
                <div class="hero-card black">
                    <span class="card-rank">K</span>
                    <span class="card-suit">♠</span>
                </div>
            </div>
            
            <!-- Action Buttons Row -->
            <div class="action-buttons-row" id="actionButtons">
                <button class="action-btn fold" onclick="playerAction('fold')">Fold</button>
                <button class="action-btn call" onclick="playerAction('call')" id="callBtn">Check</button>
                <button class="action-btn raise" onclick="playerAction('raise')" id="raiseBtn">Bet</button>
                <button class="action-btn allin" onclick="playerAction('allin')">All In</button>
            </div>
            
            <!-- Bet Slider Row -->
            <div class="slider-row">
                <div class="bet-amount-display" id="betDisplay">$20</div>
                <input type="range" class="bet-slider" id="betSlider" min="20" max="1000" value="20" oninput="updateBetSlider(this.value)">
                <div class="quick-bets">
                    <button class="quick-bet-btn" onclick="quickBet(2)">2x</button>
                    <button class="quick-bet-btn" onclick="quickBet(3)">3x</button>
                    <button class="quick-bet-btn" onclick="quickBet(0)">MAX</button>
                </div>
            </div>
        </div>
        
        <!-- Show/Muck Modal -->
        <div class="showmuck-modal hidden" id="showmuckModal">
            <div class="showmuck-content">
                <h3>Show Your Cards?</h3>
                <p>You folded. Reveal your hand to the table?</p>
                <div class="showmuck-cards" id="showmuckCards">
                    <!-- Cards displayed here -->
                </div>
                <div class="showmuck-buttons">
                    <button class="btn-show" onclick="showCards()">
                        👁️ SHOW
                        <span class="btn-hint">Reveal to table</span>
                    </button>
                    <button class="btn-muck" onclick="muckCards()">
                        🔒 MUCK
                        <span class="btn-hint">Keep hidden</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="debugInfo" class="debug"></div>

    <script>
        // ═══════════════════════════════════════════════════
        // AUDIO SYSTEM
        // ═══════════════════════════════════════════════════
        var audioContext = null;
        var isSoundEnabled = true;
        var isMusicEnabled = true;
        var bgMusicInterval = null;
        
        var audioInitialized = false;
        
        function initAudio() {
            if (audioInitialized) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioInitialized = true;
                console.log('Audio initialized successfully');
                
                // Resume context if suspended (required by browser policies)
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(function() {
                        console.log('AudioContext resumed');
                    });
                }
            } catch (e) {
                console.log('Audio not supported:', e);
            }
        }
        
        // Initialize audio on first user interaction (required by browsers)
        function setupAudioOnUserInteraction() {
            var initOnce = function() {
                initAudio();
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                document.removeEventListener('click', initOnce);
                document.removeEventListener('touchstart', initOnce);
                document.removeEventListener('keydown', initOnce);
            };
            document.addEventListener('click', initOnce);
            document.addEventListener('touchstart', initOnce);
            document.addEventListener('keydown', initOnce);
        }
        setupAudioOnUserInteraction();
        
        function playTone(frequency, duration, type, volume) {
            if (!isSoundEnabled) return;
            
            // Try to init audio if not done yet
            if (!audioContext) {
                initAudio();
            }
            if (!audioContext) return;
            
            try {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                var oscillator = audioContext.createOscillator();
                var gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = type || 'sine';
                oscillator.frequency.value = frequency;
                gainNode.gain.setValueAtTime(volume || 0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Audio play error:', e);
            }
        }
        
        function playCardSound() {
            // Quick snap sound for card dealing
            playTone(800, 0.05, 'square', 0.08);
            setTimeout(function() { playTone(600, 0.03, 'square', 0.05); }, 30);
        }
        
        function playCommunityCardSound() {
            // Slightly different sound for community cards
            playTone(500, 0.08, 'triangle', 0.1);
            setTimeout(function() { playTone(700, 0.06, 'triangle', 0.08); }, 50);
        }
        
        function playChipSound() {
            // Chip/bet sound
            playTone(300, 0.1, 'sine', 0.08);
            setTimeout(function() { playTone(400, 0.08, 'sine', 0.06); }, 60);
        }
        
        function playWinSound() {
            // Victory fanfare
            var notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
            notes.forEach(function(note, i) {
                setTimeout(function() {
                    playTone(note, 0.3, 'sine', 0.12);
                }, i * 150);
            });
        }
        
        function playFoldSound() {
            // Subtle fold sound
            playTone(200, 0.15, 'sine', 0.05);
        }
        
        function playCheckSound() {
            // Knock/tap sound
            playTone(400, 0.05, 'triangle', 0.06);
        }
        
        function startBgMusic() {
            if (!isMusicEnabled || !audioContext || bgMusicInterval) return;
            
            // Texas Hold'em style - jazzy/bluesy ambient music with arpeggios
            // Using minor 7th and dominant 7th chords for that smoky casino feel
            var sequences = [
                // Am7 arpeggio (A C E G)
                { notes: [220, 261, 329, 392], delay: 400 },
                // Dm7 arpeggio (D F A C)  
                { notes: [146, 174, 220, 261], delay: 400 },
                // G7 arpeggio (G B D F)
                { notes: [196, 246, 293, 349], delay: 400 },
                // Cmaj7 arpeggio (C E G B)
                { notes: [130, 164, 196, 246], delay: 400 },
                // Fmaj7 arpeggio (F A C E)
                { notes: [174, 220, 261, 329], delay: 400 },
                // Bm7b5 arpeggio (B D F A)
                { notes: [123, 146, 174, 220], delay: 400 },
                // E7 arpeggio (E G# B D)
                { notes: [164, 207, 246, 293], delay: 400 },
                // Am7 resolution
                { notes: [220, 261, 329, 392], delay: 400 }
            ];
            
            var seqIndex = 0;
            var noteIndex = 0;
            
            function playNextNote() {
                if (!isMusicEnabled) {
                    stopBgMusic();
                    return;
                }
                
                var seq = sequences[seqIndex % sequences.length];
                var note = seq.notes[noteIndex];
                
                // Play note with soft attack and decay
                playTone(note, 1.8, 'sine', 0.025);
                // Add subtle octave harmonic
                playTone(note * 2, 1.2, 'sine', 0.008);
                
                noteIndex++;
                if (noteIndex >= seq.notes.length) {
                    noteIndex = 0;
                    seqIndex++;
                    // Longer pause between chords
                    bgMusicInterval = setTimeout(playNextNote, 800);
                } else {
                    bgMusicInterval = setTimeout(playNextNote, seq.delay);
                }
            }
            
            // Start with slight delay
            bgMusicInterval = setTimeout(playNextNote, 500);
        }
        
        function stopBgMusic() {
            if (bgMusicInterval) {
                clearTimeout(bgMusicInterval);
                bgMusicInterval = null;
            }
        }
        
        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            return isSoundEnabled;
        }
        
        function toggleMusic() {
            isMusicEnabled = !isMusicEnabled;
            if (isMusicEnabled) {
                startBgMusic();
            } else {
                stopBgMusic();
            }
            return isMusicEnabled;
        }
        
        // ═══════════════════════════════════════════════════
        // DEBUG & INITIALIZATION
        // ═══════════════════════════════════════════════════
        var debugLog = [];
        function addDebug(msg) {
            debugLog.push(msg);
            var el = document.getElementById('debugInfo');
            if (el) el.textContent = debugLog.slice(-3).join(' → ');
            console.log('[mobile] ' + msg);
        }

        addDebug('Init');
        
        // ═══════════════════════════════════════════════════
        // SMOOTH SCREEN TRANSITIONS
        // ═══════════════════════════════════════════════════
        function showScreen(screenId, hideScreens) {
            hideScreens = hideScreens || [];
            
            addDebug('Transition: showing ' + screenId + ', hiding: ' + hideScreens.join(', '));
            
            // Hide specified screens with very smooth animation
            hideScreens.forEach(function(id) {
                var el = document.getElementById(id);
                if (el && !el.classList.contains('hidden')) {
                    el.style.transition = 'opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), transform 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                    el.style.opacity = '0';
                    el.style.transform = 'scale(0.97) translateY(10px)';
                    setTimeout(function() {
                        el.classList.add('hidden');
                        el.style.opacity = '';
                        el.style.transform = '';
                        el.style.transition = '';
                    }, 500);
                }
            });
            
            // Show new screen with very smooth animation
            setTimeout(function() {
                var showEl = document.getElementById(screenId);
                if (showEl) {
                    showEl.style.opacity = '0';
                    showEl.style.transform = 'scale(1.02) translateY(-10px)';
                    showEl.classList.remove('hidden');
                    
                    // Trigger reflow
                    showEl.offsetHeight;
                    
                    showEl.style.transition = 'opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                    showEl.style.opacity = '1';
                    showEl.style.transform = 'scale(1) translateY(0)';
                    
                    setTimeout(function() {
                        showEl.style.transition = '';
                        showEl.style.transform = '';
                    }, 650);
                }
            }, hideScreens.length > 0 ? 400 : 0);
        }
        
        // Instant hide for cleanup
        function hideScreen(screenId) {
            var el = document.getElementById(screenId);
            if (el) {
                el.style.transition = 'opacity 0.4s ease';
                el.style.opacity = '0';
                setTimeout(function() {
                    el.classList.add('hidden');
                    el.style.opacity = '';
                    el.style.transition = '';
                }, 400);
            }
        }

        // Global error handler to catch any JS errors
        window.onerror = function(msg, url, line, col, error) {
            addDebug('ERROR: ' + msg + ' at line ' + line);
            console.error('Global error:', msg, url, line, col, error);
            return false;
        };

        // Catch promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            addDebug('Promise error: ' + event.reason);
            console.error('Unhandled rejection:', event.reason);
        });

        // ═══════════════════════════════════════════════════
        // FULLSCREEN REQUEST FUNCTIONS
        // ═══════════════════════════════════════════════════
        function requestFullscreen() {
            // First expand Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.expand();
            }
            
            // Then request native fullscreen
            var elem = document.documentElement;
            try {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(function(err) {
                        console.log('Fullscreen request failed:', err);
                        window.scrollTo(0, 1); // Fallback: hide address bar
                    });
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                } else {
                    window.scrollTo(0, 1); // Fallback
                }
            } catch(e) {
                console.log('Fullscreen not supported:', e);
                window.scrollTo(0, 1);
            }
        }

        function enableFullscreenAndContinue() {
            localStorage.setItem('hasSeenFullscreenRequest', 'true');
            requestFullscreen();
            document.getElementById('fullscreenRequestScreen').classList.add('hidden');
            document.getElementById('splashScreen').style.display = 'flex';
            startSplashTimer();
        }

        function skipFullscreenAndContinue() {
            localStorage.setItem('hasSeenFullscreenRequest', 'true');
            document.getElementById('fullscreenRequestScreen').classList.add('hidden');
            document.getElementById('splashScreen').style.display = 'flex';
            startSplashTimer();
        }

        function showSplashScreen() {
            document.getElementById('splashScreen').style.display = 'flex';
            startSplashTimer();
        }

        // Telegram WebApp - check existence, not initData value
        var tg = window.Telegram && window.Telegram.WebApp;
        var isTelegramApp = !!(tg && typeof tg.initData !== 'undefined');
        
        if (tg) {
            try {
                tg.ready();
                tg.expand();
                
                // Mark body as Telegram WebApp for CSS selectors
                document.body.classList.add('tg-webapp');
                
                // Request fullscreen mode (Telegram API v8.0+)
                if (tg.requestFullscreen) {
                    tg.requestFullscreen();
                    addDebug('TG fullscreen requested');
                }
                
                // Disable vertical swipes to prevent accidental closing
                if (tg.disableVerticalSwipes) {
                    tg.disableVerticalSwipes();
                }
                
                // Set purple header color to match app theme
                // Use darker purple that's visible as header
                if (tg.setHeaderColor) {
                    try {
                        tg.setHeaderColor('#1a0f2e');
                    } catch(e) {
                        // Fallback for older versions
                        try { tg.setHeaderColor('secondary_bg_color'); } catch(e2) {}
                    }
                }
                
                // Set purple background color
                if (tg.setBackgroundColor) {
                    tg.setBackgroundColor('#1a0f2e');
                }
                
                // Also set bottom bar color if available
                if (tg.setBottomBarColor) {
                    tg.setBottomBarColor('#0d0618');
                }
            } catch(e) {
                addDebug('TG init error: ' + e.message);
            }
            addDebug('TG OK');
        }

        // Hide initial loader
        function hideInitialLoader() {
            var loader = document.getElementById('initialLoader');
            if (loader) loader.classList.add('loaded');
        }

        // ═══════════════════════════════════════════════════
        // TELEGRAM FULLSCREEN HANDLING
        // ═══════════════════════════════════════════════════
        var isFullscreenEnabled = false;
        
        function tryTelegramFullscreen() {
            if (tg && tg.requestFullscreen && !isFullscreenEnabled) {
                try {
                    tg.requestFullscreen();
                } catch(e) {
                    addDebug('Fullscreen error: ' + e.message);
                }
            }
        }
        
        // Listen to Telegram fullscreen events
        if (tg) {
            // Handle fullscreen change
            if (tg.onEvent) {
                tg.onEvent('fullscreenChanged', function() {
                    isFullscreenEnabled = tg.isFullscreen;
                    addDebug('Fullscreen changed: ' + isFullscreenEnabled);
                });
                
                tg.onEvent('fullscreenFailed', function(event) {
                    addDebug('Fullscreen failed: ' + (event && event.error));
                });
            }
            
            // Try fullscreen on first user interaction (required by some platforms)
            document.addEventListener('click', function onFirstClick() {
                tryTelegramFullscreen();
                document.removeEventListener('click', onFirstClick);
            }, { once: true });
            
            document.addEventListener('touchstart', function onFirstTouch() {
                tryTelegramFullscreen();
                document.removeEventListener('touchstart', onFirstTouch);
            }, { once: true });
        }

        // ═══════════════════════════════════════════════════
        // APP INITIALIZATION
        // ═══════════════════════════════════════════════════
        window.addEventListener('DOMContentLoaded', function() {
            addDebug('DOM loaded');
            
            // Hide loader first
            hideInitialLoader();
            
            try {
                // In Telegram: skip all intermediate screens
                if (isTelegramApp) {
                    addDebug('Telegram app - fast load');
                    document.getElementById('splashScreen').style.display = 'none';
                    document.getElementById('fullscreenRequestScreen').classList.add('hidden');
                    document.getElementById('mainMenu').classList.remove('hidden');
                    try { updateUserUI(); } catch(e) {}
                    
                    // Try fullscreen again after DOM loaded
                    setTimeout(tryTelegramFullscreen, 100);
                    return;
                }
                
                // In browser: check for fullscreen request
                var hasSeenRequest = false;
                try { hasSeenRequest = localStorage.getItem('hasSeenFullscreenRequest'); } catch(e) {}
                
                if (!hasSeenRequest) {
                    document.getElementById('splashScreen').style.display = 'none';
                    document.getElementById('fullscreenRequestScreen').classList.remove('hidden');
                } else {
                    document.getElementById('fullscreenRequestScreen').classList.add('hidden');
                    document.getElementById('splashScreen').style.display = 'flex';
                    startSplashTimer();
                }
            } catch (e) {
                addDebug('Init error: ' + e.message);
                // Ultimate fallback
                document.getElementById('mainMenu').classList.remove('hidden');
            }
        });

        // User info
        var user = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
        var telegramUserId = user ? user.id : null;
        var userName = user ? user.first_name : 'Guest';
        var userHandle = user && user.username ? '@' + user.username : '';
        var userInitial = userName ? userName.charAt(0).toUpperCase() : 'P';
        var userBalance = 1000; // Default balance, will be updated from server

        addDebug('User: ' + userName + (telegramUserId ? ' #' + telegramUserId : ''));

        // ═══════════════════════════════════════════════════
        // USER REGISTRATION / INIT
        // ═══════════════════════════════════════════════════
        var API_BASE = 'https://poker-game-poker-game.up.railway.app';

        async function initUser() {
            if (!telegramUserId) {
                addDebug('No TG ID - guest mode');
                return;
            }

            try {
                var response = await fetch(API_BASE + '/api/user/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegram_id: telegramUserId,
                        username: user.username || null,
                        first_name: userName
                    })
                });

                if (response.ok) {
                    var data = await response.json();
                    userBalance = data.balance || 1000;
                    updateBalanceUI();
                    addDebug('User init OK: $' + userBalance);
                } else {
                    addDebug('User init failed: ' + response.status);
                }
            } catch (err) {
                addDebug('User init error: ' + err.message);
                // Continue with default balance
            }
        }

        function updateBalanceUI() {
            var balanceStr = '$' + userBalance.toLocaleString();
            var menuBalanceEl = document.getElementById('menuBalance');
            var lobbyBalanceEl = document.getElementById('lobbyBalance');
            if (menuBalanceEl) menuBalanceEl.textContent = balanceStr;
            if (lobbyBalanceEl) lobbyBalanceEl.textContent = balanceStr;
        }

        // ═══════════════════════════════════════════════════
        // SPLASH SCREEN
        // ═══════════════════════════════════════════════════
        var welcomePhrases = [
            "Welcome, cowboy. Let's play!",
            "Howdy, partner! Ready to go all-in?",
            "Saddle up, gunslinger. Fortune awaits!",
            "Time to show your poker face, partner!",
            "Draw your cards, cowboy. Let the game begin!"
        ];

        var splashTimeout = null;
        
        function startSplashTimer() {
            if (splashTimeout) clearTimeout(splashTimeout);
            
            // Set random phrase safely
            var phraseEl = document.getElementById('splashPhrase');
            if (phraseEl) {
                var randomPhrase = welcomePhrases[Math.floor(Math.random() * welcomePhrases.length)];
                phraseEl.textContent = randomPhrase;
            }
            
            // Transition to main menu after 3 seconds
            splashTimeout = setTimeout(function() {
                var splashEl = document.getElementById('splashScreen');
                var menuEl = document.getElementById('mainMenu');
                
                if (splashEl) splashEl.classList.add('hidden');
                if (menuEl) menuEl.classList.remove('hidden');
                
                updateUserUI();
                initUser(); // Register/load user from backend
                addDebug('Menu shown');
                
                // Initialize audio and start background music in menu
                initAudio();
                startBgMusic();
            }, 3000);
        }

        // ═══════════════════════════════════════════════════
        // UI UPDATES
        // ═══════════════════════════════════════════════════
        function updateUserUI() {
            // Main menu
            var menuAvatar = document.getElementById('menuAvatar');
            var menuName = document.getElementById('menuName');
            var menuHandle = document.getElementById('menuHandle');
            if (menuAvatar) menuAvatar.textContent = userInitial;
            if (menuName) menuName.textContent = userName || 'Player';
            if (menuHandle) menuHandle.textContent = userHandle;

            // Lobby sidebar
            var lobbyAvatar = document.getElementById('lobbyAvatar');
            var lobbyName = document.getElementById('lobbyName');
            var lobbyHandle = document.getElementById('lobbyHandle');
            if (lobbyAvatar) lobbyAvatar.textContent = userInitial;
            if (lobbyName) lobbyName.textContent = userName || 'Player';
            if (lobbyHandle) lobbyHandle.textContent = userHandle;
        }

        // ═══════════════════════════════════════════════════
        // NAVIGATION
        // ═══════════════════════════════════════════════════
        var currentMode = '';
        var currentGameMode = 'tournament';
        var gameModeDescriptions = {
            'tournament': 'Multi-table tournaments with prize pools',
            'bounty': 'Knockout rewards for eliminations',
            'sitgo': 'Fast single-table tournaments'
        };

        function selectGameMode(mode, element) {
            currentGameMode = mode;
            // Update active tab
            document.querySelectorAll('.game-mode-tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            // Update description
            var descEl = document.getElementById('gameModeDesc');
            if (descEl) descEl.textContent = gameModeDescriptions[mode] || '';
        }

        function openLobby(mode) {
            currentMode = mode;
            addDebug('Open: ' + mode);

            // Private Game opens a special modal instead of lobby screen
            if (mode === 'private') {
                openPrivateGameModal();
                return;
            }

            var titles = {
                tournament: '🏆 Tournament Lobby',
                bounty: '🎯 Bounty Hunter Lobby',
                sitgo: '⚡ Sit & Go Lobby',
                private: '🎰 Private Games'
            };

            document.getElementById('lobbyTitle').textContent = titles[mode] || 'Lobby';
            
            // Smooth transition to lobby
            showScreen('lobbyScreen', ['mainMenu']);

            renderTables(mode);
        }

        function goBack() {
            addDebug('Back');
            // Smooth transition back to main menu
            showScreen('mainMenu', ['lobbyScreen']);
        }

        function switchTab(btn, filter) {
            var tabs = document.querySelectorAll('.lobby-tab');
            tabs.forEach(function(t) { t.classList.remove('active'); });
            btn.classList.add('active');
            renderTables(currentMode, filter);
        }

        // ═══════════════════════════════════════════════════
        // TABLES DATA & RENDERING
        // ═══════════════════════════════════════════════════
        var tablesData = {
            tournament: [
                { name: 'Daily Freeroll', buyIn: 'Free', players: '45/100', blinds: '50/100', status: 'open' },
                { name: 'Sunday Major', buyIn: '$50', players: '120/200', blinds: '100/200', status: 'open' },
                { name: 'High Roller', buyIn: '$500', players: '18/20', blinds: '500/1000', status: 'waiting' }
            ],
            bounty: [
                { name: 'Headhunter $10', buyIn: '$10', players: '32/50', blinds: '25/50', status: 'open' },
                { name: 'Knockout King', buyIn: '$25', players: '64/100', blinds: '50/100', status: 'open' }
            ],
            sitgo: [
                { name: 'Turbo 6-Max', buyIn: '$5', players: '4/6', blinds: '25/50', status: 'waiting' },
                { name: 'Hyper 9-Max', buyIn: '$10', players: '9/9', blinds: '50/100', status: 'full' },
                { name: 'Standard 6-Max', buyIn: '$20', players: '2/6', blinds: '25/50', status: 'open' }
            ],
            private: [
                { name: 'Friends Only', buyIn: '$10', players: '3/8', blinds: '10/20', status: 'waiting' },
                { name: 'VIP Room', buyIn: '$100', players: '5/6', blinds: '50/100', status: 'open' }
            ]
        };

        function renderTables(mode, filter) {
            var tables = tablesData[mode] || [];
            var container = document.getElementById('tablesList');
            var html = '';

            tables.forEach(function(table) {
                var statusClass = table.status === 'waiting' ? 'waiting' : (table.status === 'full' ? 'full' : '');
                var statusText = table.status === 'open' ? 'Open' : (table.status === 'waiting' ? 'Starting...' : 'Full');

                html += '<div class="table-card">' +
                    '<div class="table-card-header">' +
                        '<div class="table-name">' + table.name + '</div>' +
                        '<div class="table-status ' + statusClass + '">' + statusText + '</div>' +
                    '</div>' +
                    '<div class="table-info">' +
                        '<span>💰 ' + table.buyIn + '</span>' +
                        '<span>👥 ' + table.players + '</span>' +
                        '<span>🎯 ' + table.blinds + '</span>' +
                    '</div>' +
                    '<button class="join-btn" onclick="joinTable(\'' + table.name + '\')">Join Table</button>' +
                '</div>';
            });

            if (tables.length === 0) {
                html = '<div style="text-align:center;color:#64748b;padding:40px;">No tables available</div>';
            }

            container.innerHTML = html;
        }

        function joinTable(tableName) {
            addDebug('Join: ' + tableName);
            // Portrait mode is now default - load directly
            loadPokerTable(tableName);
        }

        // ═══════════════════════════════════════════════════
        // DEVICE DETECTION
        // ═══════════════════════════════════════════════════
        var deviceType = (function() {
            var ua = navigator.userAgent;
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
            var isTablet = /(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua.toLowerCase());
            var w = window.innerWidth;
            if (isMobile && w < 768) return 'mobile';
            if (isTablet || (w >= 768 && w < 1024)) return 'tablet';
            return 'desktop';
        })();
        document.body.classList.add('device-' + deviceType);
        addDebug('Device: ' + deviceType);

        // ═══════════════════════════════════════════════════
        // CARD DECK & HAND EVALUATION
        // ═══════════════════════════════════════════════════
        var RANKS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
        var SUITS = ['♥','♦','♣','♠'];
        var RANK_VALUES = {'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};
        var RANK_NAMES = {14:'Ace',13:'King',12:'Queen',11:'Jack',10:'Ten',9:'Nine',8:'Eight',7:'Seven',6:'Six',5:'Five',4:'Four',3:'Three',2:'Two'};

        function createDeck() {
            var deck = [];
            SUITS.forEach(function(suit) {
                RANKS.forEach(function(rank) {
                    deck.push({ rank: rank, suit: suit });
                });
            });
            // Shuffle
            for (var i = deck.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = deck[i]; deck[i] = deck[j]; deck[j] = temp;
            }
            return deck;
        }

        function getCardValue(card) { return RANK_VALUES[card.rank] || 0; }
        function isRed(suit) { return suit === '♥' || suit === '♦'; }
        function formatCard(card) { return card.rank + card.suit; }

        function evaluateHand(cards) {
            if (cards.length < 5) return { rank: 0, name: 'Not enough cards', cards: [] };
            
            // Get all 5-card combinations
            var combos = getCombinations(cards, 5);
            var best = null;
            
            combos.forEach(function(combo) {
                var result = evaluateFiveCards(combo);
                if (!best || result.rank > best.rank) best = result;
            });
            
            return best || { rank: 0, name: 'High Card', cards: cards.slice(0,5) };
        }

        function getCombinations(arr, size) {
            if (size === 1) return arr.map(function(x) { return [x]; });
            if (size > arr.length) return [];
            var result = [];
            for (var i = 0; i <= arr.length - size; i++) {
                var head = arr[i];
                var tails = getCombinations(arr.slice(i + 1), size - 1);
                tails.forEach(function(tail) { result.push([head].concat(tail)); });
            }
            return result;
        }

        function evaluateFiveCards(cards) {
            var sorted = cards.slice().sort(function(a,b) { return getCardValue(b) - getCardValue(a); });
            var values = sorted.map(getCardValue);
            var suits = sorted.map(function(c) { return c.suit; });
            
            var isFlush = suits.every(function(s) { return s === suits[0]; });
            var isStraight = checkStraight(values);
            var groups = groupByValue(values);
            var counts = Object.values(groups).sort(function(a,b) { return b - a; });
            
            // Helper: get cards by their value count
            function getCardsByCount(count) {
                var result = [];
                var valueGroups = {};
                sorted.forEach(function(c) {
                    var v = getCardValue(c);
                    if (!valueGroups[v]) valueGroups[v] = [];
                    valueGroups[v].push(c);
                });
                for (var v in valueGroups) {
                    if (valueGroups[v].length === count) {
                        result = result.concat(valueGroups[v]);
                    }
                }
                return result;
            }
            
            // Royal Flush - all 5 cards form the combo
            if (isFlush && isStraight && values[0] === 14 && values[4] === 10) {
                return { rank: 10, name: 'Royal Flush', cards: sorted };
            }
            // Straight Flush - all 5 cards
            if (isFlush && isStraight) {
                return { rank: 9, name: 'Straight Flush', cards: sorted };
            }
            // Four of a Kind - only the 4 matching cards
            if (counts[0] === 4) {
                return { rank: 8, name: 'Four of a Kind', cards: getCardsByCount(4) };
            }
            // Full House - all 5 cards (3 + 2)
            if (counts[0] === 3 && counts[1] === 2) {
                return { rank: 7, name: 'Full House', cards: sorted };
            }
            // Flush - all 5 cards
            if (isFlush) {
                return { rank: 6, name: 'Flush', cards: sorted };
            }
            // Straight - all 5 cards
            if (isStraight) {
                return { rank: 5, name: 'Straight', cards: sorted };
            }
            // Three of a Kind - only the 3 matching cards
            if (counts[0] === 3) {
                return { rank: 4, name: 'Three of a Kind', cards: getCardsByCount(3) };
            }
            // Two Pair - only the 4 cards that form both pairs
            if (counts[0] === 2 && counts[1] === 2) {
                return { rank: 3, name: 'Two Pair', cards: getCardsByCount(2) };
            }
            // One Pair - only the 2 matching cards
            if (counts[0] === 2) {
                return { rank: 2, name: 'One Pair', cards: getCardsByCount(2) };
            }
            // High Card - no cards to highlight
            return { rank: 1, name: 'High Card', cards: [] };
        }

        function checkStraight(values) {
            for (var i = 0; i < 4; i++) {
                if (values[i] - values[i+1] !== 1) {
                    // Check wheel (A-2-3-4-5)
                    if (i === 0 && values[0] === 14 && values[1] === 5 && values[2] === 4 && values[3] === 3 && values[4] === 2) {
                        return true;
                    }
                    return false;
                }
            }
            return true;
        }

        function groupByValue(values) {
            var groups = {};
            values.forEach(function(v) { groups[v] = (groups[v] || 0) + 1; });
            return groups;
        }

        // ═══════════════════════════════════════════════════
        // GAME STATE
        // ═══════════════════════════════════════════════════
        var gameState = {
            phase: 'waiting', // waiting, preflop, flop, turn, river, showdown
            deck: [],
            communityCards: [],
            pot: 0,
            currentBet: 0,
            smallBlind: 10,
            bigBlind: 20,
            dealerSeat: 0,
            currentPlayerSeat: null,
            timeRemaining: 30,
            timerInterval: null,
            players: [
                { seat: 0, name: userName || 'You', chips: userBalance, cards: [], bet: 0, status: 'active', isHero: true },
                { seat: 1, name: 'Alex', chips: 850, cards: [], bet: 0, status: 'active' },
                { seat: 3, name: 'Maria', chips: 1200, cards: [], bet: 0, status: 'active' },
                { seat: 4, name: 'John', chips: 950, cards: [], bet: 0, status: 'active' },
                { seat: 5, name: 'Kate', chips: 720, cards: [], bet: 0, status: 'active' }
            ]
        };

        function getPlayer(seat) {
            return gameState.players.find(function(p) { return p.seat === seat; });
        }

        function getHero() {
            // In multiplayer, use mySeat to find hero
            if (mySeat && lastGameState && lastGameState.players) {
                return lastGameState.players.find(function(p) {
                    return parseInt(p.seat) === parseInt(mySeat);
                });
            }
            // Fallback for local game
            return gameState.players.find(function(p) { return p.isHero; });
        }

        function getActivePlayers() {
            return gameState.players.filter(function(p) { return p.status === 'active'; });
        }

        function getNextActiveSeat(currentSeat) {
            var seats = gameState.players.map(function(p) { return p.seat; }).sort(function(a,b) { return a - b; });
            var idx = seats.indexOf(currentSeat);
            for (var i = 1; i <= seats.length; i++) {
                var nextIdx = (idx + i) % seats.length;
                var nextSeat = seats[nextIdx];
                var player = getPlayer(nextSeat);
                if (player && player.status === 'active') return nextSeat;
            }
            return null;
        }

        // ═══════════════════════════════════════════════════
        // GAME FLOW
        // ═══════════════════════════════════════════════════
        function loadPokerTable(tableName) {
            addDebug('Loading: ' + tableName);
            
            // Find table data
            var tableInfo = null;
            Object.keys(tablesData).forEach(function(mode) {
                tablesData[mode].forEach(function(t) {
                    if (t.name === tableName) tableInfo = t;
                });
            });
            
            // Parse blinds from table info
            if (tableInfo && tableInfo.blinds) {
                var blinds = tableInfo.blinds.split('/');
                gameState.smallBlind = parseInt(blinds[0]) || 10;
                gameState.bigBlind = parseInt(blinds[1]) || 20;
            }
            
            // Update UI
            document.getElementById('tableInfoName').textContent = tableName;
            document.getElementById('tableInfoBlinds').textContent = 'Blinds: ' + gameState.smallBlind + '/' + gameState.bigBlind;
            
            // Reset game state
            gameState.phase = 'waiting';
            gameState.pot = 0;
            gameState.communityCards = [];
            gameState.players.forEach(function(p) {
                p.cards = [];
                p.bet = 0;
                p.status = 'active';
            });
            
            // Show table screen with smooth transition
            showScreen('pokerTableScreen', ['lobbyScreen']);
            
            // Request fullscreen when entering game
            if (tg) tg.expand();
            requestFullscreen();
            
            // Initialize players for portrait layout
            initPortraitPlayerPositions();
            
            // Update game phase indicator
            updateGamePhaseIndicator('preflop');
            
            // Start first hand after delay
            setTimeout(startNewHand, 1500);
        }

        // ═══════════════════════════════════════════════════
        // GAME PHASE INDICATOR UPDATE
        // ═══════════════════════════════════════════════════
        function updateGamePhaseIndicator(phase) {
            var indicator = document.getElementById('gamePhaseIndicator');
            if (!indicator) return;
            
            // Remove all phase classes
            indicator.classList.remove('flop', 'turn', 'river');
            
            var phaseNames = {
                'preflop': 'PRE-FLOP',
                'flop': 'FLOP',
                'turn': 'TURN',
                'river': 'RIVER',
                'showdown': 'SHOWDOWN'
            };
            
            indicator.textContent = phaseNames[phase] || phase.toUpperCase();
            
            // Add phase-specific class for coloring
            if (phase === 'flop') indicator.classList.add('flop');
            else if (phase === 'turn') indicator.classList.add('turn');
            else if (phase === 'river') indicator.classList.add('river');
        }

        // ═══════════════════════════════════════════════════
        // PORTRAIT PLAYER POSITIONING
        // ═══════════════════════════════════════════════════
        function initPortraitPlayerPositions() {
            // For 6-max table, user is always seat 0 (bottom center)
            // Other players arranged clockwise
            var positions = [
                'seat-0',  // Bottom (USER)
                'seat-1',  // Left lower
                'seat-2',  // Left upper
                'seat-3',  // Top
                'seat-4',  // Right upper
                'seat-5'   // Right lower
            ];
            
            gameState.players.forEach(function(player, index) {
                player.position = positions[index % 6];
            });
        }

        function startNewHand() {
            addDebug('New hand');
            gameState.phase = 'preflop';
            gameState.pot = 0;
            gameState.currentBet = gameState.bigBlind;
            gameState.communityCards = [];
            gameState.deck = createDeck();
            
            // IMPORTANT: Clear community cards display immediately!
            updateCommunityCards();
            
            // Reset players
            gameState.players.forEach(function(p) {
                p.cards = [];
                p.bet = 0;
                if (p.chips > 0) p.status = 'active';
            });
            
            // Rotate dealer
            gameState.dealerSeat = getNextActiveSeat(gameState.dealerSeat) || 0;
            
            // Post blinds
            var sbSeat = getNextActiveSeat(gameState.dealerSeat);
            var bbSeat = getNextActiveSeat(sbSeat);
            
            var sbPlayer = getPlayer(sbSeat);
            var bbPlayer = getPlayer(bbSeat);
            
            if (sbPlayer) {
                var sbAmount = Math.min(gameState.smallBlind, sbPlayer.chips);
                sbPlayer.chips -= sbAmount;
                sbPlayer.bet = sbAmount;
                gameState.pot += sbAmount;
            }
            
            if (bbPlayer) {
                var bbAmount = Math.min(gameState.bigBlind, bbPlayer.chips);
                bbPlayer.chips -= bbAmount;
                bbPlayer.bet = bbAmount;
                gameState.pot += bbAmount;
            }
            
            // Deal cards
            dealPlayerCards();
            
            // First to act is after BB
            gameState.currentPlayerSeat = getNextActiveSeat(bbSeat);
            
            // Update UI
            updateGameUI();
            updatePhaseDisplay();
            
            // Start timer if not hero's turn
            startTurnTimer();
        }

        function dealPlayerCards() {
            gameState.players.forEach(function(p) {
                if (p.status === 'active' && gameState.deck.length >= 2) {
                    p.cards = [gameState.deck.pop(), gameState.deck.pop()];
                }
            });
            
            // Update hero cards display with combo highlighting
            var hero = getHero();
            if (hero && hero.cards.length === 2) {
                var heroCardsEl = document.getElementById('heroCards');
                var comboCardKeys = getComboCardKeys();
                
                heroCardsEl.innerHTML = hero.cards.map(function(card) {
                    var cardKey = card.rank + card.suit;
                    var isComboCard = comboCardKeys.indexOf(cardKey) !== -1;
                    var comboClass = isComboCard ? ' combo-card' : '';
                    
                    return '<div class="hero-card ' + (isRed(card.suit) ? 'red' : 'black') + comboClass + '">' +
                        '<span class="card-rank">' + card.rank + '</span>' +
                        '<span class="card-suit">' + card.suit + '</span>' +
                    '</div>';
                }).join('');
            }
        }

        function advancePhase() {
            clearInterval(gameState.timerInterval);
            
            // Reset bets for new round
            gameState.players.forEach(function(p) { p.bet = 0; });
            gameState.currentBet = 0;
            
            switch(gameState.phase) {
                case 'preflop':
                    dealFlop();
                    break;
                case 'flop':
                    dealTurn();
                    break;
                case 'turn':
                    dealRiver();
                    break;
                case 'river':
                    showdown();
                    break;
            }
        }

        function dealFlop() {
            gameState.phase = 'flop';
            addDebug('Dealing flop');
            
            // Burn one, deal three
            gameState.deck.pop();
            for (var i = 0; i < 3; i++) {
                gameState.communityCards.push(gameState.deck.pop());
            }
            
            updateCommunityCards();
            updatePhaseDisplay();
            startBettingRound();
        }

        function dealTurn() {
            gameState.phase = 'turn';
            addDebug('Dealing turn');
            
            gameState.deck.pop();
            gameState.communityCards.push(gameState.deck.pop());
            
            updateCommunityCards();
            updatePhaseDisplay();
            startBettingRound();
        }

        function dealRiver() {
            gameState.phase = 'river';
            addDebug('Dealing river');
            
            gameState.deck.pop();
            gameState.communityCards.push(gameState.deck.pop());
            
            updateCommunityCards();
            updatePhaseDisplay();
            startBettingRound();
        }

        function startBettingRound() {
            // First to act after dealer
            gameState.currentPlayerSeat = getNextActiveSeat(gameState.dealerSeat);
            updateGameUI();
            startTurnTimer();
        }

        function showdown() {
            gameState.phase = 'showdown';
            addDebug('Showdown!');
            updatePhaseDisplay();
            
            var activePlayers = getActivePlayers();
            
            if (activePlayers.length === 1) {
                // Everyone else folded
                declareWinner(activePlayers[0], 'Last player standing');
                return;
            }
            
            // Evaluate hands
            var results = activePlayers.map(function(player) {
                var allCards = player.cards.concat(gameState.communityCards);
                var hand = evaluateHand(allCards);
                return { player: player, hand: hand };
            });
            
            // Sort by hand rank
            results.sort(function(a, b) { return b.hand.rank - a.hand.rank; });
            
            var winner = results[0].player;
            var handName = results[0].hand.name;
            
            declareWinner(winner, handName);
        }

        function declareWinner(winner, handName) {
            addDebug('Winner: ' + winner.name + ' - ' + handName);
            
            // Award pot
            winner.chips += gameState.pot;
            
            // Show winner animation
            showWinnerPopup(winner, handName, gameState.pot);
            
            // Record game result to history
            if (winner.isHero) {
                addGameToHistory('win', gameState.pot, handName, 'Bot Game');
                userBalance = winner.chips;
                updateBalanceUI();
            } else {
                // Lost the hand
                var lossAmount = gameState.bigBlind * 2; // Approximate loss
                addGameToHistory('loss', lossAmount, handName, 'Bot Game');
            }
            
            // Start new hand after delay
            setTimeout(function() {
                hideWinnerPopup();
                startNewHand();
            }, 5000);
        }

        // ═══════════════════════════════════════════════════
        // TIMER SYSTEM
        // ═══════════════════════════════════════════════════
        function startTurnTimer() {
            gameState.timeRemaining = 30;
            updateTimerDisplay();
            
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = setInterval(function() {
                gameState.timeRemaining--;
                updateTimerDisplay();
                
                if (gameState.timeRemaining <= 0) {
                    // Auto-action on timeout
                    var currentPlayer = getPlayer(gameState.currentPlayerSeat);
                    if (currentPlayer) {
                        if (currentPlayer.isHero) {
                            playerAction('fold'); // Auto-fold hero
                        } else {
                            aiAction(currentPlayer); // AI decides
                        }
                    }
                }
            }, 1000);
            
            // If not hero's turn, trigger AI action
            var currentPlayer = getPlayer(gameState.currentPlayerSeat);
            if (currentPlayer && !currentPlayer.isHero) {
                setTimeout(function() {
                    aiAction(currentPlayer);
                }, 1500 + Math.random() * 2000); // Random delay 1.5-3.5s
            }
        }

        function aiAction(player) {
            if (gameState.currentPlayerSeat !== player.seat) return;
            
            var callAmount = gameState.currentBet - player.bet;
            var random = Math.random();
            
            // Simple AI: 30% fold, 50% call, 20% raise
            if (callAmount > player.chips * 0.5 || random < 0.15) {
                // Fold if bet is too high or random fold
                doPlayerFold(player);
            } else if (random < 0.8) {
                // Call
                doPlayerCall(player);
            } else {
                // Raise
                var raiseAmount = gameState.currentBet + gameState.bigBlind * 2;
                doPlayerRaise(player, raiseAmount);
            }
        }

        // ═══════════════════════════════════════════════════
        // BET SLIDER & QUICK BETS
        // ═══════════════════════════════════════════════════
        var currentBetAmount = 20;
        var stackDisplayMode = 'chips'; // 'chips' or 'bb'
        
        function formatChips(amount, forceMode) {
            var mode = forceMode || stackDisplayMode;
            if (mode === 'bb') {
                var bb = (lastGameState && lastGameState.bigBlind) || gameState.bigBlind || 20;
                return Math.round(amount / bb * 10) / 10 + ' BB';
            }
            return amount.toLocaleString();
        }
        
        function toggleStackDisplay() {
            stackDisplayMode = stackDisplayMode === 'chips' ? 'bb' : 'chips';
            // Re-render UI
            if (lastGameState) {
                updateGameUI(lastGameState);
            }
        }

        function updateBetSlider(value) {
            currentBetAmount = parseInt(value);
            document.getElementById('betDisplay').textContent = formatChips(currentBetAmount);
            var actionName = (gameState.currentBet > 0 || (lastGameState && lastGameState.currentBet > 0)) ? 'Raise' : 'Bet';
            document.getElementById('raiseBtn').textContent = actionName + ' ' + formatChips(currentBetAmount);
        }
        
        function resetBetSlider() {
            // Reset slider to minimum (big blind) after making a bet
            var minBet = (lastGameState && lastGameState.bigBlind) || gameState.bigBlind || 20;
            currentBetAmount = minBet;
            var slider = document.getElementById('betSlider');
            if (slider) {
                slider.value = minBet;
            }
            document.getElementById('betDisplay').textContent = formatChips(minBet);
            document.getElementById('raiseBtn').textContent = 'Bet ' + formatChips(minBet);
        }

        function quickBet(multiplier) {
            var base = gameState.bigBlind;
            var newBet = Math.min(Math.floor(base * multiplier), getHero().chips);
            currentBetAmount = newBet;
            document.getElementById('betSlider').value = newBet;
            updateBetSlider(newBet);
            
            // Highlight active quick bet button
            document.querySelectorAll('.quick-bet-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ═══════════════════════════════════════════════════
        // PLAYER ACTIONS
        // ═══════════════════════════════════════════════════
        function playerAction(action) {
            addDebug('playerAction called: ' + action);
            
            // If in multiplayer game, use WebSocket
            if (currentGameSession && gameWebSocket) {
                addDebug('Sending multiplayer action: ' + action);
                var amount = 0;
                var serverAction = action;
                
                // Get current game state info
                var myPlayer = null;
                var currentBet = 0;
                if (lastGameState) {
                    currentBet = lastGameState.currentBet || 0;
                    if (mySeat && lastGameState.players) {
                        myPlayer = lastGameState.players.find(function(p) {
                            return parseInt(p.seat) === parseInt(mySeat);
                        });
                    }
                }
                var myCurrentBet = myPlayer ? (myPlayer.currentBet || 0) : 0;
                var callAmount = currentBet - myCurrentBet;
                
                // Convert actions for server and play sounds
                if (action === 'call') {
                    // Call sends the amount to match current bet
                    serverAction = 'call';
                    amount = callAmount;
                    addDebug('Call amount: ' + amount + ' (current bet: ' + currentBet + ', my bet: ' + myCurrentBet + ')');
                    if (amount > 0) playChipSound(); else playCheckSound();
                } else if (action === 'bet' || action === 'raise') {
                    serverAction = 'raise';  // BET is same as RAISE for server
                    // Amount is the TOTAL bet (not additional)
                    amount = currentBetAmount || (currentBet + 20);
                    addDebug('Raise to: ' + amount);
                    // Reset slider after bet/raise
                    resetBetSlider();
                    playChipSound();
                } else if (action === 'allin') {
                    serverAction = 'all_in';
                    playChipSound();
                } else if (action === 'fold') {
                    serverAction = 'fold';
                    playFoldSound();
                }
                
                addDebug('Server action: ' + serverAction + ', amount: ' + amount);
                sendGameAction(serverAction, amount);
                return;
            }
            
            // Fallback to local game logic
            var hero = getHero();
            if (!hero || gameState.currentPlayerSeat !== hero.seat) {
                addDebug('Not your turn!');
                return;
            }
            
            addDebug('Local action: ' + action);
            
            switch(action) {
                case 'fold':
                    showShowMuckModal(hero.cards);
                    doPlayerFold(hero);
                    break;
                case 'call':
                    doPlayerCall(hero);
                    break;
                case 'raise':
                    doPlayerRaise(hero, currentBetAmount);
                    break;
                case 'allin':
                    doPlayerRaise(hero, hero.chips + hero.bet);
                    break;
            }
        }

        function doPlayerFold(player) {
            player.status = 'folded';
            addDebug(player.name + ' folds');
            advanceToNextPlayer();
        }

        // ═══════════════════════════════════════════════════
        // SHOW/MUCK MODAL
        // ═══════════════════════════════════════════════════
        var showMuckTimeout = null;

        function showShowMuckModal(cards) {
            if (!cards || cards.length < 2) return;
            
            var modal = document.getElementById('showmuckModal');
            var cardsContainer = document.getElementById('showmuckCards');
            
            cardsContainer.innerHTML = cards.map(function(card) {
                return '<div class="hero-card ' + (isRed(card.suit) ? 'red' : 'black') + '">' +
                    '<span class="card-rank">' + card.rank + '</span>' +
                    '<span class="card-suit">' + card.suit + '</span>' +
                '</div>';
            }).join('');
            
            modal.classList.remove('hidden');
            
            // Auto-muck after 8 seconds
            showMuckTimeout = setTimeout(muckCards, 8000);
        }

        function showCards() {
            clearTimeout(showMuckTimeout);
            document.getElementById('showmuckModal').classList.add('hidden');
            addDebug('Cards shown!');
            // In real game: broadcast to other players
        }

        function muckCards() {
            clearTimeout(showMuckTimeout);
            document.getElementById('showmuckModal').classList.add('hidden');
            addDebug('Cards mucked');
        }

        // ═══════════════════════════════════════════════════
        // HAND STRENGTH HUD
        // ═══════════════════════════════════════════════════
        var handIcons = {
            'Royal Flush': '👑',
            'Straight Flush': '💎',
            'Four of a Kind': '🔥',
            'Full House': '🏠',
            'Flush': '♠️',
            'Straight': '📊',
            'Three of a Kind': '🎯',
            'Two Pair': '👥',
            'One Pair': '🎲',
            'High Card': '🃏'
        };

        function updateHandHUD() {
            var hero = getHero();
            // Use lastGameState for multiplayer, gameState for local
            var communityCards = (lastGameState && lastGameState.communityCards) 
                ? lastGameState.communityCards 
                : gameState.communityCards;
            
            if (!hero || !hero.cards || hero.cards.length < 2 || !communityCards || communityCards.length < 3) {
                document.getElementById('handHud').classList.add('hidden');
                return;
            }
            
            var allCards = hero.cards.concat(communityCards);
            var hand = evaluateHand(allCards);
            
            var hud = document.getElementById('handHud');
            hud.classList.remove('hidden', 'legendary', 'epic', 'rare');
            
            // Add rarity class
            if (hand.rank >= 9) hud.classList.add('legendary');
            else if (hand.rank >= 7) hud.classList.add('epic');
            else if (hand.rank >= 5) hud.classList.add('rare');
            
            document.getElementById('handIcon').textContent = handIcons[hand.name] || '🃏';
            document.getElementById('handRank').textContent = hand.name;
            document.getElementById('handDesc').textContent = getHandDescription(hand);
        }

        function getHandDescription(hand) {
            if (!hand.cards || hand.cards.length === 0) return '';
            var highCard = hand.cards[0];
            return RANK_NAMES[RANK_VALUES[highCard.rank]] + ' high';
        }

        function doPlayerCall(player) {
            var callAmount = Math.min(gameState.currentBet - player.bet, player.chips);
            
            if (callAmount === 0) {
                addDebug(player.name + ' checks');
            } else {
                player.chips -= callAmount;
                player.bet += callAmount;
                gameState.pot += callAmount;
                addDebug(player.name + ' calls $' + callAmount);
            }
            
            updateGameUI();
            advanceToNextPlayer();
        }

        function doPlayerRaise(player, totalBet) {
            var raiseAmount = Math.min(totalBet - player.bet, player.chips);
            
            player.chips -= raiseAmount;
            player.bet += raiseAmount;
            gameState.pot += raiseAmount;
            gameState.currentBet = player.bet;
            
            addDebug(player.name + ' raises to $' + player.bet);
            
            updateGameUI();
            advanceToNextPlayer();
        }

        function advanceToNextPlayer() {
            clearInterval(gameState.timerInterval);
            
            // Check if only one player left
            var activePlayers = getActivePlayers();
            if (activePlayers.length <= 1) {
                showdown();
                return;
            }
            
            // Check if betting round is complete
            if (isBettingRoundComplete()) {
                advancePhase();
                return;
            }
            
            // Next player
            gameState.currentPlayerSeat = getNextActiveSeat(gameState.currentPlayerSeat);
            updateGameUI();
            startTurnTimer();
        }

        function isBettingRoundComplete() {
            var activePlayers = getActivePlayers();
            return activePlayers.every(function(p) {
                return p.bet === gameState.currentBet || p.chips === 0;
            });
        }

        // ═══════════════════════════════════════════════════
        // UI UPDATES
        // ═══════════════════════════════════════════════════
        function updateGameUI() {
            // Update pot (center)
            document.getElementById('potAmount').textContent = '$' + gameState.pot;
            
            // Update players
            renderPlayersOnTable();
            
            // Update action buttons
            updateActionButtons();
            
            // Update bet slider limits
            updateBetSliderLimits();
            
            // Update hand HUD
            updateHandHUD();
        }

        function updatePhaseDisplay() {
            var phaseNames = {
                'waiting': 'WAITING',
                'preflop': 'PRE-FLOP',
                'flop': 'FLOP',
                'turn': 'TURN',
                'river': 'RIVER',
                'showdown': 'SHOWDOWN'
            };
            
            // Update game phase indicator (new floating indicator)
            updateGamePhaseIndicator(gameState.phase);
            
            // Also update header blinds
            var phaseEl = document.getElementById('tableInfoBlinds');
            if (phaseEl) {
                phaseEl.textContent = 'Blinds: ' + gameState.smallBlind + '/' + gameState.bigBlind;
            }
        }

        function updateTimerDisplay() {
            var currentPlayer = getPlayer(gameState.currentPlayerSeat);
            if (!currentPlayer) return;
            
            // Visual indicator on active player
            renderPlayersOnTable();
        }

        function updateBetSliderLimits() {
            var hero = getHero();
            if (!hero) return;
            
            var slider = document.getElementById('betSlider');
            var gs = lastGameState || gameState;
            
            // Use minRaiseTo from server if available, otherwise calculate
            var minBet = gs.minRaiseTo || gs.bigBlind || 20;
            
            slider.min = minBet;
            slider.max = hero.chips + (hero.currentBet || 0); // Max is all-in total
            
            // Ensure current bet is within limits
            if (currentBetAmount < minBet) {
                currentBetAmount = minBet;
                slider.value = currentBetAmount;
                updateBetSlider(currentBetAmount);
            }
        }

        function updateCommunityCards() {
            var container = document.getElementById('communityCards');
            var html = '';
            
            // Get hero's winning combo cards (if any) for highlighting
            var comboCardKeys = getComboCardKeys();
            
            gameState.communityCards.forEach(function(card, index) {
                // Check if this card is part of the winning combo
                var cardKey = card.rank + card.suit;
                var isComboCard = comboCardKeys.indexOf(cardKey) !== -1;
                var comboClass = isComboCard ? ' combo-card' : '';
                
                // Add flip animation class for new cards
                var animClass = 'card-container';
                html += '<div class="' + animClass + '">' +
                    '<div class="card ' + (isRed(card.suit) ? 'red' : 'black') + comboClass + '">' +
                        '<span class="card-rank">' + card.rank + '</span>' +
                        '<span class="card-suit">' + card.suit + '</span>' +
                    '</div>' +
                '</div>';
            });
            
            // NO hidden placeholders - only show actual dealt cards
            // This fixes the PRE-FLOP bug where 5 cards were shown
            
            container.innerHTML = html;
            
            // Update hand HUD after community cards change
            updateHandHUD();
            
            // Update hero cards highlighting when community cards change
            updateHeroCardsHighlight();
        }
        
        // Update hero cards to show combo highlighting
        function updateHeroCardsHighlight() {
            var hero = getHero();
            if (!hero || !hero.cards || hero.cards.length < 2) return;
            
            var heroCardsEl = document.getElementById('heroCards');
            var comboCardKeys = getComboCardKeys();
            
            heroCardsEl.innerHTML = hero.cards.map(function(card) {
                var cardKey = card.rank + card.suit;
                var isComboCard = comboCardKeys.indexOf(cardKey) !== -1;
                var comboClass = isComboCard ? ' combo-card' : '';
                
                return '<div class="hero-card ' + (isRed(card.suit) ? 'red' : 'black') + comboClass + '">' +
                    '<span class="card-rank">' + card.rank + '</span>' +
                    '<span class="card-suit">' + card.suit + '</span>' +
                '</div>';
            }).join('');
        }
        
        // Get card keys that form the winning combination for hero
        // ONLY highlights cards for REAL combinations (not HIGH CARD)
        function getComboCardKeys() {
            var hero = getHero();
            if (!hero || !hero.cards || hero.cards.length < 2 || gameState.communityCards.length < 3) {
                return [];
            }
            
            var allCards = hero.cards.concat(gameState.communityCards);
            var hand = evaluateHand(allCards);
            
            if (!hand || !hand.cards) return [];
            
            // DON'T highlight for HIGH CARD (rank 1) - only real combinations
            // Rank 1 = High Card, Rank 2 = One Pair, Rank 3 = Two Pair, etc.
            if (hand.rank <= 1) {
                return []; // No highlighting for High Card
            }
            
            // Return keys of cards in the winning combo
            return hand.cards.map(function(c) { return c.rank + c.suit; });
        }

        function updateActionButtons() {
            var hero = getHero();
            var isMyTurn = hero && gameState.currentPlayerSeat === hero.seat;
            var callAmount = gameState.currentBet - (hero ? hero.bet : 0);
            
            // Update call button
            var callBtn = document.getElementById('callBtn');
            if (callBtn) {
                callBtn.textContent = callAmount > 0 ? 'Call ' + formatChips(callAmount) : 'Check';
                callBtn.className = 'action-btn ' + (callAmount > 0 ? 'call' : 'check');
                callBtn.disabled = !isMyTurn;
            }
            
            // Update raise button
            var raiseBtn = document.getElementById('raiseBtn');
            if (raiseBtn) {
                var actionName = gameState.currentBet > 0 ? 'Raise' : 'Bet';
                raiseBtn.textContent = actionName + ' ' + formatChips(currentBetAmount);
                raiseBtn.disabled = !isMyTurn;
            }
            
            // Enable/disable all buttons
            var buttons = document.querySelectorAll('#actionButtons .action-btn');
            buttons.forEach(function(btn) {
                btn.disabled = !isMyTurn;
            });
            
            // Controls container
            var controls = document.getElementById('bettingControls');
            if (controls) {
                controls.classList.toggle('disabled', !isMyTurn);
            }
        }

        function renderPlayersOnTable() {
            var container = document.getElementById('playerSeats');
            var html = '';
            
            // Portrait positions for 6-max
            var positions = ['seat-0', 'seat-1', 'seat-2', 'seat-3', 'seat-4', 'seat-5'];
            var playerIndex = 0;
            
            gameState.players.forEach(function(player) {
                if (player.isHero) return; // Hero is in bottom controls
                
                var avatarClass = 'player-avatar';
                if (player.status === 'folded') avatarClass += ' folded';
                if (player.seat === gameState.dealerSeat) avatarClass += ' dealer';
                if (player.seat === gameState.currentPlayerSeat) avatarClass += ' active';
                
                var timerHtml = '';
                if (player.seat === gameState.currentPlayerSeat) {
                    timerHtml = '<div class="player-timer">' + gameState.timeRemaining + 's</div>';
                }
                
                // Use portrait position based on player index (skip 0 which is hero)
                var positionClass = positions[(playerIndex % 5) + 1];
                playerIndex++;
                
                html += '<div class="player-seat ' + positionClass + '">' +
                    '<div class="player-card-container">' +
                        '<div class="' + avatarClass + '">' + player.name.charAt(0) + timerHtml + '</div>' +
                        '<div class="player-name">' + player.name + '</div>' +
                        '<div class="player-chips" onclick="toggleStackDisplay()">' + formatChips(player.chips) + '</div>' +
                        (player.bet > 0 ? '<div class="player-bet">' + formatChips(player.bet) + '</div>' : '') +
                        '<div class="player-cards"><div class="player-card"></div><div class="player-card"></div></div>' +
                    '</div>' +
                '</div>';
            });
            
            container.innerHTML = html;
        }

        function showWinnerPopup(winner, handName, amount) {
            var popup = document.createElement('div');
            popup.id = 'winnerPopup';
            popup.className = 'winner-popup';
            popup.innerHTML = 
                '<div class="winner-badge">' +
                    '<div class="winner-icon">🏆</div>' +
                    '<div class="winner-name">' + winner.name + ' wins!</div>' +
                    '<div class="winner-hand">' + handName + '</div>' +
                    '<div class="winner-amount">+$' + amount + '</div>' +
                '</div>';
            document.body.appendChild(popup);
        }

        function hideWinnerPopup() {
            var popup = document.getElementById('winnerPopup');
            if (popup) popup.remove();
        }

        function leaveTable() {
            addDebug('Leave table');
            clearInterval(gameState.timerInterval);
            gameState.phase = 'waiting';
            // Resume background music when leaving game
            startBgMusic();
            // Smooth transition back to lobby
            showScreen('lobbyScreen', ['pokerTableScreen']);
        }

        // ═══════════════════════════════════════════════════
        // BUTTON HANDLERS
        // ═══════════════════════════════════════════════════
        function showAlert(msg) {
            if (tg && tg.showAlert) {
                tg.showAlert(msg);
            } else {
                alert(msg);
            }
        }

        function handleHistory() {
            addDebug('Opening History');
            openHistory();
        }

        function handleSettings() {
            addDebug('Opening Settings');
            openSettings();
        }

        // ═══════════════════════════════════════════════════
        // WALLET MODAL FUNCTIONS
        // ═══════════════════════════════════════════════════
        var currentWalletTab = 'deposit';
        var walletBackButtonHandler = null;

        function openWalletModal(tab) {
            tab = tab || 'deposit';
            addDebug('Opening Wallet Modal: ' + tab);
            
            var modal = document.getElementById('walletModal');
            if (modal) {
                modal.classList.remove('hidden');
                switchWalletTab(tab);
                
                // Update balance display
                var balanceEl = document.getElementById('walletBalance');
                if (balanceEl) {
                    balanceEl.textContent = userBalance.toLocaleString();
                }
                
                // Show Telegram BackButton
                if (tg && tg.BackButton) {
                    // Remove previous handler if exists
                    if (walletBackButtonHandler) {
                        tg.BackButton.offClick(walletBackButtonHandler);
                    }
                    // Set new handler
                    walletBackButtonHandler = function() {
                        closeWalletModal();
                    };
                    tg.BackButton.onClick(walletBackButtonHandler);
                    tg.BackButton.show();
                    addDebug('TG BackButton shown');
                }
            }
        }

        function closeWalletModal() {
            addDebug('Closing Wallet Modal');
            var modal = document.getElementById('walletModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            
            // Hide Telegram BackButton
            if (tg && tg.BackButton) {
                tg.BackButton.hide();
                if (walletBackButtonHandler) {
                    tg.BackButton.offClick(walletBackButtonHandler);
                    walletBackButtonHandler = null;
                }
                addDebug('TG BackButton hidden');
            }
        }

        function switchWalletTab(tab) {
            currentWalletTab = tab;
            addDebug('Switching to wallet tab: ' + tab);
            
            // Update tab buttons
            document.getElementById('tabDeposit').classList.remove('active');
            document.getElementById('tabWithdraw').classList.remove('active');
            document.getElementById('tabHistory').classList.remove('active');
            
            if (tab === 'deposit') {
                document.getElementById('tabDeposit').classList.add('active');
            } else if (tab === 'withdraw') {
                document.getElementById('tabWithdraw').classList.add('active');
            } else if (tab === 'history') {
                document.getElementById('tabHistory').classList.add('active');
            }
            
            // Update content visibility
            document.getElementById('walletDepositContent').style.display = tab === 'deposit' ? 'block' : 'none';
            document.getElementById('walletWithdrawContent').style.display = tab === 'withdraw' ? 'block' : 'none';
            document.getElementById('walletHistoryContent').style.display = tab === 'history' ? 'block' : 'none';
        }

        function selectPaymentMethod(method) {
            addDebug('Selected deposit method: ' + method);
            // TODO: Implement payment flow
            alert('Депозит через ' + method + ' скоро будет доступен!');
        }

        function selectWithdrawMethod(method) {
            addDebug('Selected withdraw method: ' + method);
            // TODO: Implement withdraw flow
            var amount = document.getElementById('withdrawAmount').value;
            if (!amount || amount <= 0) {
                alert('Введите сумму для вывода');
                return;
            }
            alert('Вывод ' + amount + '₽ через ' + method + ' скоро будет доступен!');
        }

        function showMoreMethods() {
            addDebug('Show more payment methods');
            alert('Дополнительные методы оплаты скоро будут доступны!');
        }

        function handleDeposit() {
            addDebug('Opening Deposit');
            openWalletModal('deposit');
        }

        function handleWithdraw() {
            addDebug('Opening Withdraw');
            openWalletModal('withdraw');
        }

        // ═══════════════════════════════════════════════════
        // SETTINGS MODAL FUNCTIONS
        // ═══════════════════════════════════════════════════
        var userSettings = {
            musicEnabled: false,
            sfxEnabled: true,
            neonTheme: true  // Neon theme enabled by default
        };

        // Load settings from localStorage
        function loadSettings() {
            try {
                var saved = localStorage.getItem('pokerSettings');
                if (saved) {
                    var parsed = JSON.parse(saved);
                    // Merge with defaults (ensures new settings like neonTheme have default values)
                    userSettings = Object.assign({
                        musicEnabled: false,
                        sfxEnabled: true,
                        neonTheme: true
                    }, parsed);
                }
            } catch (e) {
                addDebug('Error loading settings: ' + e);
            }
            updateSettingsUI();
        }

        // Save settings to localStorage
        function saveSettings() {
            try {
                localStorage.setItem('pokerSettings', JSON.stringify(userSettings));
            } catch (e) {
                addDebug('Error saving settings: ' + e);
            }
        }

        function openSettings() {
            loadSettings();
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function updateSettingsUI() {
            var musicToggle = document.getElementById('musicToggle');
            var sfxToggle = document.getElementById('sfxToggle');
            var neonToggle = document.getElementById('neonToggle');
            
            if (musicToggle) {
                if (userSettings.musicEnabled) {
                    musicToggle.classList.add('active');
                } else {
                    musicToggle.classList.remove('active');
                }
            }
            
            if (sfxToggle) {
                if (userSettings.sfxEnabled) {
                    sfxToggle.classList.add('active');
                } else {
                    sfxToggle.classList.remove('active');
                }
            }
            
            if (neonToggle) {
                if (userSettings.neonTheme) {
                    neonToggle.classList.add('active');
                } else {
                    neonToggle.classList.remove('active');
                }
            }
            
            // Apply theme to body
            applyTheme();
        }

        function toggleMusic() {
            userSettings.musicEnabled = !userSettings.musicEnabled;
            saveSettings();
            updateSettingsUI();
            
            if (userSettings.musicEnabled) {
                // Start background music
                playBgMusic();
            } else {
                // Stop background music
                stopBgMusic();
            }
        }

        function toggleSFX() {
            userSettings.sfxEnabled = !userSettings.sfxEnabled;
            saveSettings();
            updateSettingsUI();
            // No alert - just visual toggle feedback
        }

        function toggleNeonTheme() {
            userSettings.neonTheme = !userSettings.neonTheme;
            saveSettings();
            updateSettingsUI();
        }

        function applyTheme() {
            if (userSettings.neonTheme) {
                document.body.classList.add('neon-theme');
            } else {
                document.body.classList.remove('neon-theme');
            }
        }

        // ═══════════════════════════════════════════════════
        // HISTORY MODAL FUNCTIONS
        // ═══════════════════════════════════════════════════
        var gameHistory = [];

        function loadGameHistory() {
            try {
                var saved = localStorage.getItem('pokerHistory');
                if (saved) {
                    gameHistory = JSON.parse(saved);
                }
            } catch (e) {
                addDebug('Error loading history: ' + e);
                gameHistory = [];
            }
        }

        function saveGameHistory() {
            try {
                // Keep only last 50 games
                if (gameHistory.length > 50) {
                    gameHistory = gameHistory.slice(-50);
                }
                localStorage.setItem('pokerHistory', JSON.stringify(gameHistory));
            } catch (e) {
                addDebug('Error saving history: ' + e);
            }
        }

        function addGameToHistory(result, amount, handName, gameType) {
            var game = {
                id: Date.now(),
                result: result, // 'win' or 'loss'
                amount: amount,
                handName: handName || 'Unknown',
                gameType: gameType || 'Cash Game',
                date: new Date().toISOString()
            };
            gameHistory.push(game);
            saveGameHistory();
        }

        function openHistory() {
            loadGameHistory();
            renderHistory();
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        function renderHistory() {
            var listEl = document.getElementById('historyList');
            
            // Calculate stats
            var totalGames = gameHistory.length;
            var wins = gameHistory.filter(function(g) { return g.result === 'win'; }).length;
            var losses = totalGames - wins;
            var profit = gameHistory.reduce(function(sum, g) {
                return sum + (g.result === 'win' ? g.amount : -g.amount);
            }, 0);
            
            // Update stats display
            document.getElementById('historyTotalGames').textContent = totalGames;
            document.getElementById('historyWins').textContent = wins;
            document.getElementById('historyLosses').textContent = losses;
            
            var profitEl = document.getElementById('historyProfit');
            profitEl.textContent = (profit >= 0 ? '+' : '') + '$' + profit.toLocaleString();
            profitEl.className = 'history-stat-value ' + (profit >= 0 ? 'wins' : 'losses');
            
            // Render list
            if (gameHistory.length === 0) {
                listEl.innerHTML = 
                    '<div class="history-empty">' +
                        '<div class="history-empty-icon">🎰</div>' +
                        '<div class="history-empty-text">No games yet</div>' +
                        '<div class="history-empty-hint">Play some poker to see your history!</div>' +
                    '</div>';
                return;
            }
            
            // Render games (newest first)
            var html = '';
            var sortedHistory = gameHistory.slice().reverse();
            
            sortedHistory.forEach(function(game) {
                var date = new Date(game.date);
                var dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                var isWin = game.result === 'win';
                
                html += 
                    '<div class="history-item ' + game.result + '">' +
                        '<div class="history-item-header">' +
                            '<span class="history-item-result ' + game.result + '">' + 
                                (isWin ? '🏆 WIN' : '❌ LOSS') + 
                            '</span>' +
                            '<span class="history-item-date">' + dateStr + '</span>' +
                        '</div>' +
                        '<div class="history-item-details">' +
                            '<span>' + game.gameType + '</span>' +
                            '<span>🃏 ' + game.handName + '</span>' +
                            '<span class="history-item-amount ' + (isWin ? 'positive' : 'negative') + '">' +
                                (isWin ? '+' : '-') + '$' + game.amount.toLocaleString() +
                            '</span>' +
                        '</div>' +
                    '</div>';
            });
            
            listEl.innerHTML = html;
        }

        // ═══════════════════════════════════════════════════
        // PRIVATE GAME MODAL FUNCTIONS
        // ═══════════════════════════════════════════════════
        var currentPrivateLobby = null;

        function openPrivateGameModal() {
            addDebug('Open Private Game Modal');
            document.getElementById('privateGameModal').classList.remove('hidden');
            resetPrivateGameModal();
        }

        function closePrivateGameModal(resetLobby) {
            document.getElementById('privateGameModal').classList.add('hidden');
            // Only reset lobby if explicitly requested (e.g., user clicked X button)
            if (resetLobby === true) {
                currentPrivateLobby = null;
            }
            // Reset tabs visibility
            document.querySelector('.private-game-tabs').style.display = 'flex';
        }

        function resetPrivateGameModal() {
            // Show create view, hide others
            document.getElementById('createLobbyView').classList.remove('hidden');
            document.getElementById('joinLobbyView').classList.add('hidden');
            document.getElementById('lobbyCreatedView').classList.add('hidden');
            
            // Reset tabs
            var tabs = document.querySelectorAll('.pg-tab');
            tabs.forEach(function(t, i) {
                if (i === 0) t.classList.add('active');
                else t.classList.remove('active');
            });
            
            // Reset form
            document.getElementById('lobbyCodeInput').value = '';
        }

        function switchPrivateTab(tab, btn) {
            var tabs = document.querySelectorAll('.pg-tab');
            tabs.forEach(function(t) { t.classList.remove('active'); });
            btn.classList.add('active');
            
            if (tab === 'create') {
                document.getElementById('createLobbyView').classList.remove('hidden');
                document.getElementById('joinLobbyView').classList.add('hidden');
                document.getElementById('lobbyCreatedView').classList.add('hidden');
            } else {
                document.getElementById('createLobbyView').classList.add('hidden');
                document.getElementById('joinLobbyView').classList.remove('hidden');
                document.getElementById('lobbyCreatedView').classList.add('hidden');
            }
        }

        function generateLobbyCode() {
            var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            var code = '';
            for (var i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        async function createPrivateLobby() {
            var buyIn = document.getElementById('buyInSelect').value;
            var maxPlayers = document.getElementById('maxPlayersSelect').value;
            var smallBlind = document.getElementById('smallBlindSelect').value;
            var bigBlind = document.getElementById('bigBlindSelect').value;
            
            addDebug('Creating lobby on server...');
            
            try {
                // Call server API to create lobby
                var response = await fetch(API_BASE + '/api/lobby/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        buyIn: parseInt(buyIn),
                        maxPlayers: parseInt(maxPlayers),
                        initData: tg ? tg.initData : ''
                    })
                });
                
                if (!response.ok) {
                    var errData = await response.json().catch(function() { return {}; });
                    throw new Error(errData.detail || 'Failed to create lobby');
                }
                
                var data = await response.json();
                var lobbyCode = data.lobbyCode;
                
                addDebug('Server created lobby: ' + lobbyCode);
                
                currentPrivateLobby = {
                    code: lobbyCode,
                    buyIn: parseInt(buyIn),
                    maxPlayers: parseInt(maxPlayers),
                    smallBlind: parseInt(smallBlind),
                    bigBlind: parseInt(bigBlind),
                    players: [{ name: userName, isHost: true }],
                    serverData: data.lobby,
                    isHost: true  // Creator is the host
                };
                
                // Update UI with server code
                document.getElementById('createdLobbyCode').textContent = lobbyCode;
                document.getElementById('summaryBuyIn').textContent = '$' + parseInt(buyIn).toLocaleString();
                document.getElementById('summaryBlinds').textContent = '$' + smallBlind + '/$' + bigBlind;
                document.getElementById('summaryPlayers').textContent = maxPlayers;
                document.getElementById('maxPlayersCount').textContent = maxPlayers;
                document.getElementById('hostChip').textContent = '👑 ' + userName + ' (Host)';
                
                // Show created view
                document.getElementById('createLobbyView').classList.add('hidden');
                document.getElementById('lobbyCreatedView').classList.remove('hidden');
                
                // Hide tabs when lobby is created
                document.querySelector('.private-game-tabs').style.display = 'none';
                
            } catch (err) {
                addDebug('Create lobby error: ' + err.message);
                showAlert('⚠️ Failed to create lobby: ' + err.message);
            }
        }

        async function joinPrivateLobby() {
            var code = document.getElementById('lobbyCodeInput').value.toUpperCase().trim();
            
            if (code.length !== 6) {
                showAlert('⚠️ Please enter a valid 6-character lobby code');
                return;
            }
            
            addDebug('Joining lobby via API: ' + code);
            
            try {
                // First get lobby info from server
                var lobbyResponse = await fetch(API_BASE + '/api/lobby/' + code);
                
                if (!lobbyResponse.ok) {
                    var errData = await lobbyResponse.json().catch(function() { return {}; });
                    throw new Error(errData.detail || 'Lobby not found');
                }
                
                var lobbyData = await lobbyResponse.json();
                addDebug('Found lobby on server');
                
                // Join the lobby - send initData and fallback user info
                var joinBody = {
                    initData: tg ? tg.initData : ''
                };
                // Add fallback user info if available from Telegram WebApp
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    joinBody.telegramId = tg.initDataUnsafe.user.id;
                    joinBody.firstName = tg.initDataUnsafe.user.first_name;
                    joinBody.username = tg.initDataUnsafe.user.username;
                }
                
                var joinResponse = await fetch(API_BASE + '/api/lobby/' + code + '/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(joinBody)
                });
                
                if (!joinResponse.ok) {
                    var joinErr = await joinResponse.json().catch(function() { return {}; });
                    throw new Error(joinErr.detail || 'Failed to join lobby');
                }
                
                var joinData = await joinResponse.json();
                var serverLobby = joinData.lobby;
                
                addDebug('Joined lobby successfully');
                
                // Convert server players to our format
                var players = [];
                if (serverLobby.players) {
                    for (var playerId in serverLobby.players) {
                        var p = serverLobby.players[playerId];
                        players.push({
                            name: p.first_name || p.username || 'Player',
                            isHost: p.is_host
                        });
                    }
                }
                
                currentPrivateLobby = {
                    code: code,
                    buyIn: serverLobby.buy_in || 1000,
                    maxPlayers: serverLobby.max_players || 6,
                    smallBlind: 10,
                    bigBlind: 20,
                    players: players,
                    serverData: serverLobby,
                    isHost: false  // Guest joining
                };
                
                // Close modal and go to waiting room (NOT start game!)
                closePrivateGameModal();
                
                // Connect to WebSocket for real-time updates
                connectToLobbyWebSocket(code);
                
                // Show waiting room with smooth transition
                updateWaitingRoomUI();
                showScreen('waitingRoomScreen', ['mainMenu', 'lobbyScreen']);
                
            } catch (err) {
                addDebug('Join lobby error: ' + err.message);
                showAlert('⚠️ ' + err.message);
            }
        }

        function inviteViaTelegram() {
            if (!currentPrivateLobby) return;
            
            var lobbyCode = currentPrivateLobby.code;
            var botUsername = 'pokerhouse77bot';
            
            // Use bot start link - bot will redirect to Mini App with the lobby code
            // Format: https://t.me/botusername?start=lobby_CODE
            var inviteLink = 'https://t.me/' + botUsername + '?start=lobby_' + lobbyCode;
            
            var message = '🎰 Join my Private Poker Game!\n\n' +
                '📍 Lobby Code: ' + lobbyCode + '\n' +
                '💰 Buy-in: $' + currentPrivateLobby.buyIn.toLocaleString() + '\n' +
                '🎯 Blinds: $' + currentPrivateLobby.smallBlind + '/$' + currentPrivateLobby.bigBlind + '\n\n' +
                '👇 Click to join:';
            
            addDebug('Invite via Telegram: ' + lobbyCode + ', link: ' + inviteLink);
            
            // Build share URL
            var shareUrl = 'https://t.me/share/url?url=' + encodeURIComponent(inviteLink) + '&text=' + encodeURIComponent(message);
            
            // Check if running inside Telegram Mini App
            var isTelegramWebApp = tg && tg.initData && tg.initData.length > 0;
            
            if (isTelegramWebApp && tg.openTelegramLink) {
                // Inside Telegram - use native share
                tg.openTelegramLink(shareUrl);
            } else {
                // Desktop/Browser - always open in new tab
                // Use window.open with specific features to ensure new tab
                var newWindow = window.open(shareUrl, '_blank', 'noopener,noreferrer');
                
                // Fallback if popup was blocked
                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                    // Create a temporary link and click it
                    var link = document.createElement('a');
                    link.href = shareUrl;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        }

        function copyLobbyLink() {
            if (!currentPrivateLobby) return;
            
            var lobbyCode = currentPrivateLobby.code;
            var botUsername = 'pokerhouse77bot';
            
            // Use bot start link - bot will show join button
            var inviteLink = 'https://t.me/' + botUsername + '?start=lobby_' + lobbyCode;
            
            // Copy to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(inviteLink).then(function() {
                    showAlert('📋 Invite link copied!\n\n' + inviteLink);
                }).catch(function() {
                    showAlert('📋 Lobby Code: ' + lobbyCode + '\n\nShare this code with friends!');
                });
            } else {
                // Fallback
                showAlert('📋 Lobby Code: ' + lobbyCode + '\n\nShare this code with friends!');
            }
        }

        function startPrivateGame() {
            if (!currentPrivateLobby) {
                showAlert('⚠️ No lobby to start');
                return;
            }
            
            addDebug('Starting private game: ' + currentPrivateLobby.code);
            
            // Set game state from lobby settings
            gameState.smallBlind = currentPrivateLobby.smallBlind;
            gameState.bigBlind = currentPrivateLobby.bigBlind;
            
            // Smooth transition to poker table
            showScreen('pokerTableScreen', ['mainMenu', 'lobbyScreen', 'waitingRoomScreen']);
            
            // Update table info
            document.getElementById('tableInfoName').textContent = 'Private: ' + currentPrivateLobby.code;
            document.getElementById('tableInfoBlinds').textContent = 'Blinds: ' + gameState.smallBlind + '/' + gameState.bigBlind;
        }

        // ═══════════════════════════════════════════════════
        // WAITING ROOM FUNCTIONS
        // ═══════════════════════════════════════════════════
        function goToWaitingRoom() {
            if (!currentPrivateLobby) {
                showAlert('⚠️ No lobby created');
                return;
            }
            
            addDebug('Going to waiting room: ' + currentPrivateLobby.code);
            
            // Close modal
            closePrivateGameModal();
            
            // Connect to WebSocket for real-time updates
            connectToLobbyWebSocket(currentPrivateLobby.code);
            
            // Update waiting room UI
            updateWaitingRoomUI();
            
            // Show waiting room with smooth transition
            showScreen('waitingRoomScreen', ['mainMenu', 'lobbyScreen']);
        }

        function updateWaitingRoomUI() {
            if (!currentPrivateLobby) {
                addDebug('updateWaitingRoomUI: no lobby!');
                return;
            }
            
            addDebug('Updating UI with code: ' + currentPrivateLobby.code);
            
            var codeEl = document.getElementById('waitingLobbyCode');
            if (codeEl) {
                codeEl.textContent = currentPrivateLobby.code;
                addDebug('Set code element to: ' + currentPrivateLobby.code);
            } else {
                addDebug('ERROR: waitingLobbyCode element not found!');
            }
            document.getElementById('waitingBuyIn').textContent = '$' + currentPrivateLobby.buyIn.toLocaleString();
            document.getElementById('waitingBlinds').textContent = '$' + currentPrivateLobby.smallBlind + '/$' + currentPrivateLobby.bigBlind;
            document.getElementById('waitingMaxPlayers').textContent = currentPrivateLobby.maxPlayers;
            
            var players = currentPrivateLobby.players || [];
            var maxPlayers = currentPrivateLobby.maxPlayers || 6;
            
            document.getElementById('waitingPlayersCount').textContent = players.length + '/' + maxPlayers;
            
            // Render player slots
            var grid = document.getElementById('waitingPlayersGrid');
            var html = '';
            
            for (var i = 0; i < maxPlayers; i++) {
                var player = players[i];
                if (player) {
                    var slotClass = player.isHost ? 'waiting-player-slot host' : 'waiting-player-slot occupied';
                    html += '<div class="' + slotClass + '">' +
                        '<div class="waiting-player-avatar">' + (player.isHost ? '👑' : player.name.charAt(0)) + '</div>' +
                        '<div class="waiting-player-name">' + player.name + (player.isHost ? ' (Host)' : '') + '</div>' +
                    '</div>';
                } else {
                    html += '<div class="waiting-player-slot empty">' +
                        '<div class="waiting-player-avatar">?</div>' +
                        '<div class="waiting-player-name">Empty</div>' +
                    '</div>';
                }
            }
            
            grid.innerHTML = html;
            
            // Update start button state based on host status
            var startBtn = document.getElementById('waitingStartBtn');
            var statusEl = document.getElementById('waitingStatus');
            var isHost = currentPrivateLobby.isHost === true;
            
            // Only host can see and use Start button
            if (isHost) {
                startBtn.style.display = 'flex';
                if (players.length >= 2) {
                    startBtn.disabled = false;
                    statusEl.className = 'waiting-status ready';
                    statusEl.innerHTML = '✅ Ready to start!';
                } else {
                    startBtn.disabled = true;
                    statusEl.className = 'waiting-status';
                    statusEl.innerHTML = '<span class="waiting-dot">⏳</span> Waiting for players to join...';
                }
            } else {
                // Guest - hide start button, show waiting message
                startBtn.style.display = 'none';
                statusEl.className = 'waiting-status';
                statusEl.innerHTML = '<span class="waiting-dot">⏳</span> Waiting for host to start the game...';
            }
        }

        function leaveWaitingRoom() {
            // Smooth transition back to main menu
            showScreen('mainMenu', ['waitingRoomScreen']);
            currentPrivateLobby = null;
        }

        async function startGameFromWaitingRoom() {
            if (!currentPrivateLobby) return;
            
            addDebug('Starting game from waiting room...');
            
            try {
                // Call server API to start game
                var response = await fetch(API_BASE + '/api/lobby/' + currentPrivateLobby.code + '/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg ? tg.initData : ''
                    })
                });
                
                if (!response.ok) {
                    var errData = await response.json().catch(function() { return {}; });
                    throw new Error(errData.detail || 'Failed to start game');
                }
                
                var data = await response.json();
                addDebug('Game started on server: ' + data.gameSessionId);
                
                // Server will broadcast 'gameStarted' via WebSocket
                // which will trigger startPrivateGame() for all players
                // But host can also start immediately
                startMultiplayerGame(data.gameSessionId);
                
            } catch (err) {
                addDebug('Start game error: ' + err.message);
                showAlert('⚠️ ' + err.message);
            }
        }
        
        var gameWebSocket = null;
        var currentGameSession = null;
        var mySeat = null;  // My seat number (1-based)
        var lastGameState = null;  // Store last game state for action calculations
        
        function startMultiplayerGame(gameSessionId) {
            addDebug('Starting multiplayer game: ' + gameSessionId);
            currentGameSession = gameSessionId;
            
            // Stop background music when game starts
            stopBgMusic();
            
            // Smooth transition from waiting room to poker table
            showScreen('pokerTableScreen', ['waitingRoomScreen']);
            
            var tableNameEl = document.getElementById('tableName');
            if (tableNameEl) {
                tableNameEl.textContent = 'Multiplayer: ' + (currentPrivateLobby ? currentPrivateLobby.code : '');
            }
            
            // Connect to game WebSocket after transition starts
            setTimeout(function() {
                connectToGameWebSocket(gameSessionId);
            }, 300);
            
            // Play card dealing sounds
            setTimeout(function() {
                playCardSound();
                setTimeout(function() { playCardSound(); }, 200);
            }, 500);
            
            addDebug('Multiplayer game screen shown');
        }
        
        function connectToGameWebSocket(sessionId) {
            if (gameWebSocket) {
                gameWebSocket.close();
            }
            
            // Include telegram_id so server can identify the player and assign correct seat
            var tgId = telegramUserId || 0;
            var wsUrl = API_BASE.replace('https://', 'wss://').replace('http://', 'ws://') + '/ws/game/' + sessionId + '?telegram_id=' + tgId;
            addDebug('Connecting to game WS with telegram_id=' + tgId);
            
            try {
                gameWebSocket = new WebSocket(wsUrl);
                
                gameWebSocket.onopen = function() {
                    addDebug('Game WebSocket connected, waiting for seat assignment');
                };
                
                gameWebSocket.onmessage = function(event) {
                    try {
                        var data = JSON.parse(event.data);
                        addDebug('Game WS: ' + data.type);
                        handleGameEvent(data);
                    } catch (e) {
                        addDebug('Game WS parse error: ' + e.message);
                    }
                };
                
                gameWebSocket.onclose = function() {
                    addDebug('Game WebSocket closed');
                };
                
                gameWebSocket.onerror = function(err) {
                    addDebug('Game WebSocket error');
                };
            } catch (e) {
                addDebug('Game WS connection failed: ' + e.message);
            }
        }
        
        function handleGameEvent(data) {
            addDebug('handleGameEvent: ' + data.type);
            
            if (data.type === 'gameState') {
                if (data.yourSeat) {
                    mySeat = data.yourSeat;
                    addDebug('My seat assigned: ' + mySeat);
                }
                updateGameUI(data.game);
            } else if (data.type === 'error') {
                addDebug('Game error: ' + data.message);
                showAlert('⚠️ ' + data.message);
            } else if (data.type === 'pong') {
                // Heartbeat response, ignore
            } else {
                addDebug('Unknown game event: ' + data.type);
            }
        }
        
        function updateGameUI(gameState) {
            if (!gameState) return;
            
            // Store for action calculations
            lastGameState = gameState;
            
            addDebug('Updating game UI, phase: ' + gameState.phase + ', my seat: ' + mySeat);
            
            // Handle showdown/finished - show winner
            if (gameState.phase === 'showdown' || gameState.phase === 'finished') {
                if (gameState.winnerSeat && gameState.winnerHand) {
                    var winnerPlayer = gameState.players.find(function(p) {
                        return p.seat === gameState.winnerSeat;
                    });
                    if (winnerPlayer) {
                        showMultiplayerWinner(winnerPlayer, gameState.winnerHand, gameState.pot);
                        playWinSound(); // Play victory sound
                    }
                }
            }
            
            // Update pot
            var potEl = document.getElementById('potAmount');
            if (potEl) {
                potEl.textContent = '$' + gameState.pot;
            }
            
            // Update phase indicator
            var phaseIndicator = document.getElementById('gamePhaseIndicator');
            if (phaseIndicator && gameState.phase) {
                var phaseDisplay = gameState.phase.toUpperCase().replace('_', '-');
                phaseIndicator.textContent = phaseDisplay;
            }
            
            // Also update header
            var headerPhase = document.getElementById('tableInfoBlinds');
            if (headerPhase && gameState.phase) {
                headerPhase.textContent = gameState.phase.toUpperCase().replace('_', '-');
            }
            
            // Update community cards - only add NEW cards to avoid re-animation
            var communityEl = document.getElementById('communityCards');
            if (communityEl && gameState.communityCards) {
                var currentCardCount = communityEl.children.length;
                var newCardCount = gameState.communityCards.length;
                
                // Only update if new cards were dealt
                if (newCardCount > currentCardCount) {
                    // Play card sound for each new community card with delays matching animation
                    for (var i = currentCardCount; i < newCardCount; i++) {
                        (function(cardIndex) {
                            setTimeout(function() {
                                playCommunityCardSound();
                            }, (cardIndex - currentCardCount) * 350); // 350ms to match CSS animation delay
                        })(i);
                        
                        var cardEl = document.createElement('div');
                        cardEl.innerHTML = createCardHTML(gameState.communityCards[i]);
                        communityEl.appendChild(cardEl.firstChild);
                    }
                } else if (newCardCount === 0 && currentCardCount > 0) {
                    // Clear cards for new hand
                    communityEl.innerHTML = '';
                }
            }
            
            // Find my player by seat
            var myPlayer = null;
            if (mySeat && gameState.players) {
                myPlayer = gameState.players.find(function(p) {
                    return p.seat === mySeat;
                });
                addDebug('My player: ' + (myPlayer ? myPlayer.name : 'not found') + ', cards: ' + (myPlayer && myPlayer.cards ? myPlayer.cards.length : 0));
            }
            
            // Update hero cards at bottom with highlighting
            var heroCardsEl = document.getElementById('heroCards');
            if (heroCardsEl && myPlayer && myPlayer.cards && myPlayer.cards.length >= 2) {
                var card1 = myPlayer.cards[0];
                var card2 = myPlayer.cards[1];
                
                var color1 = (card1.suit === 'hearts' || card1.suit === 'diamonds') ? 'red' : 'black';
                var color2 = (card2.suit === 'hearts' || card2.suit === 'diamonds') ? 'red' : 'black';
                
                // Check if we should highlight cards (PAIR or better)
                // Use LOCAL evaluation instead of waiting for server handName
                var highlight1 = '';
                var highlight2 = '';
                var handName = myPlayer.handName; // From server (only on showdown)
                
                // If no handName from server, calculate locally
                if (!handName && gameState.communityCards && gameState.communityCards.length >= 3) {
                    var convertedCards = convertCardsForEval(myPlayer.cards.concat(gameState.communityCards));
                    if (convertedCards.length >= 5) {
                        var localHand = evaluateHand(convertedCards);
                        if (localHand && localHand.name) {
                            handName = localHand.name;
                        }
                    }
                }
                
                if (handName && handName !== 'High Card' && handName !== 'Incomplete' && handName !== 'Not enough cards') {
                    // Highlight hero cards that are part of the winning combination
                    var highlightInfo = getHighlightCards(myPlayer.cards, gameState.communityCards, handName);
                    if (highlightInfo.heroCard1) highlight1 = ' golden-highlight';
                    if (highlightInfo.heroCard2) highlight2 = ' golden-highlight';
                }
                
                heroCardsEl.innerHTML = 
                    '<div class="hero-card ' + color1 + highlight1 + '">' +
                        '<span class="card-rank">' + formatRank(card1.rank) + '</span>' +
                        '<span class="card-suit">' + getSuitSymbol(card1.suit) + '</span>' +
                    '</div>' +
                    '<div class="hero-card ' + color2 + highlight2 + '">' +
                        '<span class="card-rank">' + formatRank(card2.rank) + '</span>' +
                        '<span class="card-suit">' + getSuitSymbol(card2.suit) + '</span>' +
                    '</div>';
                
                // Also highlight community cards
                if (handName && handName !== 'High Card' && handName !== 'Incomplete' && handName !== 'Not enough cards') {
                    highlightCommunityCards(myPlayer.cards, gameState.communityCards, handName);
                }
            }
            
            // Update action buttons based on whose turn it is (using seat)
            var isMyTurn = parseInt(gameState.currentPlayerSeat) === parseInt(mySeat);
            addDebug('Current seat: ' + gameState.currentPlayerSeat + ', my seat: ' + mySeat + ', my turn: ' + isMyTurn);
            
            var actionBtns = document.querySelectorAll('.action-btn');
            actionBtns.forEach(function(btn) {
                btn.disabled = !isMyTurn;
                btn.style.opacity = isMyTurn ? '1' : '0.5';
            });
            
            // Update Call/Check button text based on current bet
            var callBtn = document.getElementById('callBtn');
            if (callBtn && myPlayer) {
                var callAmount = (gameState.currentBet || 0) - (myPlayer.currentBet || 0);
                if (callAmount <= 0) {
                    callBtn.textContent = 'Check';
                } else {
                    callBtn.textContent = 'Call ' + formatChips(callAmount);
                }
            }
            
            // Update bet slider limits with minRaiseTo
            updateBetSliderLimits();
            
            // Update Bet/Raise button text based on current bet (Texas Hold'em rules)
            var raiseBtn = document.getElementById('raiseBtn');
            if (raiseBtn) {
                var currentBetValue = gameState.currentBet || 0;
                // BET when no one has bet yet, RAISE when there's an existing bet
                var actionName = currentBetValue > 0 ? 'Raise' : 'Bet';
                raiseBtn.textContent = actionName + ' ' + formatChips(currentBetAmount);
            }
            
            // Update players around table
            updatePlayersDisplay(gameState.players, mySeat);
            
            // Update hand HUD for multiplayer
            updateHandHUD();
        }
        
        function createCardHTML(card) {
            var isRed = (card.suit === 'hearts' || card.suit === 'diamonds');
            var colorClass = isRed ? 'red' : 'black';
            var suitSymbol = getSuitSymbol(card.suit);
            var rank = formatRank(card.rank);
            
            return '<div class="community-card ' + colorClass + '">' +
                '<span class="card-rank">' + rank + '</span>' +
                '<span class="card-suit">' + suitSymbol + '</span>' +
            '</div>';
        }
        
        function getSuitSymbol(suit) {
            var symbols = { hearts: '♥', diamonds: '♦', clubs: '♣', spades: '♠' };
            return symbols[suit] || suit;
        }
        
        function formatRank(rank) {
            // Convert numeric rank to display value
            var rankMap = { 14: 'A', 13: 'K', 12: 'Q', 11: 'J', 10: '10' };
            return rankMap[rank] || rank;
        }
        
        // Convert server-format cards to evaluateHand format
        function convertCardsForEval(cards) {
            if (!cards || !Array.isArray(cards)) return [];
            
            var rankMap = { 14: 'A', 13: 'K', 12: 'Q', 11: 'J', 10: '10' };
            var suitSymbols = { hearts: '♥', diamonds: '♦', clubs: '♣', spades: '♠' };
            
            return cards.map(function(card) {
                var rank = rankMap[card.rank] || card.rank;
                var suit = suitSymbols[card.suit] || card.suit;
                return { rank: rank, suit: suit };
            });
        }
        
        // Get which cards to highlight based on hand type
        function getHighlightCards(heroCards, communityCards, handName) {
            if (!heroCards || heroCards.length < 2) {
                return { heroCard1: false, heroCard2: false, communityIndices: [] };
            }
            
            var result = { heroCard1: false, heroCard2: false, communityIndices: [] };
            var card1Rank = parseInt(heroCards[0].rank) || heroCards[0].rank;
            var card2Rank = parseInt(heroCards[1].rank) || heroCards[1].rank;
            var card1Suit = heroCards[0].suit;
            var card2Suit = heroCards[1].suit;
            
            // Normalize rank for comparison
            function normalizeRank(r) {
                if (r === 'A') return 14;
                if (r === 'K') return 13;
                if (r === 'Q') return 12;
                if (r === 'J') return 11;
                return parseInt(r) || r;
            }
            
            card1Rank = normalizeRank(card1Rank);
            card2Rank = normalizeRank(card2Rank);
            
            // Count ranks in all cards
            var allCards = heroCards.concat(communityCards || []);
            var rankCounts = {};
            allCards.forEach(function(c) {
                var r = normalizeRank(c.rank);
                rankCounts[r] = (rankCounts[r] || 0) + 1;
            });
            
            // For Pair, Two Pair, Three of a Kind, Four of a Kind - highlight matching ranks
            if (handName === 'Pair' || handName === 'Two Pair' || handName === 'Three of a Kind' || handName === 'Four of a Kind' || handName === 'Full House') {
                // Find which ranks are paired+
                var pairedRanks = [];
                for (var r in rankCounts) {
                    if (rankCounts[r] >= 2) {
                        pairedRanks.push(parseInt(r));
                    }
                }
                
                // Check if hero cards are part of pairs
                if (pairedRanks.indexOf(card1Rank) !== -1) result.heroCard1 = true;
                if (pairedRanks.indexOf(card2Rank) !== -1) result.heroCard2 = true;
                
                // Find community cards with paired ranks
                if (communityCards) {
                    communityCards.forEach(function(c, idx) {
                        var r = normalizeRank(c.rank);
                        if (pairedRanks.indexOf(r) !== -1) {
                            result.communityIndices.push(idx);
                        }
                    });
                }
            }
            
            // For Flush - highlight all cards of same suit
            if (handName === 'Flush' || handName === 'Straight Flush' || handName === 'Royal Flush') {
                var suitCounts = {};
                allCards.forEach(function(c) {
                    suitCounts[c.suit] = (suitCounts[c.suit] || 0) + 1;
                });
                
                var flushSuit = null;
                for (var s in suitCounts) {
                    if (suitCounts[s] >= 5) flushSuit = s;
                }
                
                if (flushSuit) {
                    if (card1Suit === flushSuit) result.heroCard1 = true;
                    if (card2Suit === flushSuit) result.heroCard2 = true;
                    
                    if (communityCards) {
                        communityCards.forEach(function(c, idx) {
                            if (c.suit === flushSuit) {
                                result.communityIndices.push(idx);
                            }
                        });
                    }
                }
            }
            
            // For Straight - highlight all 5 cards in sequence
            if (handName === 'Straight' || handName === 'Straight Flush' || handName === 'Royal Flush') {
                // Simplified: highlight both hero cards for straights
                result.heroCard1 = true;
                result.heroCard2 = true;
                // Highlight all community cards for straight
                if (communityCards) {
                    communityCards.forEach(function(c, idx) {
                        result.communityIndices.push(idx);
                    });
                }
            }
            
            return result;
        }
        
        function highlightCommunityCards(heroCards, communityCards, handName) {
            if (!communityCards || communityCards.length === 0) return;
            
            var highlightInfo = getHighlightCards(heroCards, communityCards, handName);
            var communityEl = document.getElementById('communityCards');
            if (!communityEl) return;
            
            var cards = communityEl.querySelectorAll('.community-card');
            cards.forEach(function(cardEl, idx) {
                if (highlightInfo.communityIndices.indexOf(idx) !== -1) {
                    cardEl.classList.add('golden-highlight');
                } else {
                    cardEl.classList.remove('golden-highlight');
                }
            });
        }
        
        function updatePlayersDisplay(players, myCurrentSeatParam) {
            // Render all opponents around the table based on total player count
            var seatsEl = document.getElementById('playerSeats');
            if (!seatsEl || !players) return;
            
            // Use global mySeat if param is invalid
            var myCurrentSeat = parseInt(myCurrentSeatParam) || parseInt(mySeat) || 0;
            var totalPlayers = players.length;
            var isShowdown = lastGameState && (lastGameState.phase === 'showdown' || lastGameState.phase === 'finished');
            
            addDebug('updatePlayersDisplay: mySeat=' + myCurrentSeat + ', totalPlayers=' + totalPlayers);
            
            // Get opponents (everyone except me)
            var opponents = players.filter(function(p) {
                var pSeat = parseInt(p.seat);
                var isMe = pSeat === myCurrentSeat;
                addDebug('Player ' + p.name + ' seat=' + pSeat + ', isMe=' + isMe);
                return !isMe;
            });
            
            // Get position layout based on total players
            var positions = getPositionsForPlayerCount(totalPlayers, myCurrentSeat);
            
            var html = '';
            opponents.forEach(function(player, index) {
                var positionClass = positions[index] || 'position-top';
                var foldedClass = player.isFolded ? ' folded' : '';
                var isCurrentTurn = player.isCurrentTurn ? ' current-turn' : '';
                var betAmount = player.currentBet || 0;
                
                // Show cards at showdown (if not folded and cards are visible)
                var cardsHtml = '';
                if (isShowdown && !player.isFolded && player.cards && player.cards.length >= 2) {
                    // Show actual cards at showdown
                    var card1 = player.cards[0];
                    var card2 = player.cards[1];
                    var color1 = (card1.suit === 'hearts' || card1.suit === 'diamonds') ? 'red' : 'black';
                    var color2 = (card2.suit === 'hearts' || card2.suit === 'diamonds') ? 'red' : 'black';
                    
                    cardsHtml = '<div class="player-cards-shown">' +
                        '<div class="mini-card ' + color1 + '">' + formatRank(card1.rank) + getSuitSymbol(card1.suit) + '</div>' +
                        '<div class="mini-card ' + color2 + '">' + formatRank(card2.rank) + getSuitSymbol(card2.suit) + '</div>' +
                    '</div>';
                    
                    // Show hand name if available
                    if (player.handName) {
                        cardsHtml += '<div class="player-hand-name">' + player.handName + '</div>';
                    }
                } else {
                    // Show card backs
                    cardsHtml = '<div class="player-cards-back">' +
                        '<div class="card-back"></div>' +
                        '<div class="card-back"></div>' +
                    '</div>';
                }
                
                html += '<div class="table-player ' + positionClass + foldedClass + isCurrentTurn + '">' +
                    '<div class="player-avatar">' + (player.name ? player.name.charAt(0).toUpperCase() : '?') + '</div>' +
                    '<div class="player-info">' +
                        '<div class="player-name">' + (player.name || 'Player') + '</div>' +
                        '<div class="player-chips" onclick="toggleStackDisplay()">' + formatChips(player.chips || 0) + '</div>' +
                        (betAmount > 0 ? '<div class="player-bet">' + formatChips(betAmount) + '</div>' : '') +
                    '</div>' +
                    cardsHtml +
                '</div>';
            });
            
            seatsEl.innerHTML = html;
            addDebug('Rendered ' + opponents.length + ' opponents at positions: ' + positions.join(', ') + ', showdown: ' + isShowdown);
        }
        
        function getPositionsForPlayerCount(totalPlayers, mySeat) {
            // Position opponents based on total player count
            // Hero is always at bottom center
            
            if (totalPlayers === 2) {
                // Heads-up: opponent at top
                return ['position-top'];
            } else if (totalPlayers === 3) {
                // 3 players: one top, one side
                return ['position-top', 'position-left'];
            } else if (totalPlayers === 4) {
                // 4 players: top, left, right
                return ['position-top', 'position-left', 'position-right'];
            } else if (totalPlayers === 5) {
                // 5 players: top, top-left, left, right
                return ['position-top', 'position-top-left', 'position-left', 'position-right'];
            } else {
                // 6 players: top, top-left, top-right, left, right
                return ['position-top', 'position-top-left', 'position-top-right', 'position-left', 'position-right'];
            }
        }
        
        // Multiplayer winner display
        var multiplayerWinnerShown = false;
        
        function showMultiplayerWinner(winner, handName, potAmount, isMe) {
            if (multiplayerWinnerShown) return;
            multiplayerWinnerShown = true;
            
            // Check if winner is current player
            var iAmWinner = isMe || (mySeat && parseInt(winner.seat) === parseInt(mySeat));
            
            addDebug('WINNER: ' + winner.name + ' with ' + handName + ', isMe: ' + iAmWinner);
            
            // Record game result to history
            if (iAmWinner) {
                addGameToHistory('win', potAmount, handName, 'Multiplayer');
            } else {
                // Estimate loss as the current bet/buy-in
                var lossAmount = currentPrivateLobby ? currentPrivateLobby.buyIn : 100;
                addGameToHistory('loss', lossAmount, handName, 'Multiplayer');
            }
            
            // Remove any existing winner popup
            var existingPopup = document.getElementById('winnerOverlay');
            if (existingPopup) existingPopup.remove();
            
            // Create beautiful animated winner popup
            var overlay = document.createElement('div');
            overlay.id = 'winnerOverlay';
            overlay.className = iAmWinner ? 'winner-overlay winner-me' : 'winner-overlay winner-other';
            
            if (iAmWinner) {
                // Красочная анимация для победителя
                overlay.innerHTML = 
                    '<div class="winner-content winner-content-me">' +
                        '<div class="winner-confetti"></div>' +
                        '<div class="winner-glow"></div>' +
                        '<div class="winner-trophy">🏆</div>' +
                        '<div class="winner-title">YOU WIN!</div>' +
                        '<div class="winner-hand-name">' + handName + '</div>' +
                        '<div class="winner-amount">+$' + potAmount.toLocaleString() + '</div>' +
                        '<div class="winner-sparkles">✨✨✨</div>' +
                    '</div>';
            } else {
                // Скромная анимация для проигравшего
                overlay.innerHTML = 
                    '<div class="winner-content winner-content-other">' +
                        '<div class="winner-icon">🃏</div>' +
                        '<div class="winner-other-name">' + winner.name + ' wins</div>' +
                        '<div class="winner-hand-name-small">' + handName + '</div>' +
                        '<div class="winner-amount-small">+$' + potAmount.toLocaleString() + '</div>' +
                    '</div>';
            }
            
            document.body.appendChild(overlay);
            
            // Trigger animation
            setTimeout(function() {
                overlay.classList.add('visible');
            }, 50);
            
            // Hide after 3 seconds
            setTimeout(function() {
                overlay.classList.remove('visible');
                overlay.classList.add('hiding');
                
                setTimeout(function() {
                    multiplayerWinnerShown = false;
                    overlay.remove();
                    requestNewHand();
                }, 500);
            }, 3000);
        }
        
        function requestNewHand() {
            if (gameWebSocket && gameWebSocket.readyState === WebSocket.OPEN) {
                addDebug('Requesting new hand');
                gameWebSocket.send(JSON.stringify({ type: 'new_hand' }));
            }
        }
        
        // Game action functions for multiplayer
        function sendGameAction(action, amount) {
            if (!currentGameSession) {
                addDebug('No game session for action!');
                return;
            }
            
            addDebug('sendGameAction: ' + action + ', amount: ' + amount + ', WS state: ' + (gameWebSocket ? gameWebSocket.readyState : 'null'));
            
            if (gameWebSocket && gameWebSocket.readyState === WebSocket.OPEN) {
                var msg = {
                    type: 'action',
                    action: action,
                    amount: amount || 0
                };
                addDebug('WS sending: ' + JSON.stringify(msg));
                gameWebSocket.send(JSON.stringify(msg));
            } else {
                addDebug('WS not open, using HTTP fallback');
                // Fallback to HTTP
                fetch(API_BASE + '/api/game/' + currentGameSession + '/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        amount: amount || 0,
                        initData: tg ? tg.initData : ''
                    })
                }).then(function(resp) {
                    return resp.json();
                }).then(function(data) {
                    if (data.game) {
                        updateGameUI(data.game);
                    }
                }).catch(function(err) {
                    addDebug('Action error: ' + err.message);
                });
            }
        }
        
        // Override action button handlers for multiplayer
        function handleMultiplayerFold() {
            sendGameAction('fold', 0);
        }
        
        function handleMultiplayerCheck() {
            sendGameAction('check', 0);
        }
        
        function handleMultiplayerCall() {
            sendGameAction('call', 0);
        }
        
        function handleMultiplayerRaise(amount) {
            sendGameAction('raise', amount);
        }
        
        function handleMultiplayerAllIn() {
            sendGameAction('all_in', 0);
        }

        // ═══════════════════════════════════════════════════
        // URL PARAMETER HANDLING FOR LOBBY INVITE
        // ═══════════════════════════════════════════════════
        function checkUrlForLobby() {
            var lobbyCode = null;
            
            addDebug('Checking for lobby invite...');
            
            // Check Telegram WebApp startapp parameter first (highest priority)
            // This is set when user clicks direct Mini App link: t.me/bot/app?startapp=lobby_XXXXX
            if (tg && tg.initDataUnsafe) {
                addDebug('TG initDataUnsafe available, start_param: ' + (tg.initDataUnsafe.start_param || 'none'));
                
                if (tg.initDataUnsafe.start_param) {
                    var startParam = tg.initDataUnsafe.start_param;
                    
                    if (startParam.startsWith('lobby_')) {
                        lobbyCode = startParam.replace('lobby_', '');
                        addDebug('Found lobby code in start_param: ' + lobbyCode);
                    }
                }
            } else {
                addDebug('TG initDataUnsafe not available');
            }
            
            // Fallback: check URL parameter
            if (!lobbyCode) {
                var urlParams = new URLSearchParams(window.location.search);
                lobbyCode = urlParams.get('lobby');
                if (lobbyCode) {
                    addDebug('Found lobby code in URL: ' + lobbyCode);
                }
            }
            
            // Also check URL hash for startapp parameter (some Telegram versions use this)
            if (!lobbyCode && window.location.hash) {
                var hashParams = new URLSearchParams(window.location.hash.substring(1));
                var startappHash = hashParams.get('startapp') || hashParams.get('tgWebAppStartParam');
                if (startappHash && startappHash.startsWith('lobby_')) {
                    lobbyCode = startappHash.replace('lobby_', '');
                    addDebug('Found lobby code in hash: ' + lobbyCode);
                }
            }
            
            if (lobbyCode) {
                addDebug('Joining lobby: ' + lobbyCode);
                joinLobbyByCode(lobbyCode);
                return true;
            }
            
            return false;
        }

        async function joinLobbyByCode(code) {
            code = code.toUpperCase().trim();
            addDebug('Joining lobby by code: ' + code);
            
            try {
                // First get lobby info from server
                var lobbyResponse = await fetch(API_BASE + '/api/lobby/' + code);
                
                if (!lobbyResponse.ok) {
                    var errData = await lobbyResponse.json().catch(function() { return {}; });
                    throw new Error(errData.detail || 'Lobby not found');
                }
                
                var lobbyData = await lobbyResponse.json();
                addDebug('Found lobby: ' + JSON.stringify(lobbyData.lobby));
                
                // Join the lobby - send initData and fallback user info
                var joinBody2 = {
                    initData: tg ? tg.initData : ''
                };
                // Add fallback user info if available from Telegram WebApp
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    joinBody2.telegramId = tg.initDataUnsafe.user.id;
                    joinBody2.firstName = tg.initDataUnsafe.user.first_name;
                    joinBody2.username = tg.initDataUnsafe.user.username;
                }
                
                var joinResponse = await fetch(API_BASE + '/api/lobby/' + code + '/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(joinBody2)
                });
                
                if (!joinResponse.ok) {
                    var joinErr = await joinResponse.json().catch(function() { return {}; });
                    throw new Error(joinErr.detail || 'Failed to join lobby');
                }
                
                var joinData = await joinResponse.json();
                var serverLobby = joinData.lobby;
                
                addDebug('Joined lobby successfully');
                
                // Convert server players to our format
                // Server returns array of players, not object
                var players = [];
                if (serverLobby.players && Array.isArray(serverLobby.players)) {
                    serverLobby.players.forEach(function(p) {
                        var isPlayerHost = (p.telegramId === serverLobby.hostTelegramId);
                        players.push({
                            name: p.firstName || p.username || 'Player',
                            isHost: isPlayerHost
                        });
                    });
                }
                addDebug('Parsed players: ' + JSON.stringify(players));
                
                currentPrivateLobby = {
                    code: code,
                    buyIn: serverLobby.buyIn || serverLobby.buy_in || 100,
                    maxPlayers: serverLobby.maxPlayers || serverLobby.max_players || 2,
                    smallBlind: serverLobby.smallBlind || 10,
                    bigBlind: serverLobby.bigBlind || 20,
                    players: players,
                    serverData: serverLobby,
                    isHost: false  // Joining player is NOT the host
                };
                
                // Skip splash/main menu and go directly to waiting room
                document.getElementById('splashScreen').style.display = 'none';
                document.getElementById('fullscreenRequestScreen').classList.add('hidden');
                
                // Connect to WebSocket for real-time updates
                connectToLobbyWebSocket(code);
                
                // Show waiting room with smooth transition
                updateWaitingRoomUI();
                showScreen('waitingRoomScreen', ['mainMenu', 'lobbyScreen']);
                
            } catch (err) {
                addDebug('Join lobby error: ' + err.message);
                showAlert('⚠️ ' + err.message);
                
                // Show main menu if join failed
                document.getElementById('splashScreen').style.display = 'none';
                document.getElementById('mainMenu').classList.remove('hidden');
            }
        }

        // ═══════════════════════════════════════════════════
        // WEBSOCKET FOR REAL-TIME LOBBY UPDATES
        // ═══════════════════════════════════════════════════
        var lobbyWebSocket = null;
        
        function connectToLobbyWebSocket(lobbyCode) {
            if (lobbyWebSocket) {
                lobbyWebSocket.close();
            }
            
            var wsUrl = API_BASE.replace('https://', 'wss://').replace('http://', 'ws://') + '/ws/lobby/' + lobbyCode;
            addDebug('Connecting to WebSocket: ' + wsUrl);
            
            try {
                lobbyWebSocket = new WebSocket(wsUrl);
                
                lobbyWebSocket.onopen = function() {
                    addDebug('WebSocket connected');
                };
                
                lobbyWebSocket.onmessage = function(event) {
                    try {
                        var data = JSON.parse(event.data);
                        addDebug('WS message: ' + data.type);
                        handleLobbyEvent(data);
                    } catch (e) {
                        addDebug('WS parse error: ' + e.message);
                    }
                };
                
                lobbyWebSocket.onclose = function() {
                    addDebug('WebSocket closed');
                };
                
                lobbyWebSocket.onerror = function(err) {
                    addDebug('WebSocket error');
                };
            } catch (e) {
                addDebug('WebSocket connection failed: ' + e.message);
            }
        }
        
        function handleLobbyEvent(data) {
            if (!currentPrivateLobby) return;
            
            switch (data.type) {
                case 'playerJoined':
                    // Add new player
                    if (data.player) {
                        currentPrivateLobby.players.push({
                            name: data.player.first_name || data.player.username || 'Player',
                            isHost: data.player.is_host
                        });
                        updateWaitingRoomUI();
                        addDebug('Player joined: ' + (data.player.first_name || 'Player'));
                    }
                    break;
                    
                case 'playerLeft':
                    // Remove player (simplified - just refresh)
                    addDebug('Player left');
                    break;
                    
                case 'gameStarted':
                    addDebug('Game started by host! Session: ' + data.gameSessionId);
                    startMultiplayerGame(data.gameSessionId);
                    break;
                    
                case 'lobbyState':
                    // Full state update - sync ALL lobby data from server
                    if (data.lobby) {
                        var serverLobby = data.lobby;
                        
                        // Update lobby settings from server
                        currentPrivateLobby.buyIn = serverLobby.buyIn || serverLobby.buy_in || currentPrivateLobby.buyIn;
                        currentPrivateLobby.maxPlayers = serverLobby.maxPlayers || serverLobby.max_players || currentPrivateLobby.maxPlayers;
                        
                        // Parse players (could be array or object)
                        var players = [];
                        if (Array.isArray(serverLobby.players)) {
                            serverLobby.players.forEach(function(p) {
                                players.push({
                                    name: p.firstName || p.first_name || p.username || 'Player',
                                    isHost: p.telegramId === serverLobby.hostTelegramId
                                });
                            });
                        } else if (serverLobby.players) {
                            for (var pid in serverLobby.players) {
                                var p = serverLobby.players[pid];
                                players.push({
                                    name: p.firstName || p.first_name || p.username || 'Player',
                                    isHost: p.is_host
                                });
                            }
                        }
                        currentPrivateLobby.players = players;
                        addDebug('Lobby synced: buyIn=' + currentPrivateLobby.buyIn + ', max=' + currentPrivateLobby.maxPlayers);
                        updateWaitingRoomUI();
                    }
                    break;
            }
        }

        // Track if we're joining a lobby
        var joiningLobby = false;
        
        // Check for lobby code on page load
        window.addEventListener('load', function() {
            addDebug('Window loaded');
            setTimeout(function() {
                joiningLobby = checkUrlForLobby();
            }, 300);
        });

        // Fallback: Force show main menu after 5 seconds if nothing is visible
        function forceShowMainMenu() {
            // Don't force menu if we're joining a lobby
            if (joiningLobby) {
                addDebug('Skipping force menu - joining lobby');
                return;
            }
            
            var splash = document.getElementById('splashScreen');
            var menu = document.getElementById('mainMenu');
            var fullscreen = document.getElementById('fullscreenRequestScreen');
            var waiting = document.getElementById('waitingRoomScreen');
            var poker = document.getElementById('pokerTableScreen');
            
            // Check if any screen is visible
            var anyVisible = false;
            if (menu && !menu.classList.contains('hidden')) anyVisible = true;
            if (waiting && !waiting.classList.contains('hidden')) anyVisible = true;
            if (poker && !poker.classList.contains('hidden')) anyVisible = true;
            
            // Force show menu if nothing is visible
            if (!anyVisible) {
                addDebug('Fallback: forcing main menu');
                if (splash) splash.style.display = 'none';
                if (fullscreen) fullscreen.classList.add('hidden');
                if (menu) menu.classList.remove('hidden');
                try { updateUserUI(); } catch(e) {}
            }
        }
        
        // Quick fallback after 3 seconds
        setTimeout(forceShowMainMenu, 3000);
        
        // Backup fallback after 5 seconds
        setTimeout(forceShowMainMenu, 5000);

        // Load user settings and history on startup
        loadSettings();
        loadGameHistory();
        
        // Apply saved theme immediately
        applyTheme();

        addDebug('Ready');
    </script>
</body>
</html>
